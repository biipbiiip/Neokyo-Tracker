<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://sohvi.neocities.org/ordertracker.png" />
    <title>Neo_ Order Tracker</title>
    <style>
        /* cute cols #82aef8 #3b82f6 #ef4444 #2563eb */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-size: 12px !important
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #374151;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            margin-left: 66px;
        }

        .parcel-section-active {
            transition: margin-right 0.3s cubic-bezier(.4, 0, .2, 1);
            margin-right: 330px;
            /* Same as #parcelSection width */
        }

        #header {
            font-size: 16px !important;
            font-weight: 800;
            cursor: pointer;
            width: fit-content
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            margin-top: 24px
        }

        .header h1 {
            color: #4b5563;
            font-size: 28px;
            margin-bottom: 16px;
        }

        .import-section {
            margin-bottom: 20px;
        }

        .import-section textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .import-section textarea:focus {
            outline: none;
            border-color: rgb(106, 92, 201);
        }

        .btn {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .filters {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            color: rgb(106, 92, 201);
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: rgba(153, 145, 216, 1);
        }

        .view-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-toggle {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle.active {
            background: rgb(106, 92, 201);
            color: white;
        }

        .totals-row {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 22px;
            align-items: center;
        }

        .total-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
        }

        .total-label {
            font-size: 12px;
            color: rgb(118, 114, 152);
            margin-bottom: 4px;
        }

        .total-value {
            font-weight: 700;
            color: rgb(106, 92, 201);
        }

        /* Grid View */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .grid-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .grid-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .grid-item h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #374151;
        }

        .grid-item .order-id {
            color: rgba(153, 145, 216, 1);
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .grid-item .price {
            font-size: 18px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 8px;
        }

        .grid-item .details {
            display: flex;
            justify-content: space-between;
            color: rgb(106, 92, 201);
            margin: 6px 0;
        }

        .grid-item .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .tag {
            color: rgba(153, 145, 216, 1);
            background: rgba(167, 139, 250, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .grid-item .actions {
            display: flex;
            gap: 8px;
        }

        /* .btn-small {
    padding: 3px 6px !important;
    font-size: 10px !important;
    border-radius: 4px;
} */

        /* Table View */
        .table-view {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto
        }

        .table-view table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-view th {
            background: #f3f4f6;
            color: #374151;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-view th:hover {
            background: #e5e7eb;
        }

        .table-view th::after {
            content: '↕';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.4;
            font-size: 10px;
        }

        .table-view th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        .table-view th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .table-view td {
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .table-view tr:hover {
            background: rgba(167, 139, 250, 0.05);
        }

        .table-view img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .table-view tbody tr.batch-selectable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .table-view tbody tr.batch-selectable:hover {
            background: rgba(59, 130, 246, 0.1) !important;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .table-view tbody tr.batch-mode-active {
            background: rgba(59, 130, 246, 0.05) !important;
            border-left: 4px solid #3b82f6;
        }

        .table-view .batch-checkbox {
            pointer-events: none;
            /* Prevent checkbox from intercepting clicks */
            transform: scale(1.2);
        }

        /* Editable Cells in Table View */
        .editable-cell {
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 11px !important
        }

        .editable-cell:hover {
            background-color: rgba(167, 139, 250, 0.05);
        }

        .editable-cell.editing {
            padding: 0;
        }

        .editable-cell input,
        .editable-cell select,
        .editable-cell textarea {
            width: 100%;
            border: 2px solid #3b82f6;
            padding: 8px 12px;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }

        .editable-cell textarea {
            min-height: 40px;
            resize: vertical;
            font-family: inherit;
        }

        /* Parcel Section */
        .parcel-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            border: 1px solid #e5e7eb;
        }

        .parcel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .parcel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .parcel-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .parcel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
            margin-top: 12px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            align-content: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: rgb(106, 92, 201);
        }

        .stat-label {
            font-size: 12px;
            color: rgb(106, 92, 201);
        }

        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }

        .modal.hidden {
            opacity: 0;
            visibility: hidden;
            /* Removes from interaction but not DOM */
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
        }

        .column-controls {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            margin-left: 16px;
            display: none;
        }

        .column-controls.show {
            display: block;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            max-width: 600px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .column-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        .multi-select {
            position: relative;
            display: inline-block;
            min-width: 160px;
        }

        .multi-select-trigger {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
        }

        .multi-select-trigger:focus,
        .multi-select.open .multi-select-trigger {
            border-color: rgba(153, 145, 216, 1);
            outline: none;
        }

        .multi-select-trigger::after {
            content: '▼';
            font-size: 10px;
            color: rgb(106, 92, 201);
            transition: transform 0.2s;
        }

        .multi-select.open .multi-select-trigger::after {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid rgba(153, 145, 216, 1);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .multi-select.open .multi-select-dropdown {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background: #f3f4f6;
        }

        .multi-select-option input[type="checkbox"] {
            margin: 0;
        }

        .multi-select-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 20px;
        }

        .multi-select-tag {
            background: rgba(167, 139, 250, 0.1);
            color: rgba(153, 145, 216, 1);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .multi-select-tag .remove:hover {
            color: rgb(235, 137, 137);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: rgba(153, 145, 216, 1);
            background: rgb(244, 242, 254);
        }

        .multi-select-placeholder {
            color: #9ca3af;
            font-size: 14px;
        }

        .table-view th.hidden-column,
        .table-view td.hidden-column {
            display: none;
        }

        .grid-item select {
            margin: 0 -5px
        }
    </style>
</head>

<body>
    <div id="container" class="container parcel-section-active">
        <div
            style="margin-left: auto; display:grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px;align-items: start;">
            <h1 id="header" onclick="makeHeaderEditable()" title="Click to edit">Neo_ Order Tracker</h1>
            <select id="currencySelector" onchange="changeCurrency(this.value)"
                style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; background: white;">
                <option value="USD">US Dollar ($)</option>
                <option value="GBP">Pounds (£)</option>
                <option value="EUR">Euro (€)</option>
                <option value="MXN">Mex. Peso (MX$)</option>
                <option value="CAD">Canadian Dollar (C$)</option>
                <option value="HKD">HK Dollar (HK$)</option>
                <option value="TWD">Taiwan Dollar (NT$)</option>
                <option value="PHP">Philippine Pesos (₱)</option>
                <option value="AUD">Australian Dollar (A$)</option>
                <option value="KRW">Korean Won (₩)</option>
            </select>
        </div>
        <div class="header">
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-instructions" onclick="toggleInstructionsSection()">How to Use</button>
                <button class="btn" onclick="toggleImportSection()">Import HTML</button>
                <button class="btn btn-secondary" onclick="toggleChangelogSection()"
                    style="background:#7c829a;color:white">Changelog</button>
                <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import
                    Data</button>
                <button class="btn btn-secondary" onclick="clearAllData()"
                    style="background: rgb(235, 137, 137); border-color: rgb(235, 137, 137);color:white">Clear
                    Data</button>
            </div>
            <div class="neokyo-note" style="margin:10px; margin-top:20px; display:flex; align-items: center">
                <div><img src="https://sohvi.neocities.org/cookie.png" width="35px" /></div>
                <div style="margin-left:5px; padding:10px">🍪 All data is saved on your own browser and not a server.
                    Refreshing the page won't delete anything <u>unless</u> you clear browser cache/cookies/etc. If you
                    do, just remember to export your data and re-import after. <br />
                    <br />❗ Also, this is NOT an official Neokyo tool. It's not endorsed by Neokyo and I'm not
                    affiliated, but had permission to post. It's one I made to keep track of my own things i,, hope this
                    is ok idk it's usable if it's not lmk!! - 4th nini in discord (apothecariae)<br /><br />
                    Btw don't count on Space Used metric in parcels bc it can't play tetris u_u
                </div>
            </div>
            <div id="instructionsSection" class="import-section hidden">

                <h1 style="font-weight:600">Demo/Example</h1>
                <img src="https://sohvi.neocities.org/ordertracker.png" width="600px" /><br />
                <ol style="padding:25px 35px">
                    You can download <a href="https://sohvi.neocities.org/order_tracker_export_2025-07-22.json"
                        style="font-weight:800">my Neokyo data</a>, then import it (Import Data button above), and play
                    around with it.
                </ol>
                <h1 style="font-weight:600">Instructions</h1>
                <ol type="1" style="padding:25px 35px">
                    <li>Go to your <a href="https://neokyo.com/en/my-account/orders">Neokyo Orders</a></li>
                    <li>Right click in any empty space in your orders page, and click "Inspect" / "Inspect element"</li>
                    <li>Resize your browser until you can see all four columns!</li>
                    <li>Ctrl-F (or Cmd+F), and type in <b style="font-family:monospace; color:red">portlet light </b>
                    </li>
                    <li>It'll highlight the line in the code window above. Click on that line, then Ctrl+C (or Cmd+F) to
                        copy it.</li>
                    <li>Go back to this tab, click <b>Import HTML</b>, and paste the code into the window.</li>
                    <li>Press Import Orders.</li>
                    <li>If you have several pages of orders, just click on the next page in Neokyo.</li>
                    <li>Click into the code window <b style="font-family:monospace; color:red">where the letters look
                            like this</b>.</li>
                    <li>Then just repeat steps 4-7.</li>
                </ol>
                <button class="btn btn-secondary" onclick="toggleInstructionsSection()">Close</button>
            </div>
        </div>
        <script>function toggleChangelogSection() {
                const changelogSection = document.getElementById('changelogSection');
                changelogSection.classList.toggle('hidden');
            }</script>
        <div id="changelogSection" class="import-section hidden">
            <div style="padding:15px 25px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">

                <h3 style="color: rgb(106, 92, 201); margin-bottom: 10px;">Changes</h3>
                <ul style="padding-left: 20px; line-height: 1.6;">
                    <li><strong>Parcel presets</strong> based on community's shipment-examples in Discord</li>
                    <li><strong>Parcel calculator tabs</strong> - move planned parcels to shipped tab; enter in official
                        details + tracking URL etc. and access it from there</li>
                    <li><strong>Currencies</strong> - can now Import HTML if your currency is set to anything beside
                        USD; all currencies on Neokyo supported.<br />NOTE: If you had it in USD, this doesn't
                        autoconvert the prices!! You'll have to Import HTML for those pages (or for the nerds, you know
                        what to do w/ the exports ;-; key is still named 'usd')</li>
                    <li><strong>Sorting in grid view</strong> - can now sort ascending/descending in the card view</li>
                    <li><strong>Scroll horizontally in table view</strong> - overflow-x set!! amazing</li>
                    <li><strong>Fixed misaligned table view headers</strong> - headers didn't match the rows; were off
                        by one. Now they do!</li>
                    <li><strong>Removed auto-export on importing data</strong> - that was overkill, but it still remains
                        when you clear data</li>
                    <li><strong>Change the tracker name</strong> - click the header at very top to rename the tracker :3
                    </li>
                </ul>

                <h3 style="color: rgb(106, 92, 201); margin: 20px 0 10px 0;">Features/Notes</h3>
                <ul style="padding-left: 20px; line-height: 1.6;">
                    <li><strong>Works offline</strong> - data is all stored in your browser + can be exported/imported
                        any time!! just dont clear ur cache before u export </li>
                    <li><strong>Format management</strong> - create and edit item formats with real dimensions/weights
                        (I originally made this for manga so I kept it all in,, you can delete them!)</li>
                    <li><strong>Tag system</strong> - add custom tags to orders and filter by them; separate each tag by
                        spaces</li>
                    <li><strong>Multi-select filters</strong> - filter dropdowns are additive, so checking multiple will
                        show items tied to that filter condition</li>
                    <li><strong>Batch/bulk edit mode</strong> - select multiple orders and bulk assign formats, parcels,
                        and tags at a time</li>
                    <li><strong>Table editing</strong> - click cells in table view to edit inline; toggle columns on and
                        off via 2nd button on far bottom left corner that appears when you click Table View </li>
                    <li><strong>Activity log</strong> - logs HTML import changes and updates. Currencies other than Yen
                        are not static on the Orders page - they change daily - so if it's not a significant change (ex.
                        50 cents or less), the original imported value remains</li>
                    <li><strong>Note:</strong> Storage Days is useless,, I didn't add in a counter/log exact import date
                        so they are just... there...</li>
                    <li><strong>Things to bother w/ later (never):</strong> width of tags col in table view, maybe smth
                        to save/dl images to be polite and not hotlink as if ppl still mind in twenty twenty five, UI
                        and reorganizing style and script sections</li>
                </ul><br />
                <button class="btn btn-secondary" onclick="toggleChangelogSection()">Close</button>
            </div>


        </div>

        <!--- dont laugh devs i am heavily assisted by the bff we can always talk to at like 2:33AM w/ showerthoughts and receive affirmations from instead of yelling  :( -->

        <div id="parcelSection" style="
            position: fixed;
            top: 0;
            right: 0;
            width: 330px;
            height: 100vh;
            background: rgba(255,255,255,0.98);
            border-left: 1px solid #e5e7eb;
            box-shadow: -2px 0 16px rgba(0,0,0,0.07);
            z-index: 999;
            overflow-y: auto;
            padding: 24px 18px 24px 18px;
            transform: translateX(0);
                animation: fadeInRight 0.6s;
        ">
            <div class="parcel-header">
                <h2>Parcel Calculator</h2>
                <button class="btn" onclick="openParcelModal()">Add Parcel</button>
                <button class="btn btn-secondary" onclick="toggleParcelSection()">Close</button>
            </div>
            <div class="parcel-tabs">
                <div class="parcel-tab active" id="planning-tab" onclick="switchParcelTab('planning')">
                    <div class="tab-main">
                        📦 Planning
                        <span class="tab-count" id="planning-count">0</span>
                    </div>
                </div>
                <div class="parcel-tab" id="shipped-tab" onclick="switchParcelTab('shipped')">
                    <div class="tab-main">
                        🚚 Shipped
                        <span class="tab-count" id="shipped-count">0</span>
                    </div>
                </div>
            </div>
            <div class="parcel-stats-bar active" id="planning-stats-bar">
                <div class="stats-bar-items">
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="planning-shipping-cost">$0.00</div>
                        <div class="stats-bar-label">Total Shipping</div>
                    </div>
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="planning-value">$0.00</div>
                        <div class="stats-bar-label" data-label="Total USD">Total USD</div>
                    </div>
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="planning-per-item">$0.00</div>
                        <div class="stats-bar-label">Per Item</div>
                    </div>
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="planning-per-item-plus-ship">0%</div>
                        <div class="stats-bar-label">Per Item + Ship</div>
                    </div>
                </div>
            </div>
            <div class="parcel-stats-bar" id="shipped-stats-bar">
                <div class="stats-bar-items">
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="shipped-total">$0.00</div>
                        <div class="stats-bar-label">Total Shipping</div>
                    </div>
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="shipped-per-item-only">$0.00</div>
                        <div class="stats-bar-label">Per Item</div>
                    </div>
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="shipped-per-item">$0.00</div>
                        <div class="stats-bar-label">Per Item + Ship</div>
                    </div>
                    <div class="stats-bar-item">
                        <div class="stats-bar-value" id="shipped-days">0 days</div>
                        <div class="stats-bar-label">Avg Ship Time</div>
                    </div>
                </div>
            </div>
            <div id="parcelGrid" class="parcel-grid"></div>
        </div>

        <script>// Tab switching function
            function switchParcelTab(tab) {
                currentParcelTab = tab;

                // Update tab visual states
                document.querySelectorAll('.parcel-tab').forEach(t => t.classList.remove('active'));
                document.getElementById(tab + '-tab').classList.add('active');

                // Update stats bars
                document.querySelectorAll('.parcel-stats-bar').forEach(bar => bar.classList.remove('active'));
                document.getElementById(tab + '-stats-bar').classList.add('active');

                // Re-render parcels for current tab
                renderParcels();
                updateParcelTabStats();
            }

            // Update tab counts and stats
            function updateParcelTabStats() {
                const planningParcels = parcels.filter(p => p.status === 'planning');
                const shippedParcels = parcels.filter(p => p.status === 'shipped');

                // Update counts
                document.getElementById('planning-count').textContent = planningParcels.length;
                document.getElementById('shipped-count').textContent = shippedParcels.length;

                // Calculate planning stats
                updatePlanningStats(planningParcels);
                updateShippedStats(shippedParcels);
            }

            function updatePlanningStats(planningParcels) {
                let totalWeight = 0;
                let totalValue = 0;
                let totalItems = 0;
                let totalCapacity = 0;
                let totalMaxVolume = 0;
                let totalVolume = 0;
                let totalOrderVolumes = 0;
                let totalValueYen = 0;
                let totalValueUSD = 0;

                // Get all orders from localStorage for accurate calculations
                let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');

                planningParcels.forEach(parcel => {
                    const assignedOrders = allOrders.filter(order => order.parcel === parcel.id);
                    let parcelWeight = parcel.boxWeight;
                    let parcelValue = 0;

                    assignedOrders.forEach(order => {
                        const defaultFormatName = Object.keys(bookFormats)[0] || 'Default';
                        const defaultFormat = bookFormats[defaultFormatName] || {
                            width: 10.0, height: 10.0, thickness: 10.0, weight: 10
                        };

                        const format = bookFormats[order.bookFormat] || defaultFormat;
                        const volumes = order.volumes || 1;
                        const itemWeight = format.weight * volumes * order.quantity;
                        const itemVolume = format.width * format.height * (format.thickness * volumes) * order.quantity;

                        totalWeight += itemWeight;
                        totalVolume += itemVolume;
                        totalOrderVolumes += volumes * order.quantity;
                        totalValueYen += order.yen || 0;
                        totalValueUSD += order.usd || 0;
                    });

                    totalWeight += parcelWeight; // would be incorrect for planning if we're doing actual weight
                    totalValue += totalValueUSD;
                    totalItems += totalOrderVolumes; // mfw i started off counting these as volumes bc manga and then it just became items but im too lazy to change it now that i even have claude confused

                    // Calculate capacity
                    const availableVolume = (parcel.length - parcel.padding * 2) *
                        (parcel.width - parcel.padding * 2) *
                        (parcel.height - parcel.padding * 2);
                    totalMaxVolume += availableVolume;

                    let usedVolume = 0;
                    assignedOrders.forEach(order => {
                        const format = bookFormats[order.bookFormat] || bookFormats[Object.keys(bookFormats)[0]];
                        const volumes = order.volumes || 1;
                        usedVolume += format.width * format.height * (format.thickness * volumes) * order.quantity;
                    });
                    totalCapacity += usedVolume;
                });

                let totalEstimatedShipping = 0;
                planningParcels.forEach(parcel => {
                    // Use actual shipping cost if filled in
                    if (parcel.shippingCost && parcel.shippingCost > 0) {
                        totalEstimatedShipping += parcel.shippingCost;
                    } else {
                        totalEstimatedShipping += 0; // Default estimate per parcel
                    }
                });

                const perItem = totalItems > 0 ? (totalValue / totalItems) : 0;
                const perItemWithEstShip = totalItems > 0 ? ((totalValue + totalEstimatedShipping) / totalItems) : 0;
                const currConfig = getCurrentCurrencyConfig();
                const totalShip = totalEstimatedShipping;

                // Update planning stats bar
                document.getElementById('planning-shipping-cost').textContent = `${currConfig.symbol}${totalShip.toFixed(2)}`;
                document.getElementById('planning-per-item-plus-ship').textContent = `${currConfig.symbol}${perItemWithEstShip.toFixed(2)}`;
                document.getElementById('planning-value').textContent = `${currConfig.symbol}${totalValue.toFixed(2)}`;
                document.getElementById('planning-per-item').textContent = `${currConfig.symbol}${perItem.toFixed(2)}`;


            }

            function updateShippedStats(shippedParcels) {
                let totalShipping = 0;
                let totalWeight = 0;
                let totalItems = 0;
                let totalValue = 0;
                let totalShipDays = 0;
                let parcelsWithDates = 0;

                // Get all orders for value calculation
                let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');

                shippedParcels.forEach(parcel => {
                    totalShipping += parcel.shippingCost || 0;

                    if (parcel.actualWeight && parcel.actualWeight > 0) {
                        totalWeight += parcel.actualWeight;
                    } else {
                        // Fall back to calculated weight (existing logic)
                        totalWeight += parcel.boxWeight || 0;
                        // Add item weights if no actual weight
                        const assignedOrders = allOrders.filter(order => order.parcel === parcel.id);
                        assignedOrders.forEach(order => {
                            const defaultFormatName = Object.keys(bookFormats)[0] || 'Default';
                            const defaultFormat = bookFormats[defaultFormatName] || { weight: 190 };
                            const format = bookFormats[order.bookFormat] || defaultFormat;
                            const volumes = order.volumes || 1;
                            const itemWeight = format.weight * volumes * order.quantity;
                            totalWeight += itemWeight;
                        });
                    }

                    // Calculate shipping days if we have both dates
                    if (parcel.shipDate && parcel.arrivalDate) {
                        const shipDate = new Date(parcel.shipDate);
                        const arrivalDate = new Date(parcel.arrivalDate);
                        const daysDiff = Math.ceil((arrivalDate - shipDate) / (1000 * 60 * 60 * 24));
                        if (daysDiff > 0) {
                            totalShipDays += daysDiff;
                            parcelsWithDates++;
                        }
                    }

                    // Calculate items and value for this parcel
                    const assignedOrders = allOrders.filter(order => order.parcel === parcel.id);
                    assignedOrders.forEach(order => {
                        const volumes = order.volumes || 1;
                        totalItems += volumes * order.quantity;
                        totalValue += order.usd || 0;
                    });
                });

                const avgShipping = shippedParcels.length > 0 ? (totalShipping / shippedParcels.length) : 0;
                const avgWeight = shippedParcels.length > 0 ? (totalWeight / shippedParcels.length / 1000) : 0; // Convert to kg
                const perItemWithShip = totalItems > 0 ? ((totalValue + totalShipping) / totalItems) : 0;
                const avgShipDays = parcelsWithDates > 0 ? Math.round(totalShipDays / parcelsWithDates) : 0;
                const perItemOnly = totalItems > 0 ? (totalValue / totalItems) : 0;
                const currConfig = getCurrentCurrencyConfig();

                // Update shipped stats bar
                document.getElementById('shipped-total').textContent = `${currConfig.symbol}${totalShipping.toFixed(2)}`;
                document.getElementById('shipped-per-item').textContent = `${currConfig.symbol}${perItemWithShip.toFixed(2)}`;
                document.getElementById('shipped-days').textContent = `${avgShipDays} days`;
                document.getElementById('shipped-per-item-only').textContent = `${currConfig.symbol}${perItemOnly.toFixed(2)}`;


            }
            function closeEditParcelModal() {
                document.getElementById('editParcelModal').classList.add('hidden');
                currentEditingParcel = null;
            }

            function closeEditParcelModalOnOutsideClick(event) {
                if (event.target.classList.contains('modal')) {
                    closeEditParcelModal();
                }
            }

        </script>

        <!-- Hamburger Menus for Filters, Totals, and View Controls -->
        <style>
            .hamburger-menu {
                position: fixed;
                top: 0;
                left: 0;
                width: 65px;
                height: 100vh;
                background: rgba(255, 255, 255, 0.98);
                border-right: 1px solid #e5e7eb;
                box-shadow: 2px 0 16px rgba(0, 0, 0, 0.07);
                z-index: 1001;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 16px 0;
                gap: 8px;

            }

            .hamburger-btn {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 9px;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
                transition: background 0.2s;
                font-size: 22px;
            }

            .hamburger-btn.active {
                background: rgb(84 151 221);
                color: white;
            }

            .hamburger-btn:hover {
                /* background: rgba(84, 151, 221, 0.1); cute mint */
                background: #5181c2 !important
            }

            .floating-panel {
                position: fixed;
                bottom: 20px;
                left: 70px;
                z-index: 1002;
                min-width: 320px;
                max-width: 90vw;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 10px;
                box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
                padding: 18px 18px 12px 18px;
                display: none;
                animation: fadeIn 0.2s;
            }



            .floating-panel.show {
                display: block;
            }

            @media (max-width: 600px) {
                .floating-panel {
                    left: 60px;
                    min-width: 220px;
                }

                .hamburger-menu {
                    left: 8px;
                }
            }

            @keyframes fadeInRight {
                from {
                    opacity: 0;
                    transform: translateX(10px);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes fadeOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0px);
                }

                to {
                    opacity: 0;
                    transform: translateX(10);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <div class="hamburger-menu">
            <!-- === CORE UI CONTROLS === -->
            <button class="hamburger-btn active" id="filtersHamburger" aria-label="Filters"
                onclick="toggleFiltersSection()">
                <span>📊</span>
                <span class="tooltip">Toggle Filters</span>
            </button>
            <button class="hamburger-btn active" id="parcelCalcHamburger" aria-label="Parcel Calculator"
                onclick="toggleParcelSection()">
                <span>📦</span>
                <span class="tooltip">Parcel Calculator</span>
            </button>
            <button class="hamburger-btn" id="batchModeHamburger" aria-label="Toggle Batch Mode"
                onclick="toggleBatchMode()">
                <span>✨</span>
                <span class="tooltip">Toggle Batch Mode</span>
            </button>

            <div class="hamburger-divider">
                <div class="hamburger-divider-icon"></div>
            </div>

            <!-- === CONTENT MANAGEMENT === -->
            <button class="hamburger-btn" id="formatsHamburger"
                onclick="toggleFloatingPanel('formatsModal', this, true)">
                <span>📚</span>
                <span class="tooltip">Manage Formats</span>
            </button>
            <button class="hamburger-btn" id="tagsHamburger"
                onclick="toggleFloatingPanel('tagManagerModal', this, true)">
                <span>🏷️</span>
                <span class="tooltip">Manage Tags</span>
            </button>
            <button class="hamburger-btn" id="activityHamburger" onclick="showActivityLog()">
                <span>📘</span>
                <span class="tooltip">Import Changelog</span>
            </button>
            <div class="hamburger-divider">
                <div class="hamburger-divider-icon"></div>
            </div>
            <div class="yeehaw-expand-btns">
                <!-- === DATA MANAGEMENT === -->
                <button class="hamburger-btn" id="importHamburger" onclick="toggleImportSection()"
                    title="Import HTML Data">
                    <span>🔖</span>
                    <span class="tooltip">Import HTML</span>
                </button>
                <button class="hamburger-btn" id="importDataHamburger"
                    onclick="document.getElementById('importFile').click()" title="Import Data File">
                    <span>⬆️</span>
                    <span class="tooltip">Import Data</span>
                </button>
                <button class="hamburger-btn" id="exportHamburger" onclick="exportData()" title="Export Data">
                    <span>⬇️</span>
                    <span class="tooltip">Export Data</span>
                </button>
                <button class="hamburger-btn" id="clearDataHamburger" onclick="clearAllData()" title="Clear All Data">
                    <span>🧹</span>
                    <span class="tooltip">Clear Data</span>
                </button>

            </div>
            <!-- Spacer to push view buttons to bottom -->
            <div style="flex: 1;"></div>

            <!-- === VIEW CONTROLS === -->

            <button class="hamburger-btn" id="columnToggleHamburger" onclick="toggleFloatingPanel('columnPanel', this)"
                style="display: none;" title="Show/Hide Columns">
                <span>⚙️</span>
                <span class="tooltip">Columns</span>
            </button>
            <button class="hamburger-btn view-toggle-btn" id="viewToggleHamburger" onclick="toggleViewDirect()"
                title="Toggle Grid/Table View">
                <span id="viewToggleIcon">📋</span>
                <span class="tooltip" id="viewToggleTooltip">Table View</span>
            </button>
            <style>
                .hamburger-btn {
                    position: relative;
                }

                .hamburger-btn span {
                    font-size: 16px !important;
                }

                .view-toggle-btn {
                    background: #f3f4f6;
                    border: 1px solid #d1d5db;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                }

                .view-toggle-btn.active {
                    background: rgb(106, 92, 201);
                    color: white;
                }

                #clearDataHamburger:hover {
                    background: #eb8988 !important;
                    border-color: #eb8988 !important;
                    color: white;
                }

                #clearDataHamburger .tooltip {
                    background: #eb8988 !important;
                    border-color: #eb8988 !important;
                    color: white;
                }

                .hamburger-menu:hover .yeehaw-expand-btns {
                    display: flex;
                }

                .yeehaw-expand-btns {
                    flex-direction: column;
                    gap: 8px;
                    display: none
                }

                .hamburger-btn .tooltip {
                    display: none;
                    position: absolute;
                    left: 110%;
                    top: 50%;
                    transform: translateY(-50%);
                    background: #000000;
                    /* rgb(84 151 221); */
                    color: #fff;
                    padding: 8px 12px;
                    border-radius: 5px;
                    font-size: 12px !important;
                    white-space: nowrap;
                    z-index: 1003;
                    pointer-events: none;
                    font-family: "Manrope";
                    font-weight: 600
                }

                .hamburger-btn:hover .tooltip {
                    display: block;
                }

                .hamburger-divider {
                    width: 24px;
                    height: 1px;
                    background: #d1d5db;
                    margin: 12px 0;
                    display: flex;
                }
            </style>
        </div>

        <!-- Floating Panels -->
        <div id="filtersPanel" class="">
            <div id="headerSection" class="filter-header">
                <strong id="filtersTitle" style="font-weight: 800; min-width:80px">Filters / </strong>
                <div id="totalsRow" class="totals-row">
                    <div class="total-item">
                        <div class="total-label">Total Orders</div>
                        <div class="total-value" id="totalItems">0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total Items</div>
                        <div class="total-value" id="totalVolumes">0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total Yen</div>
                        <div class="total-value" id="totalYen">¥0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" id="totalCurrencyLabel" data-label="Total USD">Total USD</div>
                        <div class="total-value" id="totalUSD">$0</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total Weight</div>
                        <div class="total-value" id="totalWeight">0g</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label" data-label="USD per Item">USD per Item</div>
                        <div class="total-value" id="avgUSDPerItem">$0.00</div>
                    </div>
                </div>
            </div>
            <div id="filtersSection" class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Search Items</label>
                        <input type="text" id="searchInput" placeholder="Search by order ID or title..."
                            oninput="applyFilters()">
                    </div>

                    <div class="filter-group">
                        <label>Tags</label>
                        <div class="multi-select" id="tagsMultiSelect">
                            <div class="multi-select-trigger" onclick="toggleMultiSelect('tags')" tabindex="0">
                                <div class="multi-select-tags" id="tagsTags">
                                    <div class="multi-select-placeholder">All Tags</div>
                                </div>
                            </div>
                            <div class="multi-select-dropdown" id="tagsDropdown">
                                <!-- Tags options will be dynamically generated -->
                            </div>
                        </div>
                    </div>


                    <div class="filter-group">
                        <label>Min Price (¥)</label>
                        <input type="number" id="minPrice" oninput="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Max Price (¥)</label>
                        <input type="number" id="maxPrice" oninput="applyFilters()">
                    </div>

                    <div class="filter-group">
                        <label>Format</label>
                        <div class="multi-select" id="formatsMultiSelect">
                            <div class="multi-select-trigger" onclick="toggleMultiSelect('formats')" tabindex="0">
                                <div class="multi-select-tags" id="formatsTags">
                                    <div class="multi-select-placeholder">All Formats</div>
                                </div>
                            </div>
                            <div class="multi-select-dropdown" id="formatDropdown">
                                <!-- Format options will be dynamically generated -->
                            </div>
                        </div>
                    </div>


                    <div class="filter-group">
                        <label>Status</label>
                        <div class="multi-select" id="statusesMultiSelect">
                            <div class="multi-select-trigger" onclick="toggleMultiSelect('statuses')" tabindex="0">
                                <div class="multi-select-tags" id="statusesTags">
                                    <div class="multi-select-placeholder">All Statuses</div>
                                </div>
                            </div>
                            <div class="multi-select-dropdown" id="statusDropdown">
                                <!-- Status options will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Parcel</label>
                        <div class="multi-select" id="parcelsMultiSelect">
                            <div class="multi-select-trigger" onclick="toggleMultiSelect('parcels')" tabindex="0">
                                <div class="multi-select-tags" id="parcelsTags">
                                    <div class="multi-select-placeholder">All Parcels</div>
                                </div>
                            </div>
                            <div class="multi-select-dropdown" id="parcelDropdown">
                                <!-- Parcel options will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="clearFilters()" style="scale:.9">Clear Filters</button>
                </div>
            </div>
        </div>

        <div id="totalsPanel" class="floating-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>Totals</strong>
                <button class="btn btn-small btn-secondary" onclick="closeAllPanels()">×</button>
            </div>
        </div>


        <div id="batchPanel" class="floating-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>Batch Assign (<span id="selectedCount">0</span> selected)</strong>
                <button class="btn btn-small btn-secondary" onclick="closeAllPanels()">×</button>
            </div>

            <div style="margin-top: 15px;">
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Assign Format</label>
                        <select id="batchFormat" style="width: 100%;">
                            <option value="">Keep existing formats</option>
                            <!-- Format options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Assign Parcel</label>
                        <select id="batchParcel" style="width: 100%;">
                            <option value="">Keep existing parcels</option>
                            <!-- Parcel options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Add Tags (space-separated)</label>
                        <input type="text" id="batchTags" placeholder="tag1 tag2 tag3" style="width: 100%;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Set Volumes/Items</label>
                        <input type="number" id="batchVolumes" min="0" placeholder="Keep existing" style="width: 100%;">
                    </div>
                </div>

                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 15px;">
                    <button class="btn btn-small" onclick="applyBatchChanges()">Apply Changes</button>
                    <button class="btn btn-small btn-secondary" onclick="clearBatchSelection()">Clear Selection</button>
                </div>
            </div>
        </div><!-- Add this import section as a right sidebar (similar to parcel calculator) -->
        <div id="importSection" style="
    position: fixed;
    top: 0;
    right: 0;
    width: 400px;
    height: 100vh;
    background: rgba(255,255,255,0.98);
    border-left: 1px solid #e5e7eb;
    z-index: 999;
    overflow-y: auto;
    padding: 24px 18px;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(.4,0,.2,1);
    display: none;
">
            <div class="import-header" style="margin-bottom: 18px;">
                <h2>Import HTML Data</h2>
                <button class="btn" onclick="toggleImportSection()">Close</button>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>Instructions</h3>
                <ol style="padding-left: 20px; font-size: 12px; line-height: 1.4;">
                    <li>Go to your <a href="https://neokyo.com/en/my-account/orders" target="_blank">Neokyo Orders</a>
                    </li>
                    <li>Right click → "Inspect" / "Inspect element"</li>
                    <li>Resize browser to see all columns</li>
                    <li>Ctrl+F (Cmd+F) and search: <code
                            style="background: #f3f4f6; padding: 2px 4px;">portlet light</code></li>
                    <li>Click the highlighted line, then Ctrl+C (Cmd+C) to copy</li>
                    <li>Paste the code below and click Import</li>
                    <li>If you have several pages of orders, just click on the next page in Neokyo.</li>
                    <li>Click into the code window <b style="font-family:monospace; color:red">where the letters look
                            like this</b>.</li>
                    <li>Then just repeat steps 4-7.</li>
                </ol>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">HTML Code:</label>
                <textarea id="htmlInput" placeholder="Paste the HTML code here..." style="
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            resize: vertical;
        "></textarea>
            </div>

            <div style="display: flex; gap: 8px;">
                <button class="btn" onclick="parseHTML()">Import Orders</button>
                <button class="btn btn-secondary" onclick="clearHTMLInput()">Clear</button>
            </div>

            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <h3>Tips</h3>
                <ul style="padding-left: 20px; font-size: 11px; color: #6b7280;">
                    <li>Orders are automatically deduplicated</li>
                    <li>Existing orders will be updated with new info</li>
                </ul>
            </div>
        </div>

        <script>
            function toggleFloatingPanel(panelId, btn, isModal = false) {
                const panel = document.getElementById(panelId);

                // Special handling for activityModal - create it if it doesn't exist
                if (panelId === 'activityModal' && !panel) {
                    closeAllPanels(); // Close everything else first
                    createActivityModal();
                    const newPanel = document.getElementById('activityModal');
                    newPanel.classList.remove('hidden');
                    btn.classList.add('active');
                    populateActivityLog();
                    return;
                }

                // Special handling for activityModal - if it exists, treat it normally
                if (panelId === 'activityModal' && panel) {
                    const isOpen = !panel.classList.contains('hidden');
                    closeAllPanels(); // This will remove the modal and deactivate the button
                    if (!isOpen) {
                        // Modal was just destroyed by closeAllPanels, so recreate it
                        createActivityModal();
                        const newPanel = document.getElementById('activityModal');
                        newPanel.classList.remove('hidden');
                        btn.classList.add('active');
                        populateActivityLog();
                    }
                    return;
                }

                // Special handling for formatsModal - render content if it exists
                if (panelId === 'formatsModal' && panel) {
                    const isOpen = !panel.classList.contains('hidden');
                    closeAllPanels();
                    if (!isOpen) {
                        panel.classList.remove('hidden', 'show');
                        btn.classList.add('active');
                        renderFormatsTable();
                    }
                    return;
                }

                // Special handling for tagManagerModal - render content if it exists
                if (panelId === 'tagManagerModal' && panel) {
                    const isOpen = !panel.classList.contains('hidden');
                    closeAllPanels();
                    if (!isOpen) {
                        panel.classList.remove('hidden', 'show');
                        btn.classList.add('active');
                        renderTagManagerContent();
                    }
                    return;
                }
                if (panelId === 'columnPanel') {
                    if (!document.getElementById('columnPanel')) {
                        createColumnPanel();
                    }
                    const panel = document.getElementById('columnPanel');
                    const isOpen = panel.classList.contains('show');

                    closeAllPanels();
                    if (!isOpen) {
                        panel.classList.add('show');
                        btn.classList.add('active');
                    }
                    return;
                }

                if (!panel) {
                    console.error('Panel not found:', panelId);
                    return;
                }

                // Check if it's currently open
                const isOpen = isModal ? !panel.classList.contains('hidden') : panel.classList.contains('show');

                // Close all panels AND modals first
                closeAllPanels();

                if (!isOpen) {
                    if (isModal) {
                        // Show modal - remove hidden class
                        panel.classList.remove('hidden', 'show');
                        btn.classList.add('active');

                        // Only parcel modal needs form reset (since formats and tags are handled above)
                        if (panelId === 'parcelModal') {
                            document.getElementById('parcelName').value = '';
                            document.getElementById('parcelLength').value = '60';
                            document.getElementById('parcelWidth').value = '45';
                            document.getElementById('parcelHeight').value = '62';
                            document.getElementById('parcelPadding').value = '20';
                            document.getElementById('parcelBoxWeight').value = '2000';
                        }
                    } else {
                        // Show floating panel
                        panel.classList.remove('hidden', 'show');
                        panel.classList.add('show');
                        btn.classList.add('active');
                    }
                }
            }

            // 3. Update closeAllPanels to destroy the activity modal:
            function closeAllPanels() {
                // Close floating panels
                document.querySelectorAll('.floating-panel').forEach(panel => {
                    panel.classList.remove('show');
                });

                // Close modals
                const modals = ['formatsModal', 'tagManagerModal', 'parcelModal', 'editParcelModal', 'activityModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.remove('show');
                        modal.classList.add('hidden');
                    }
                });

                // Destroy activity modal
                const activityModal = document.getElementById('activityModal');
                if (activityModal) {
                    activityModal.remove();
                }

                // Close import section if open
                const importSection = document.getElementById('importSection');
                const importHamburger = document.getElementById('importHamburger');
                const pageContainer = document.getElementById('container');
                if (importSection && importSection.style.transform === 'translateX(0px)') {
                    importSection.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        importSection.style.display = 'none';
                    }, 300);
                    pageContainer.classList.remove('import-section-active');
                    importHamburger.classList.remove('active');
                }

                // Remove active state from modal/panel buttons (not persistent ones)
                const persistentButtons = ['filtersHamburger', 'parcelCalcHamburger', 'batchModeHamburger', 'importHamburger'];
                document.querySelectorAll('.hamburger-btn').forEach(btn => {
                    if (!persistentButtons.includes(btn.id)) {
                        btn.classList.remove('active');
                    }
                });
            }

            // New helper function
            function closeAllModals() {
                const modals = ['formatsModal', 'tagManagerModal', 'parcelModal', 'editParcelModal', 'activityModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        // ONLY add hidden, remove show if it exists
                        modal.classList.add('hidden');
                        modal.classList.remove('show'); // Remove this class if it got added by mistake
                    }
                });
            }

            // TAG FILTERS!!!11 multiselect filter logic
            function updateMultiSelectFilter(type) {
                const checkbox = event.target;
                const value = checkbox.value;

                if (type === 'Statuses') {
                    if (selectedStatuses.includes(value)) {
                        selectedStatuses = selectedStatuses.filter(v => v !== value);
                        checkbox.checked = false;
                    } else {
                        selectedStatuses.push(value);
                        checkbox.checked = true;
                    }
                    renderStatusTags();
                } else if (type === 'Formats') {
                    if (selectedFormats.includes(value)) {
                        selectedFormats = selectedFormats.filter(v => v !== value);
                        checkbox.checked = false;
                    } else {
                        selectedFormats.push(value);
                        checkbox.checked = true;
                    }
                    renderFormatTags();
                } else if (type === 'Parcels') {
                    if (selectedParcels.includes(value)) {
                        selectedParcels = selectedParcels.filter(v => v !== value);
                        checkbox.checked = false;
                    } else {
                        selectedParcels.push(value);
                        checkbox.checked = true;
                    }
                    renderParcelTags();
                } else if (type === 'Tags') {
                    if (selectedTags.includes(value)) {
                        selectedTags = selectedTags.filter(v => v !== value);
                        checkbox.checked = false;
                    } else {
                        selectedTags.push(value);
                        checkbox.checked = true;
                    }
                    renderTagsTags();
                }

                applyFilters();
            }

            function renderMultiSelectTags(type, removeFunction) {
                let selected;

                if (type === 'Statuses') selected = selectedStatuses;
                else if (type === 'Formats') selected = selectedFormats;
                else if (type === 'Parcels') selected = selectedParcels;
                else if (type === 'Tags') selected = selectedTags;

                const containerId = `${type.toLowerCase()}Tags`;
                const container = document.getElementById(containerId);

                if (selected.length === 0) {
                    container.innerHTML = `<div class="multi-select-placeholder">All ${type}</div>`;
                } else {
                    container.innerHTML = selected.map(item => `
            <div class="multi-select-tag">
                    <div class="tag-remove-invisible" onclick="${removeFunction}('${item}')"; event.stopPropagation();">
                        &times;</div>
                ${type === 'Parcels' ? getParcelsName(item) : item}
                <span class="remove" onclick="${removeFunction}('${item}')">&times;</span>
            </div>
        `).join('');
                }
            }

            function getParcelsName(parcelId) {
                if (parcelId === 'No Parcel') {
                    return '(none)';
                }

                const parcel = parcels.find(p => p.id === parcelId);
                return parcel ? parcel.name : 'Unknown';
            }

            // TAG FILTERS - RENDER TAGS
            function renderStatusTags() {
                renderMultiSelectTags('Statuses', 'removeStatusTags');
            }
            function renderFormatTags() {
                renderMultiSelectTags('Formats', 'removeFormatTags');
            }
            function renderTagsTags() {
                renderMultiSelectTags('Tags', 'removeTagsTags');
            }
            function renderParcelTags() {
                renderMultiSelectTags('Parcels', 'removeParcelTags');
            }

            // TAG FILTERS - REMOVE TAGS
            function removeStatusTags(status) {
                selectedStatuses = selectedStatuses.filter(s => s !== status);
                const safeId = status.toLowerCase().replace(/[^a-z0-9]/g, '-');
                const checkbox = document.getElementById(`status-${safeId}`);
                if (checkbox) checkbox.checked = false;
                renderStatusTags();
                applyFilters();
            }

            function removeFormatTags(tag) {
                selectedFormats = selectedFormats.filter(t => t !== tag);
                const safeId = tag.replace(/[^a-z0-9]/gi, '-');
                const checkbox = document.getElementById(`tag-${safeId}`);
                if (checkbox) checkbox.checked = false;
                renderFormatTags();
                applyFilters();
            }

            function removeTagsTags(tag) {
                selectedTags = selectedTags.filter(t => t !== tag);
                if (tag === 'Untagged') {
                    const checkbox = document.getElementById('tag-untagged');
                    if (checkbox) checkbox.checked = false;
                } else {
                    const safeId = tag.replace(/[^a-z0-9]/gi, '-');
                    const checkbox = document.getElementById(`tag-${safeId}`);
                    if (checkbox) checkbox.checked = false;
                }
                renderTagsTags();
                applyFilters();
            }

            function removeParcelTags(parcelId) {
                selectedParcels = selectedParcels.filter(id => id !== parcelId);
                if (parcelId === '__NO_PARCEL__') {
                    const checkbox = document.getElementById('parcel-no-parcel');
                    if (checkbox) checkbox.checked = false;
                } else {
                    const checkbox = document.getElementById(`parcel-${parcelId}`);
                    if (checkbox) checkbox.checked = false;
                }
                renderParcelTags();
                applyFilters();
            }

            // TAG FILTERS - RENDER TAG DROPDOWNS
            function renderStatusDropdown() {
                const dropdown = document.getElementById('statusDropdown');
                const uniqueStatuses = getUniqueStatuses();

                dropdown.innerHTML = uniqueStatuses.map(status => {
                    const safeId = status.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    return `
            <div class="multi-select-option">
                <input type="checkbox" id="status-${safeId}" value="${status}" onchange="updateMultiSelectFilter('Statuses')">
                <label for="status-${safeId}">${status}</label>
            </div>
        `;
                }).join('');
            }

            function renderFormatDropdown() {
                const dropdown = document.getElementById('formatDropdown');
                dropdown.innerHTML = Object.keys(bookFormats).map(format => `
        <div class="multi-select-option">
            <input type="checkbox" id="format-${format.toLowerCase()}" value="${format}" onchange="updateMultiSelectFilter('Formats')">
            <label for="format-${format.toLowerCase()}">${format}</label>
        </div>
    `).join('');
            }

            function renderParcelDropdown() {
                const dropdown = document.getElementById('parcelDropdown');
                dropdown.innerHTML = `
        <div class="multi-select-option">
            <input type="checkbox" id="parcel-no-parcel" value="__NO_PARCEL__" onchange="updateMultiSelectFilter('Parcels')">
            <label for="parcel-no-parcel">No Parcel</label>
        </div>
        ${parcels.map(parcel => `
            <div class="multi-select-option">
                <input type="checkbox" id="parcel-${parcel.id}" value="${parcel.id}" onchange="updateMultiSelectFilter('Parcels')">
                <label for="parcel-${parcel.id}">${parcel.name}</label>
            </div>
        `).join('')}
    `;
            }

            function renderTagsDropdown() {
                const dropdown = document.getElementById('tagsDropdown');
                const uniqueTags = getUniqueTags();

                if (uniqueTags.length === 0) {
                    dropdown.innerHTML = `
            <div class="multi-select-option">
                <input type="checkbox" id="tag-untagged" value="Untagged" onchange="updateMultiSelectFilter('Tags')">
                <label for="tag-untagged">Untagged</label>
            </div>
            <div style="padding: 8px; color: #9ca3af;">No other tags found</div>
        `;
                    return;
                }

                dropdown.innerHTML = `
        <div class="multi-select-option">
            <input type="checkbox" id="tag-untagged" value="Untagged" onchange="updateMultiSelectFilter('Tags')">
            <label for="tag-untagged">Untagged</label>
        </div>
        ${uniqueTags.map(tag => `
            <div class="multi-select-option">
                <input type="checkbox" id="tag-${tag.replace(/[^a-z0-9]/gi, '-')}" value="${tag}" onchange="updateMultiSelectFilter('Tags')">
                <label for="tag-${tag.replace(/[^a-z0-9]/gi, '-')}">${tag}</label>
            </div>
        `).join('')}
    `;
            }

        </script>
        <script>
            let batchMode = false;
            let selectedOrders = new Set();

            function toggleBatchMode() {
                batchMode = !batchMode;
                const batchModeHamburger = document.getElementById('batchModeHamburger');
                // const batchControlsHamburger = document.getElementById('batchControlsHamburger');

                if (batchMode) {
                    batchModeHamburger.classList.add('active');
                    // batchControlsHamburger.style.display = 'flex'; // Show the controls button
                    document.body.classList.add('batch-mode');
                    renderView(); // Re-render to show checkboxes
                    showBatchControls();
                } else {
                    closeBatchMode();
                }
            }

            function closeBatchMode() {
                batchMode = false;
                selectedOrders.clear();
                const batchModeHamburger = document.getElementById('batchModeHamburger');
                // const batchControlsHamburger = document.getElementById('batchControlsHamburger');

                batchModeHamburger.classList.remove('active');
                // batchControlsHamburger.classList.remove('active');
                // batchControlsHamburger.style.display = 'none'; // Hide the controls button
                document.body.classList.remove('batch-mode');
                hideBatchControls();
                closeAllPanels(); // Close the batch panel if open
                renderView(); // Re-render to hide checkboxes
                updateSelectedCount();
            }

            function showBatchControls() {
                let controls = document.getElementById('batchControls');
                if (!controls) {
                    controls = document.createElement('div');
                    controls.id = 'batchControls';
                    controls.className = 'batch-controls';
                    controls.innerHTML = `
            <span id="batchControlsCount">0 orders selected</span>
            <button class="btn btn-small" onclick="selectAllVisible()">Select All Visible</button>
            <button class="btn btn-small btn-secondary" onclick="clearBatchSelection()">Clear Selection</button>
            <button class="btn btn-small" onclick="toggleFloatingPanel('batchPanel', document.getElementById('batchControlsHamburger'))">Open Controls</button>
        `;
                    document.body.appendChild(controls);
                }
                controls.classList.add('show');
            }

            function hideBatchControls() {
                const controls = document.getElementById('batchControls');
                if (controls) {
                    controls.classList.remove('show');
                }
            }

            function populateBatchOptions() {
                // Populate format options
                const formatSelect = document.getElementById('batchFormat');
                if (formatSelect) {
                    formatSelect.innerHTML = '<option value="">Keep existing formats</option>' +
                        Object.keys(bookFormats).map(format =>
                            `<option value="${format}">${format}</option>`
                        ).join('');
                }

                // Populate parcel options
                const parcelSelect = document.getElementById('batchParcel');
                if (parcelSelect) {
                    parcelSelect.innerHTML = '<option value="">Keep existing parcels</option>' +
                        parcels.map(parcel =>
                            `<option value="${parcel.id}">${parcel.name}</option>`
                        ).join('');
                }
            }

            function toggleOrderSelection(orderId, checkbox) {
                if (checkbox.checked) {
                    selectedOrders.add(orderId);
                } else {
                    selectedOrders.delete(orderId);
                }
                updateSelectedCount();
                updateOrderHighlight(orderId);
            }

            function updateSelectedCount() {
                const count = selectedOrders.size;
                const selectedCountEl = document.getElementById('selectedCount');
                if (selectedCountEl) {
                    selectedCountEl.textContent = count;
                }
                const controlsCount = document.getElementById('batchControlsCount');
                if (controlsCount) {
                    controlsCount.textContent = `${count} orders selected`;
                }
            }

            function updateOrderHighlight(orderId) {
                const isSelected = selectedOrders.has(String(orderId));

                if (currentView === 'grid') {
                    const gridItems = document.querySelectorAll('.grid-item');
                    gridItems.forEach(item => {
                        if (item.innerHTML.includes(`updateOrder('${orderId}'`)) {
                            if (isSelected) {
                                item.classList.add('batch-mode-active');
                            } else {
                                item.classList.remove('batch-mode-active');
                            }
                        }
                    });
                } else {
                    const tableRows = document.querySelectorAll('.table-view tbody tr');
                    tableRows.forEach(row => {
                        if (row.innerHTML.includes(`updateOrder('${orderId}'`)) {
                            if (isSelected) {
                                row.classList.add('batch-mode-active');
                            } else {
                                row.classList.remove('batch-mode-active');
                            }
                        }
                    });
                }
            }

            function selectAllVisible() {
                // Clear existing selections first
                selectedOrders.clear();

                // Add all visible orders
                orders.forEach(order => {
                    selectedOrders.add(String(order.id)); // Ensure consistent string type
                    const checkbox = document.getElementById(`batch-${order.id}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    updateOrderHighlight(order.id);
                });
                updateSelectedCount();
            }

            function clearBatchSelection() {
                selectedOrders.clear();
                document.querySelectorAll('.batch-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.querySelectorAll('.batch-mode-active').forEach(item => {
                    item.classList.remove('batch-mode-active');
                });
                updateSelectedCount();
            }

            function applyBatchChanges() {

                if (selectedOrders.size === 0) {
                    alert('Please select at least one order first.');
                    return;
                }

                const format = document.getElementById('batchFormat').value;
                const parcel = document.getElementById('batchParcel').value;
                const tags = document.getElementById('batchTags').value.trim();
                const volumes = document.getElementById('batchVolumes').value;

                if (!format && !parcel && !tags && !volumes) {
                    alert('Please specify at least one change to apply.');
                    return;
                }

                // console.log('Selected orders:', Array.from(selectedOrders));
                // console.log('Changes to apply:', { format, parcel, tags, volumes });

                // Load ALL orders from localStorage
                let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                // console.log('Total orders in localStorage:', allOrders.length);

                let changesApplied = 0;

                // Try multiple comparison methods to find matches
                allOrders.forEach((order, index) => {
                    const orderId = order.id;
                    const orderIdStr = String(orderId);

                    // Check if this order is selected using multiple methods
                    const isSelected = selectedOrders.has(orderId) ||
                        selectedOrders.has(orderIdStr) ||
                        selectedOrders.has(String(orderId)) ||
                        Array.from(selectedOrders).includes(String(orderId));

                    if (isSelected) {
                        // console.log(`FOUND MATCH: Order #${order.orderId} (id: ${orderId})`);

                        if (format && order.bookFormat !== format) {
                            order.bookFormat = format;
                            changesApplied++;
                            // console.log(`  - Format changed to: ${format}`);
                        }

                        if (parcel && order.parcel !== parcel) {
                            order.parcel = parcel;
                            changesApplied++;
                            // console.log(`  - Parcel changed to: ${parcel}`);
                        }

                        if (tags) {
                            const existingTags = order.tags ? order.tags.split(' ').filter(t => t.trim()) : [];
                            const newTags = tags.split(' ').filter(t => t.trim());
                            const allTags = [...new Set([...existingTags, ...newTags])];
                            order.tags = allTags.join(' ');
                            changesApplied++;
                            // console.log(`  - Tags updated to: ${order.tags}`);
                        }

                        if (volumes) {
                            order.volumes = parseInt(volumes);
                            changesApplied++;
                            // console.log(`  - Volumes changed to: ${volumes}`);
                        }
                    }
                });

                // console.log(`Total changes applied: ${changesApplied}`);

                if (changesApplied > 0) {
                    // Save changes
                    localStorage.setItem('orders', JSON.stringify(allOrders));

                    // Reload and refresh
                    orders = JSON.parse(localStorage.getItem('orders') || '[]');
                    applyFilters();
                    renderView();
                    renderParcels();
                    updateParcelTabStats();
                    updateTotals();
                    renderTagsDropdown();

                    alert(`Success! Applied ${changesApplied} changes to ${selectedOrders.size} selected orders.`);
                } else {
                    alert('No changes were applied. Could not find matching orders.');
                }

                // Clear form and selection
                document.getElementById('batchFormat').value = '';
                document.getElementById('batchParcel').value = '';
                document.getElementById('batchTags').value = '';
                document.getElementById('batchVolumes').value = '';
                clearBatchSelection();
            }

            // Populate batch options when the panel is opened
            document.addEventListener('DOMContentLoaded', function () {
                // Add event listener to populate options when batch panel is opened
                const originalTogglePanel = window.toggleFloatingPanel;
                window.toggleFloatingPanel = function (panelId, btn) {
                    if (panelId === 'batchPanel') {
                        populateBatchOptions();
                    }
                    return originalTogglePanel(panelId, btn);
                };
            });
        </script>

        <div id="gridSortControls"
            style="display: none; margin-bottom: 16px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <span style="font-weight: 600; color: #374151;">Sort by:</span>
            <button class="btn btn-secondary sort-btn" onclick="sortGridBy('orderId')" id="sort-orderId">
                Order # <span class="sort-indicator"></span>
            </button>
            <button class="btn btn-secondary sort-btn" onclick="sortGridBy('title')" id="sort-title">
                Title <span class="sort-indicator"></span>
            </button>
            <button class="btn btn-secondary sort-btn" onclick="sortGridBy('yen')" id="sort-yen">
                Price <span class="sort-indicator"></span>
            </button>
            <button class="btn btn-secondary sort-btn" onclick="sortGridBy('storageDays')" id="sort-storageDays">
                Storage Days <span class="sort-indicator"></span>
            </button>
            <button class="btn btn-secondary sort-btn" onclick="sortGridBy('created')" id="sort-created">
                Date Created <span class="sort-indicator"></span>
            </button>
            <button class="btn btn-secondary sort-btn" onclick="clearGridSort()">
                Clear Sort
            </button>
        </div>
        <script>// for grid view sort
            let gridSortState = { field: null, direction: 'asc' };

            function sortGridBy(field) {
                // Toggle direction if same field, otherwise start with ascending
                if (gridSortState.field === field) {
                    gridSortState.direction = gridSortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    gridSortState.field = field;
                    gridSortState.direction = 'asc';
                }

                // Sort the orders
                orders.sort((a, b) => {
                    let aVal = a[field];
                    let bVal = b[field];

                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';

                    // Special handling for different field types
                    if (field === 'orderId') {
                        // Convert to numbers for proper numeric sorting
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    } else if (field === 'yen' || field === 'storageDays') {
                        // Numeric fields
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else if (field === 'created') {
                        // Date field - convert MM/DD/YYYY to comparable format
                        aVal = convertDateForSorting(aVal);
                        bVal = convertDateForSorting(bVal);
                    } else {
                        // String fields (title, etc.)
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }

                    // Compare values
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return gridSortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        if (gridSortState.direction === 'asc') {
                            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        } else {
                            return bVal < aVal ? -1 : bVal > aVal ? 1 : 0;
                        }
                    }
                });

                updateSortIndicators();
                renderView();
            }

            function convertDateForSorting(dateStr) {
                if (!dateStr || typeof dateStr !== 'string') return new Date(0);
                // Convert MM/DD/YYYY to YYYY-MM-DD for proper sorting
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[0] - 1, parts[1]);
                }
                return new Date(dateStr);
            }

            function clearGridSort() {
                gridSortState = { field: null, direction: 'asc' };

                // Reload original order from localStorage
                try {
                    const originalOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                    // Reapply current filters
                    applyFilters();
                } catch (e) {
                    console.error('Error reloading orders:', e);
                }

                updateSortIndicators();
                renderView();
            }

            function updateSortIndicators() {
                // Clear all indicators
                document.querySelectorAll('.sort-indicator').forEach(indicator => {
                    indicator.textContent = '';
                    indicator.parentElement.classList.remove('sort-active');
                });

                // Set active indicator
                if (gridSortState.field) {
                    const activeBtn = document.getElementById(`sort-${gridSortState.field}`);
                    if (activeBtn) {
                        const indicator = activeBtn.querySelector('.sort-indicator');
                        indicator.textContent = gridSortState.direction === 'asc' ? '↑' : '↓';
                        activeBtn.classList.add('sort-active');
                    }
                }
            }

            // used in applyFilters()
            function applySortToOrders() {
                if (!gridSortState.field) return; // No sort applied

                orders.sort((a, b) => {
                    let aVal = a[gridSortState.field];
                    let bVal = b[gridSortState.field];

                    // Handle null/undefined values
                    if (aVal == null) aVal = '';
                    if (bVal == null) bVal = '';

                    // Same sorting logic from sortGridBy...
                    if (gridSortState.field === 'orderId') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    } else if (gridSortState.field === 'yen' || gridSortState.field === 'storageDays') {
                        aVal = Number(aVal) || 0;
                        bVal = Number(bVal) || 0;
                    } else if (gridSortState.field === 'created') {
                        aVal = convertDateForSorting(aVal);
                        bVal = convertDateForSorting(bVal);
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                    }

                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return gridSortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        if (gridSortState.direction === 'asc') {
                            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        } else {
                            return bVal < aVal ? -1 : bVal > aVal ? 1 : 0;
                        }
                    }
                });
            }
        </script>
        <style>
            /* for grid view sort */
            .sort-btn {
                font-size: 11px !important;
                padding: 6px 12px !important;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .sort-btn.sort-active {
                background: rgb(143 134 205) !important;
                color: white !important;
                border-color: rgb(143 134 205) !important
            }

            .sort-indicator {
                font-size: 10px !important;
                font-weight: bold;
            }

            #gridSortControls {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 8px;
                padding: 12px 16px;
                border: 1px solid #e5e7eb;
            }
        </style>
        <div id="gridView" class="grid-view"></div>
        <div id="tableView" class="table-view hidden"></div>
    </div>

    </div>

    <!-- Formats Modal -->
    <div id="formatsModal" class="modal hidden" onclick="if(event.target === this) closeAllPanels()">
        <div class="modal-content" onclick="event.stopPropagation()"
            style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Manage Formats</h3>
                <button class="btn btn-secondary" onclick="closeAllPanels()">×</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="addNewFormat()">Add New Format</button>
                <button class="btn btn-secondary" onclick="resetToDefaults()">Delete All Formats</button>
            </div>

            <div id="formatsTable" class="table-view"
                style="margin-bottom: 20px; max-height: 250px; overflow-y: scroll;">
                <!-- Formats table will be inserted here -->
            </div>

            <div style="text-align: right;">
                <button class="btn" onclick="saveFormats()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Tag Manager Modal -->
    <div id="tagManagerModal" class="modal hidden" onclick="if(event.target === this) closeAllPanels()">
        <div class="modal-content" onclick="event.stopPropagation()"
            style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Manage Tags</h3>
                <button class="btn btn-secondary" onclick="closeAllPanels()">×</button>
            </div>

            <div id="tagManagerContent">
                <!-- Tag content will be inserted here -->
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAllPanels()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Parcel Modal -->
    <!-- Enhanced Edit Parcel Modal -->
    <div id="editParcelModal" class="modal hidden" onclick="closeEditParcelModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <h3>Edit Parcel</h3>

            <!-- Basic Info Section -->
            <div class="form-section">
                <h4>Basic Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="editParcelName" placeholder="Parcel 1">
                    </div>
                    <div class="form-group">
                        <label>Padding/Safe Zone (cm)</label>
                        <input type="number" id="editParcelPadding" step="1" value="5">
                    </div>
                    <div class="form-group">
                        <label>Package Materials/Box Weight (g)</label>
                        <input type="number" id="editParcelBoxWeight" value="2000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Length (cm)</label>
                        <input type="number" id="editParcelLength" step="1" value="60">
                    </div>
                    <div class="form-group">
                        <label>Width (cm)</label>
                        <input type="number" id="editParcelWidth" step="1" value="45">
                    </div>
                    <div class="form-group">
                        <label>Height (cm)</label>
                        <input type="number" id="editParcelHeight" step="1" value="62">
                    </div>
                </div>
            </div>

            <!-- Shipping Info Section -->
            <div class="form-section" id="editShippingSection">
                <h4>Shipping Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Shipping Method</label>
                        <select id="editParcelShippingMethod">
                            <option value="">Select shipping method...</option>
                            <option value="Japan Post EMS">Japan Post EMS</option>
                            <option value="Japan Post Airmail">Japan Post Airmail</option>
                            <option value="Japan Post Small Packet">Japan Post Small Packet</option>
                            <option value="Japan Post SAL">Japan Post Surface</option>
                            <option value="FedEx Intl Priority">FedEx Intl Priority</option>
                            <option value="FedEx Intl Econoomy">FedEx Intl Econoomy</option>
                            <option value="FedEx Intl Connect Plus">FedEx Intl Connect Plus</option>
                            <option value="UPS Express Saver">UPS Express Saver</option>
                            <option value="DHL Express">DHL Express</option>
                            <option value="DHL EXPRESS 1200">DHL EXPRESS 12:00</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-label="USD">Shipping Cost (USD)</label>
                        <input type="number" id="editParcelShippingCost" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ship Date</label>
                        <input type="date" id="editParcelShipDate">
                    </div>
                    <div class="form-group">
                        <label>Arrival Date</label>
                        <input type="date" id="editParcelArrivalDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Actual Weight (g)</label>
                        <input type="number" id="editParcelActualWeight" placeholder="Leave empty if unknown">
                    </div>
                    <div class="form-group">
                        <label>Declared Value (Yen)</label>
                        <input type="number" id="parcelDeclaredValue" step="0.01" placeholder="Pro forma invoice value">
                    </div>
                    <div class="form-group">
                        <label>Tracking Number</label>
                        <input type="text" id="editParcelTrackingNumber" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Tracking URL</label>
                        <input type="url" id="editParcelTrackingURL" placeholder="https://tracking.example.com/...">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <button class="btn" onclick="saveParcelEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditParcelModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Parcel Modal -->
    <div id="parcelModal" class="modal hidden" onclick="closeModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <h3 id="parcelModalTitle">Add New Parcel</h3>

            <div class="form-section" id="presetSection">
                <h4>Quick Presets</h4>
                <div class="neokyo-note">NOTE: These are based on common box sizes from the Neokyo community/Discord.
                    There may be more, and you can always edit the dimensions yourself at any time. Please always assume
                    that your items may not be fitted into the box you expect, this calculator is just to help you
                    plan/gauge!</div><br />
                <div class="preset-grid">
                    <!-- js renderparcelpresets -->
                </div>
            </div>

            <!-- Basic Info Section -->
            <div class="form-section">
                <h4>Basic Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="parcelName" placeholder="Parcel 1">
                    </div>
                    <div class="form-group">
                        <label>Length (cm)</label>
                        <input type="number" id="parcelLength" step="1" value="25">
                    </div>
                    <div class="form-group">
                        <label>Width (cm)</label>
                        <input type="number" id="parcelWidth" step="1" value="19">
                    </div>
                    <div class="form-group">
                        <label>Height (cm)</label>
                        <input type="number" id="parcelHeight" step="1" value="34">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Padding/Safe Zone (cm)</label>
                        <input type="number" id="parcelPadding" step="1" value="2">
                    </div>
                    <div class="form-group">
                        <label>Package Materials/Box Weight (g)</label>
                        <input type="number" id="parcelBoxWeight" value="800">
                    </div>
                </div>
            </div>

            <!-- Shipping Info Section (shown when on shipped tab) -->
            <div class="form-section" id="shippingSection" style="display: none;">
                <h4>Shipping Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Shipping Method</label>
                        <select id="parcelShippingMethod">
                            <option value="">Select shipping method...</option>
                            <option value="Japan Post EMS">Japan Post EMS</option>
                            <option value="Japan Post Airmail">Japan Post Airmail</option>
                            <option value="Japan Post Small Packet">Japan Post Small Packet</option>
                            <option value="Japan Post SAL">Japan Post Surface</option>
                            <option value="FedEx Intl Priority">FedEx Intl Priority</option>
                            <option value="FedEx Intl Econoomy">FedEx Intl Econoomy</option>
                            <option value="FedEx Intl Connect Plus">FedEx Intl Connect Plus</option>
                            <option value="UPS Express Saver">UPS Express Saver</option>
                            <option value="DHL Express">DHL Express</option>
                            <option value="DHL EXPRESS 1200">DHL EXPRESS 12:00</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-label="USD">Shipping Cost (USD)</label>
                        <input type="number" id="parcelShippingCost" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ship Date</label>
                        <input type="date" id="parcelShipDate">
                    </div>
                    <div class="form-group">
                        <label>Arrival Date</label>
                        <input type="date" id="parcelArrivalDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Actual Weight (g)</label>
                        <input type="number" id="parcelActualWeight" placeholder="Leave empty if unknown">
                    </div>
                    <div class="form-group">
                        <label>Declared Value (Yen)</label>
                        <input type="number" id="editParcelDeclaredValue" step="0.01"
                            placeholder="Pro forma invoice value">
                    </div>
                    <div class="form-group">
                        <label>Tracking Number</label>
                        <input type="text" id="parcelTrackingNumber" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Tracking URL</label>
                        <input type="url" id="parcelTrackingURL" placeholder="https://tracking.example.com/...">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <button class="btn" onclick="saveParcel()">Save Parcel</button>
                <button class="btn btn-secondary" onclick="closeParcelModal()">Cancel</button>
            </div>
        </div>
    </div>
    <style>
        /* parcel preset cards */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            /* Smaller minimum */
            gap: 8px;
            /* Smaller gap */
            margin-bottom: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .preset-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            width: 100%;
            /* Ensure full width */
        }

        .preset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .preset-descriptor {
            font-size: 11px;
            color: rgb(106, 92, 201);
            font-family: monospace;
            background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .preset-name {
            font-weight: 700;
            color: #374151;
            font-size: 15px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section h4 {
            margin: 0 0 12px 0;
            color: #374151;
            font-size: 14px;
            font-weight: 600;
        }

        #presetSection * {
            font-size: 10px !important
        }
    </style>
    <script>
        // add parcel presets + fns
        // Preset definitions with packaging weights
        const parcelPresets = {
            'photocard-ultra': {
                name: '8×19×21cm',
                descriptor: 'Small',
                dimensions: { length: 8, width: 19, height: 21, padding: 1 },
                boxWeight: 300,
                examples: [
                    // EXACT: 8/19/21
                    '70 photocards + 2 keychains = 342g',
                    '19 TCG cards = 200g',
                    '42 photocards + notebook + 2 plushies = 435g',
                    'Single CD + 6 photocards = 271g',
                    'New 3DS = 384g',
                    'Digital camera + charger = 315g',
                    'Single t-shirt = 379g',
                    // CLOSE: 7/18/21
                    'New 3DS LL = 658g'
                ],
                tags: ['Photocards', 'Trading cards', 'Small badges', 'Keychains', 'Small electronics']
            },
            'community-mvp': {
                name: '25×19×34cm',
                descriptor: 'Medium',
                dimensions: { length: 25, width: 19, height: 34, padding: 2 },
                boxWeight: 800,
                examples: [
                    // EXACT: 25/19/34
                    '1/7 figure + light novel + VN game = 1,128g',
                    '7 artbooks + socks + plush = 4,342g',
                    '3 manga + 1/8 figure + 2 PSP games = 1,725g',
                    'PSP + camera + 14 UMD games = 2,292g',
                    '62 photocards + photobook + hoodie = 1,970g',
                    '30 photocards + album + washi tape + plushies = 1,723g',
                    '4 pokemon cards + lunch bag + magazines + CDs = 2,360g',
                    '2 small figures + keychains + books = 2,966g'
                ],
                tags: ['1-8 manga', 'Scale figures', 'CDs & games', 'Small clothing', 'Electronics', 'Mixed orders']
            },
            'magazine-heavy': {
                name: '25×12×35cm',
                descriptor: 'Medium/Heavy',
                dimensions: { length: 25, width: 12, height: 35, padding: 2 },
                boxWeight: 600,
                examples: [
                    // EXACT: 25/12/34-35
                    '11 magazines = 6,018g',
                    '10 magazines = 5,109g',
                    '8 CD albums + artbook + cards = 1,843g',
                    '11 doujinshi + 4 plushies = 1,383g',
                    '2 belts + shirt + 2 dresses = 1,644g',
                    '4 albums + 26 photocards + keychains = 1,810g',
                    '6 CDs + manga + standee + cards = 1,294g',
                    'Acrylic standee + towel + sailor suit = 1,047g'
                ],
                tags: ['Magazines', 'Artbooks', 'Manga sets', 'Flat items', 'Books']
            },
            'mixed-merch': {
                name: '27×24×38cm',
                descriptor: 'Medium/Mixed',
                dimensions: { length: 27, width: 24, height: 38, padding: 2 },
                boxWeight: 1000,
                examples: [
                    // EXACT: 27/24/38
                    '6 prize figures = 1,878g',
                    '1/8 figure + 3 prize figures + PSP game = 1,713g',
                    '4 CDs + magazines + plush + hoodie = 2,490g',
                    '1/6 figure + postcards + keychains = 2,006g',
                    '~775 sticker sheets + washi tape + figures = 7,900g',
                    'Cosplay set + figures + badges + CDs = 3,457g',
                    '4 blouses + dress + pouches + figures = 2,390g',
                    '2 plushies + makeup + pouches + photocards = 1,839g',
                    'Ichiban kuji + Nendoroid + small figures = 1,961g'
                ],
                tags: ['Plushies', 'Prize figures', 'Accessories', 'Mixed collections']
            },
            'big-box': {
                name: '30×33×47cm',
                descriptor: 'Large',
                dimensions: { length: 30, width: 33, height: 47, padding: 2 },
                boxWeight: 1200,
                examples: [
                    // EXACT: 30/33/47
                    '16 small + 2 medium + 1 large figure = 3,500g',
                    '1/7 + 1/8 figure + dakimakura = 2,950g',
                    '1/7 figure + acrylic stands + cards = 1,890g',
                    '6 used collectible figures + book = 2,650g',
                    'Shorts + t-shirt + figure + Kirby warmer = 2,385g',
                    // CLOSE: 33/30/47
                    '6 plushies + pajamas + CDs + camera = 5,161g',
                    '7 prize figures + 2 with boxes + notes = 3,100g',
                    'Scale + banpresto + trading figures = 1,850g'
                ],
                tags: ['Scale figures', 'Clothing bundles', 'Large collectibles', 'Mixed large orders']
            },
            'going-big': {
                name: '41×31×54cm',
                descriptor: 'Large/Bulk Orders',
                dimensions: { length: 41, width: 31, height: 54, padding: 2 },
                boxWeight: 1800,
                examples: [
                    // EXACT: 41/31/54
                    '20+ kpop albums + bags + vinyl = 11,724g',
                    'Yarn + clothing + plushies + figures = 8,100g',
                    '1/7 + 1/5 + 8 prize figures + plushies = 5,900g',
                    '34 CDs + electronics + clothes = 13,800g',
                    '2x 35mm camera bodies + 16 lenses = 9,850g',
                    'Kyun Charas + premium figure + mugs + shirts = 7,850g',
                    'Tapestry + keychains + artbooks + dress = 6,650g',
                    // CLOSE: 40/31/54 
                    'Cardigan + skirt + shorts + shirts + keychains = 9,000g'
                ],
                tags: ['Large collections', 'Heavy items', 'Special shapes']
            }
        };

        // Function to render presets in the modal
        function renderParcelPresets() {
            const presetGrid = document.querySelector('.preset-grid');
            if (!presetGrid) return;

            presetGrid.innerHTML = Object.entries(parcelPresets).map(([key, preset]) => `
        <div class="preset-card" onclick="selectParcelPreset('${key}')" style="
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
        ">
            <div style="font-weight: 700; color: #374151; font-size: 13px; margin-bottom: 8px; pointer-events:none">
                <div class="preset-header">
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-descriptor">${preset.descriptor}</div>
                </div>
            </div>
            <div style="font-size: 11px; color: #059669; background: #ecfdf5; padding: 6px 8px; border-radius: 4px; margin-bottom: 8px; overflow-y: auto; pointer-events:none">
                ${preset.examples.slice(0, 10).map(ex => `• ${ex}`).join('<br>')}
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 4px; pointer-events:none">
                ${preset.tags.slice(0, 10).map(tag => `
                    <span style="background: rgba(167, 139, 250, 0.1); color: rgba(153,145,216,1); padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                        ${tag}
                    </span>
                `).join('')}
            </div>
        </div>
    `).join('');
        }

        // Function to apply selected preset
        function selectParcelPreset(presetKey) {
            const preset = parcelPresets[presetKey];
            if (!preset) return;

            // Remove selection from all preset cards
            document.querySelectorAll('.preset-card').forEach(card => {
                card.style.borderColor = '#e5e7eb';
                card.style.background = '#f9fafb';
            });

            // Highlight selected card
            event.target.style.borderColor = 'rgb(106, 92, 201)';
            event.target.style.background = '#f0f9ff';

            // Generate default parcel name (Parcel 1, Parcel 2, etc.)
            const defaultName = generateDefaultParcelName();

            // Fill in the form fields
            document.getElementById('parcelName').value = defaultName;
            document.getElementById('parcelLength').value = preset.dimensions.length;
            document.getElementById('parcelWidth').value = preset.dimensions.width;
            document.getElementById('parcelHeight').value = preset.dimensions.height;
            document.getElementById('parcelPadding').value = preset.dimensions.padding;
            document.getElementById('parcelBoxWeight').value = preset.boxWeight;
        }

        function generateDefaultParcelName() {
            let counter = 1;
            let name = `Parcel ${counter}`;

            // Check if name already exists
            while (parcels.some(parcel => parcel.name === name)) {
                counter++;
                name = `Parcel ${counter}`;
            }

            return name;
        }


        // Update the openParcelModal function to include presets
        function openParcelModal() {
            const modal = document.getElementById('parcelModal');
            const shippingSection = document.getElementById('shippingSection');
            const modalTitle = document.getElementById('parcelModalTitle');

            // Reset form
            document.getElementById('parcelName').value = '';
            document.getElementById('parcelLength').value = '25';  // Default to most popular
            document.getElementById('parcelWidth').value = '19';
            document.getElementById('parcelHeight').value = '34';
            document.getElementById('parcelPadding').value = '2';
            document.getElementById('parcelBoxWeight').value = '800';

            // Reset shipping fields
            document.getElementById('parcelShippingMethod').value = '';
            document.getElementById('parcelShippingCost').value = '';
            document.getElementById('parcelShipDate').value = '';
            document.getElementById('parcelArrivalDate').value = '';
            document.getElementById('parcelActualWeight').value = '';
            document.getElementById('parcelTrackingNumber').value = '';

            // Show/hide shipping section based on current tab
            if (currentParcelTab === 'shipped') {
                shippingSection.style.display = 'block';
                modalTitle.textContent = 'Add Shipped Parcel';
            } else {
                shippingSection.style.display = 'none';
                modalTitle.textContent = 'Add New Parcel';
            }

            // Render presets
            renderParcelPresets();

            modal.classList.remove('hidden');
        }


        // parcels/shipped then formats
        // Data storage
        let orders = [];
        let parcels = [];

        let currentParcelTab = 'planning'; // 'planning' or 'shipped'

        // Custom header text from localStorage or default
        let customHeaderText = localStorage.getItem('customHeaderText') || 'Neo_ Order Tracker';

        // for logging import changes (in parseHTML())
        let activityLog = [];

        // Safe loading of activity log
        try {
            activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
        } catch (e) {
            console.error('Error loading activity log:', e);
            activityLog = [];
        }

        let newOrderCount = 0; // Track new orders added from HTML parsing

        // Safe data loading with error handling
        try {
            orders = JSON.parse(localStorage.getItem('orders') || '[]');
            // Ensure all orders have proper tags field
            orders = orders.map(order => ({
                ...order,
                tags: order.tags || ''
            }));
        } catch (e) {
            console.error('Error loading orders:', e);
            orders = [];
        }

        try {
            parcels = JSON.parse(localStorage.getItem('parcels') || '[]');
        } catch (e) {
            console.error('Error loading parcels:', e);
            parcels = [];
        }
        let currentView = 'grid';


        let showTotals = true;
        let sortState = { field: null, direction: 'asc' }; // Track sort state
        let currentEditingParcel = null; // Track which parcel is being edited

        // Multi-select filter states
        let selectedStatuses = [];
        let selectedFormats = [];
        let selectedParcels = [];
        let selectedTags = [];
        let excludedStatuses = [];
        let excludedFormats = [];
        let excludedParcels = [];
        let excludedTags = [];


        // Column visibility state
        let columnVisibility = {
            image: true,
            orderId: true,
            title: true,
            quantity: true,
            yen: true,
            usd: true,
            created: true,
            storageDays: true,
            status: true,
            neokyoNotes: true,
            bookFormat: true,
            volumes: true,
            parcel: true,
            tags: true,
            url: true,
            actions: true
        };

        // Book format specifications - now editable
        let bookFormats = JSON.parse(localStorage.getItem('bookFormats') || JSON.stringify({
            'Default': { width: 10, height: 10, thickness: 10, weight: 10 },
            'A5 Wideban': { width: 14.8, height: 21.0, thickness: 2.25, weight: 310 },
            'A5 Doujinshi': { width: 14.8, height: 21.0, thickness: 0.4, weight: 100 },
            'B6 Standard': { width: 12.8, height: 18.2, thickness: 1.7, weight: 190 },
            'B5 Artbook': { width: 18.2, height: 25.7, thickness: 1.5, weight: 310 },
            'B5 Doujinshi': { width: 18.2, height: 25.7, thickness: 0.3, weight: 100 },
            'A4 Artbook': { width: 21.0, height: 29.7, thickness: 1.5, weight: 350 },
            'A4 Doujinshi': { width: 21.0, height: 29.7, thickness: 0.4, weight: 80 },
            'A6 Bunkoban': { width: 10.5, height: 14.8, thickness: 1.4, weight: 150 },
            'A6 Shinshoban': { width: 11.0, height: 17.0, thickness: 1.4, weight: 150 }
        }));

        // Default formats for reset function
        const defaultFormats = {
            'Default': { width: 10, height: 10, thickness: 10, weight: 10 },
            'A5 Wideban': { width: 14.8, height: 21.0, thickness: 2.25, weight: 310 },
            'A5 Doujinshi': { width: 14.8, height: 21.0, thickness: 0.4, weight: 100 },
            'B6 Standard': { width: 12.8, height: 18.2, thickness: 1.7, weight: 190 },
            'B5 Artbook': { width: 18.2, height: 25.7, thickness: 1.5, weight: 310 },
            'B5 Doujinshi': { width: 18.2, height: 25.7, thickness: 0.3, weight: 100 },
            'A4 Artbook': { width: 21.0, height: 29.7, thickness: 1.5, weight: 350 },
            'A4 Doujinshi': { width: 21.0, height: 29.7, thickness: 0.4, weight: 80 },
            'A6 Bunkoban': { width: 10.5, height: 14.8, thickness: 1.4, weight: 150 },
            'A6 Shinshoban': { width: 11.0, height: 17.0, thickness: 1.4, weight: 150 }
        };

        // Currency configuration
        let currentCurrency = localStorage.getItem('selectedCurrency') || 'USD';

        const currencyConfig = {
            'USD': { name: 'USD', symbol: '$', parseRegex: /US\$\s*([\d.]+)/, displayName: 'USD' },
            'GBP': { name: 'GBP', symbol: '£', parseRegex: /£\s*([\d.]+)/, displayName: 'GBP' },
            'EUR': { name: 'EUR', symbol: '€', parseRegex: /€\s*([\d.]+)/, displayName: 'EUR' },
            'MXN': { name: 'MXN', symbol: 'MX$', parseRegex: /MXN\$\s*([\d.]+)/, displayName: 'MXN' },
            'CAD': { name: 'CAD', symbol: 'C$', parseRegex: /CAD\$\s*([\d.]+)/, displayName: 'CAD' },
            'HKD': { name: 'HKD', symbol: 'HK$', parseRegex: /HK\$\s*([\d.]+)/, displayName: 'HKD' },
            'TWD': { name: 'TWD', symbol: 'NT$', parseRegex: /NT\$\s*([\d.]+)/, displayName: 'TWD' },
            'PHP': { name: 'PHP', symbol: '₱', parseRegex: /PHP\$\s*([\d.]+)/, displayName: 'PHP' },
            'AUD': { name: 'AUD', symbol: 'A$', parseRegex: /AUD\$\s*([\d.]+)/, displayName: 'AUD' },
            'KRW': { name: 'KRW', symbol: '₩', parseRegex: /KRW₩\s*([\d.]+)/, displayName: 'KRW' }
        };

        function getCurrentCurrencyConfig() {
            return currencyConfig[currentCurrency];
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('header').textContent = customHeaderText;
            // Load column visibility preferences
            try {
                const savedVisibility = localStorage.getItem('columnVisibility');
                if (savedVisibility) {
                    columnVisibility = { ...columnVisibility, ...JSON.parse(savedVisibility) };
                    Object.keys(columnVisibility).forEach(col => {
                        const checkbox = document.getElementById(`col-${col}`);
                        if (checkbox) {
                            checkbox.checked = columnVisibility[col];
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading column visibility:', e);
            }

            // Initialize parcel tab stats
            updateParcelTabStats();

            // Initialize currency selector
            document.getElementById('currencySelector').value = currentCurrency;
            document.getElementById('totalCurrencyLabel').textContent = `Total ${getCurrentCurrencyConfig().displayName}`;


            // Make sure all existing parcels have the new status field
            let needsSave = false;
            parcels.forEach(parcel => {
                if (!parcel.status) {
                    parcel.status = 'planning';
                    needsSave = true;
                }
                if (parcel.shippingMethod === undefined) parcel.shippingMethod = '';
                if (parcel.shippingCost === undefined) parcel.shippingCost = 0;
                if (parcel.actualWeight === undefined) parcel.actualWeight = 0;
                if (parcel.shipDate === undefined) parcel.shipDate = '';
                if (parcel.arrivalDate === undefined) parcel.arrivalDate = '';
                if (parcel.trackingNumber === undefined) parcel.trackingNumber = '';
                if (parcel.trackingURL === undefined) parcel.trackingURL = '';
                if (parcel.declaredValue === undefined) parcel.declaredValue = 0;
            });

            if (needsSave) {
                localStorage.setItem('parcels', JSON.stringify(parcels));
            }

            renderTagsDropdown();
            renderFormatDropdown();
            renderStatusDropdown();
            renderParcelDropdown();
            renderView();
            renderParcels();
            updateParcelTabStats();
            updateTotals();
        });

        function parseAnyCurrency(billingText) {
            // Look for any currency pattern: (SYMBOL AMOUNT) or (CODE$ AMOUNT)
            const patterns = [
                /\(US\$\s*([\d.]+)\)/,
                /\(£\s*([\d.]+)\)/,
                /\(€\s*([\d.]+)\)/,
                /\(MXN\$\s*([\d.]+)\)/,
                /\(CAD\$\s*([\d.]+)\)/,
                /\(HK\$\s*([\d.]+)\)/,
                /\(NT\$\s*([\d.]+)\)/,
                /\(PHP\$\s*([\d.]+)\)/,
                /\(AUD\$\s*([\d.]+)\)/,
                /\(KRW₩\s*([\d.]+)\)/
            ];

            for (const pattern of patterns) {
                const match = billingText.match(pattern);
                if (match) {
                    return parseFloat(match[1]);
                }
            }
            return 0;
        }

        function parseHTML() {
            const htmlInput = document.getElementById('htmlInput').value;
            if (!htmlInput.trim()) {
                alert('Please paste HTML code first');
                return;
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlInput, 'text/html');
            const rows = doc.querySelectorAll('tr');

            newOrderCount = 0;
            let updatedOrderCount = 0;
            let unchangedOrderCount = 0;
            const importSession = {
                timestamp: new Date().toISOString(),
                newOrders: [],
                updatedOrders: [],
                unchangedOrders: []
            };

            // ALWAYS load the full dataset from localStorage first
            let allOrders = [];
            try {
                allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            } catch (e) {
                console.error('Error loading orders:', e);
                allOrders = [];
            }

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const imgDiv = cells[0].querySelector('.img-holder');
                    const imgUrl = imgDiv ? imgDiv.style.backgroundImage.replace(/url\(['"]?(.+?)['"]?\)/, '$1') : '';

                    const detailsCell = cells[1];
                    const orderIdMatch = detailsCell.innerHTML.match(/#(\d+)/);
                    const titleMatch = detailsCell.innerHTML.match(/<b>(.*?)<\/b>/g);
                    const quantityMatch = detailsCell.innerHTML.match(/Quantity\s*:\s*(\d+)/);
                    const createdMatch = detailsCell.innerHTML.match(/Created:\s*(\d{2}\/\d{2}\/\d{4})/);

                    const statusCell = cells[2];
                    const storageDaysMatch = statusCell.innerHTML.match(/<b>(\d+)<\/b>\s*Storage day/);

                    // Parse status and notes
                    const statusParagraphs = statusCell.querySelectorAll('p');
                    let status = '';
                    let neokyoNotes = '';

                    if (statusParagraphs.length > 0) {
                        const firstP = statusParagraphs[0];
                        const statusText = firstP.textContent.trim();
                        if (statusText.includes('In storage')) {
                            status = 'In Storage';
                        } else if (statusText.includes('Arrived') || statusText.includes('soon in storage')) {
                            status = 'Arrived';
                        } else if (statusText.includes('Awaiting delivery')) {
                            status = 'Awaiting Delivery';
                        } else if (statusText.includes('Cancelled')) {
                            status = 'Cancelled';
                        } else {
                            status = statusText.replace(/\s+/g, ' ').trim();
                        }

                        if (statusParagraphs.length > 1) {
                            const secondP = statusParagraphs[1];
                            neokyoNotes = secondP.textContent.replace(/\s+/g, ' ').trim();
                        }
                    }

                    const billingCell = cells[3];
                    const yenMatch = billingCell.innerHTML.match(/(\d+)\s*yen/);
                    const currencyAmount = parseAnyCurrency(billingCell.innerHTML);

                    const actionsCell = cells[4];
                    const linkMatch = actionsCell.innerHTML.match(/href=['"]([^'"]+)['"]/);

                    if (orderIdMatch && titleMatch && quantityMatch) {
                        const orderId = orderIdMatch[1];
                        const title = titleMatch[titleMatch.length - 1].replace(/<\/?b>/g, '');

                        // Check if order already exists in the FULL dataset
                        const existingOrder = allOrders.find(order => order.orderId === orderId);

                        if (existingOrder) {
                            // Track what changed
                            const changes = {};
                            const newStorageDays = storageDaysMatch ? parseInt(storageDaysMatch[1]) : existingOrder.storageDays;
                            const newStatus = status || existingOrder.status;
                            const newNeokyoNotes = neokyoNotes || existingOrder.neokyoNotes;

                            // Check for changes
                            if (existingOrder.storageDays !== newStorageDays) {
                                changes.storageDays = {
                                    from: existingOrder.storageDays,
                                    to: newStorageDays
                                };
                            }

                            if (existingOrder.status !== newStatus) {
                                changes.status = {
                                    from: existingOrder.status || 'None',
                                    to: newStatus
                                };
                            }

                            if (existingOrder.neokyoNotes !== newNeokyoNotes) {
                                changes.neokyoNotes = {
                                    from: existingOrder.neokyoNotes || 'None',
                                    to: newNeokyoNotes
                                };
                            }

                            const newYen = yenMatch ? parseInt(yenMatch[1]) : existingOrder.yen;
                            const newUsd = currencyAmount || existingOrder.usd;

                            if (existingOrder.yen !== newYen) {
                                changes.yen = {
                                    from: existingOrder.yen,
                                    to: newYen
                                };
                            }

                            // Only update USD if the difference is significant (over 50 cents)
                            if (existingOrder.usd !== newUsd) {
                                const priceDifference = Math.abs(existingOrder.usd - newUsd);

                                if (priceDifference > 0.50) {
                                    changes.usd = {
                                        from: existingOrder.usd,
                                        to: newUsd
                                    };
                                    existingOrder.usd = newUsd; // Only update if significant
                                }
                            }

                            if (Object.keys(changes).length > 0) {
                                // UPDATE existing order with changes
                                existingOrder.storageDays = newStorageDays;
                                existingOrder.status = newStatus;
                                existingOrder.neokyoNotes = newNeokyoNotes;
                                updatedOrderCount++;

                                // Log the changes
                                importSession.updatedOrders.push({
                                    orderId: orderId,
                                    title: title,
                                    changes: changes
                                });
                            } else {
                                // No changes detected
                                unchangedOrderCount++;
                                importSession.unchangedOrders.push({
                                    orderId: orderId,
                                    title: title
                                });
                            }
                        } else {
                            // CREATE new order
                            const order = {
                                id: Date.now() + Math.random(),
                                image: imgUrl,
                                orderId: orderId,
                                title: title,
                                quantity: parseInt(quantityMatch[1]),
                                yen: yenMatch ? parseInt(yenMatch[1]) : 0,
                                usd: currencyAmount,
                                created: createdMatch ? createdMatch[1] : '',
                                storageDays: storageDaysMatch ? parseInt(storageDaysMatch[1]) : 0,
                                status: status,
                                neokyoNotes: neokyoNotes,
                                url: linkMatch ? linkMatch[1] : '',
                                tags: '',
                                bookFormat: 'Default',
                                volumes: 0,
                                parcel: ''
                            };
                            newOrderCount++;
                            allOrders.push(order);

                            // Log new order
                            importSession.newOrders.push({
                                orderId: orderId,
                                title: title
                            });
                        }
                    }
                }
            });

            // Save the complete dataset
            localStorage.setItem('orders', JSON.stringify(allOrders));

            // Add import session to activity log if there were any changes
            if (importSession.newOrders.length > 0 || importSession.updatedOrders.length > 0) {
                activityLog.unshift(importSession); // Add to beginning of array
                // Keep only last 50 import sessions to prevent memory bloat
                if (activityLog.length > 50) {
                    activityLog = activityLog.slice(0, 50);
                }
                localStorage.setItem('activityLog', JSON.stringify(activityLog));
            }

            // Clear filters and show/reload all orders after import
            clearFilters();
            renderStatusDropdown();

            document.getElementById('htmlInput').value = '';

            // Build detailed message
            let message = '';
            if (newOrderCount > 0) {
                message += `✅ Imported ${newOrderCount} new orders\n`;
            }
            if (unchangedOrderCount > 0) {
                message += `📊 ${unchangedOrderCount} existing orders remained the same\n`;
            }
            if (updatedOrderCount > 0) {
                message += `🔄 ${updatedOrderCount} existing orders were updated\n`;

                // Add details about changes
                const changeDetails = importSession.updatedOrders.map(order => {
                    const changeStrings = Object.entries(order.changes).map(([field, change]) => {
                        const fieldName = field === 'storageDays' ? 'Storage Days' :
                            field === 'neokyoNotes' ? 'Notes' :
                                field === 'yen' ? 'Yen Price' :
                                    field === 'usd' ? `${getCurrentCurrencyConfig().displayName} Price` :
                                        field.charAt(0).toUpperCase() + field.slice(1);
                        return `   • ${fieldName}: "${change.from}" → "${change.to}"`;
                    });
                    return `  #${order.orderId}: ${order.title.substring(0, 30)}${order.title.length > 30 ? '...' : ''}\n${changeStrings.join('\n')}`;
                }).join('\n\n');

                message += '\nChanges made:\n' + changeDetails;
            }

            if (message) {
                // For long messages, show a summary alert and offer to view full log
                if (message.length > 300) {
                    const summary = `Import completed!\n• ${newOrderCount} new orders\n• ${unchangedOrderCount} unchanged\n• ${updatedOrderCount} updated\n\nView Activity Log for full details?`;
                    if (confirm(summary)) {
                        showActivityLog();
                    }
                } else {
                    alert(message);
                }
            } else {
                alert('No new or updated orders found.');
            }
        }

        function renderView() {
            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderTableView();
            }
        }

        function renderGridView() {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');

            gridView.classList.remove('hidden');
            tableView.classList.add('hidden');

            gridView.innerHTML = orders.map(order => `
        <div class="grid-item ${selectedOrders.has(order.id) ? 'batch-mode-active' : ''} ${batchMode ? 'batch-selectable' : ''}" 
             ${batchMode ? `onclick="toggleGridItemSelection('${order.id}')"` : ''}>
            ${batchMode ? `<input type="checkbox" class="batch-checkbox" id="batch-${order.id}" ${selectedOrders.has(order.id) ? 'checked' : ''} readonly>` : ''}
            <a href="${order.url}" target="_blank" onclick="event.stopPropagation()"><img src="${order.image}" alt="${order.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIxODAiIGZpbGw9IiNmM2Y0ZjYiLz48cGF0aCBkPSJNMTQwIDkwSDEyMFY3MEgxNDBWOTBaTTE4MCA5MEgxNjBWNzBIMTgwVjkwWk0xNjAgMTEwSDE0MFY5MEgxNjBWMTEwWiIgZmlsbD0iIzljYTNhZiIvPjwvc3ZnPg=='"></a>
            <div class="order-id">#${order.orderId}</div>
            <h3>${order.title}</h3>
            <div class="price">¥${order.yen} (${getCurrentCurrencyConfig().symbol}${order.usd})</div>
            <div class="details">
                <span>Qty <span class="detail-val">${order.quantity}</span></span>
                <span>Days <span class="detail-val">${order.storageDays}</span></span>
                <span>Status <span class="detail-val">${order.status || 'Unknown'}</span></span>
            </div>
            <div class="details">
                <span>Items <input type="number" value="${order.volumes}" onchange="updateOrder('${order.id}', 'volumes', this.value)" style="width: 40px;" onclick="event.stopPropagation()"></span>
                <span>Format 
                    <select onchange="updateOrder('${order.id}', 'bookFormat', this.value)" style="width: 70px;" onclick="event.stopPropagation()">
                        ${Object.keys(bookFormats).map(format =>
                `<option value="${format}" ${order.bookFormat === format ? 'selected' : ''}>${format}</option>`
            ).join('')}
                    </select>
                </span>
                <span>Parcel 
                    <select onchange="updateOrder('${order.id}', 'parcel', this.value)" style="width: 80px;" onclick="event.stopPropagation()">
                        <option value="">None</option>
                        ${parcels.map(parcel =>
                `<option value="${parcel.id}" ${order.parcel === parcel.id ? 'selected' : ''}>${parcel.name}</option>`
            ).join('')}
                    </select>
                </span>
            </div>
            ${order.neokyoNotes ? `<div class="neokyo-note">${order.neokyoNotes}</div>` : ''}

            ${renderTagsUI(order.id, order.tags)}

            <!--- <div class="actions">
                <a href="${order.url}" class="btn btn-small" target="_blank" onclick="event.stopPropagation()">Open</a>
                <button class="btn btn-small btn-secondary" onclick="deleteOrder('${order.id}'); event.stopPropagation()">Delete</button>
            </div> -->
        </div>
    `).join('');
        }

        function toggleGridItemSelection(orderId) {
            if (!batchMode) return;

            const orderIdStr = String(orderId);
            const checkbox = document.getElementById(`batch-${orderId}`);

            if (selectedOrders.has(orderIdStr)) {
                selectedOrders.delete(orderIdStr);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedOrders.add(orderIdStr);
                if (checkbox) checkbox.checked = true;
            }

            updateSelectedCount();
            updateOrderHighlight(orderId);
        }


        function renderTableView() {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');

            gridView.classList.add('hidden');
            tableView.classList.remove('hidden');

            // Helper function to get sort class for a field
            const getSortClass = (field) => {
                if (sortState.field === field) {
                    return sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc';
                }
                return '';
            };

            tableView.innerHTML = `
        <table>
            <thead>
                <tr>
                    ${batchMode ? '<th class="batch-checkbox-cell">Select</th>' : ''}
                    <th onclick="sortBy('image')" class="${columnVisibility.image ? '' : 'hidden-column'} ${getSortClass('image')}">Image</th>
                    <th onclick="sortBy('orderId')" class="${columnVisibility.orderId ? '' : 'hidden-column'} ${getSortClass('orderId')}">Order #</th>
                    <th onclick="sortBy('title')" class="${columnVisibility.title ? '' : 'hidden-column'} ${getSortClass('title')}">Title</th>
                    <th onclick="sortBy('quantity')" class="${columnVisibility.quantity ? '' : 'hidden-column'} ${getSortClass('quantity')}">Qty</th>
                    <th onclick="sortBy('volumes')" class="${columnVisibility.volumes ? '' : 'hidden-column'} ${getSortClass('volumes')}">Items</th>
                    <th onclick="sortBy('yen')" class="${columnVisibility.yen ? '' : 'hidden-column'} ${getSortClass('yen')}">Yen</th>
                    <th onclick="sortBy('usd')" class="${columnVisibility.usd ? '' : 'hidden-column'} ${getSortClass('usd')}">${getCurrentCurrencyConfig().displayName}</th>
                    <th onclick="sortBy('created')" class="${columnVisibility.created ? '' : 'hidden-column'} ${getSortClass('created')}">Created</th>
                    <th onclick="sortBy('storageDays')" class="${columnVisibility.storageDays ? '' : 'hidden-column'} ${getSortClass('storageDays')}">Storage Days</th>
                    <th onclick="sortBy('status')" class="${columnVisibility.status ? '' : 'hidden-column'} ${getSortClass('status')}">Status</th>
                    <th onclick="sortBy('neokyoNotes')" class="${columnVisibility.neokyoNotes ? '' : 'hidden-column'} ${getSortClass('neokyoNotes')}">Neokyo Notes</th>
                    <th onclick="sortBy('bookFormat')" class="${columnVisibility.bookFormat ? '' : 'hidden-column'} ${getSortClass('bookFormat')}">Format</th>
                    <th onclick="sortBy('parcel')" class="${columnVisibility.parcel ? '' : 'hidden-column'} ${getSortClass('parcel')}">Parcel</th>
                    <th onclick="sortBy('tags')" class="${columnVisibility.tags ? '' : 'hidden-column'} ${getSortClass('tags')}">Tags</th>
                    <th class="${columnVisibility.url ? '' : 'hidden-column'}">URL</th>
                    <th class="${columnVisibility.actions ? '' : 'hidden-column'}">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${orders.map(order => {
                const parcelName = order.parcel ? (parcels.find(p => p.id === order.parcel)?.name || 'Unknown') : '';
                return `
                    <tr class="${selectedOrders.has(String(order.id)) ? 'batch-mode-active' : ''} ${batchMode ? 'batch-selectable' : ''}" 
                        ${batchMode ? `onclick="toggleTableRowSelection('${order.id}', event)"` : ''}>
                        ${batchMode ? `<td class="batch-checkbox-cell"><input type="checkbox" class="batch-checkbox" id="batch-${order.id}" ${selectedOrders.has(String(order.id)) ? 'checked' : ''} readonly></td>` : ''}
                        <td class="${columnVisibility.image ? '' : 'hidden-column'}"><img src="${order.image}" alt="${order.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNmM2Y0ZjYiLz48cGF0aCBkPSJNMjYgMzBIMjRWMjZIMjZWMzBaTTM0IDMwSDMyVjI2SDM0VjMwWk0zMiAzNkgzMFYzMEgzMlYzNloiIGZpbGw9IiM5Y2EzYWYiLz48L3N2Zz4='"></td>
                        <td class="${columnVisibility.orderId ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'orderId', '${order.orderId}'); event.stopPropagation()">${order.orderId}</div></td>
                        <td class="${columnVisibility.title ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'title', '${order.title}'); event.stopPropagation()">${order.title}</div></td>
                        <td class="${columnVisibility.quantity ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'quantity', '${order.quantity}', 'number'); event.stopPropagation()">${order.quantity}</div></td>
                        <td class="${columnVisibility.volumes ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'volumes', '${order.volumes}', 'number'); event.stopPropagation()">${order.volumes}</div></td>
                        <td class="${columnVisibility.yen ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'yen', '${order.yen}', 'number'); event.stopPropagation()">${order.yen}</div></td>
                        <td class="${columnVisibility.usd ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'usd', '${order.usd}', 'number'); event.stopPropagation()">${order.usd}</div></td>
                        <td class="${columnVisibility.created ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'created', '${order.created}'); event.stopPropagation()">${order.created}</div></td>
                        <td class="${columnVisibility.storageDays ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'storageDays', '${order.storageDays}', 'number'); event.stopPropagation()">${order.storageDays}</div></td>
                        <td class="${columnVisibility.status ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'status', '${order.status || ''}'); event.stopPropagation()">${order.status || ''}</div></td>
                        <td class="${columnVisibility.neokyoNotes ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'neokyoNotes', '${order.neokyoNotes || ''}', 'textarea'); event.stopPropagation()">${order.neokyoNotes || ''}</div></td>
                        <td class="${columnVisibility.bookFormat ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'bookFormat', '${order.bookFormat}', 'select'); event.stopPropagation()">${order.bookFormat}</div></td>
                        <td class="${columnVisibility.parcel ? '' : 'hidden-column'}"><div class="editable-cell" onclick="makeEditable(this, '${order.id}', 'parcel', '${order.parcel}', 'select'); event.stopPropagation()">${parcelName}</div></td>
                        <td class="${columnVisibility.tags ? '' : 'hidden-column'}" onclick="event.stopPropagation()">${renderTagsUI(order.id, order.tags)}</td>
                        <td class="${columnVisibility.url ? '' : 'hidden-column'}"><a href="${order.url}" target="_blank" class="btn btn-small" onclick="event.stopPropagation()">Open</a></td>
                        <td class="${columnVisibility.actions ? '' : 'hidden-column'}"><button class="btn btn-small btn-secondary" onclick="deleteOrder('${order.id}'); event.stopPropagation()">Delete</button></td>
                    </tr>
                `;
            }).join('')}
            </tbody>
        </table>
    `;
        }

        function toggleTableRowSelection(orderId, event) {
            // Don't trigger selection if clicking on interactive elements that already have stopPropagation
            if (event.target.closest('.editable-cell') ||
                event.target.closest('button') ||
                event.target.closest('a') ||
                event.target.closest('input') ||
                event.target.closest('select')) {
                return;
            }

            if (!batchMode) return;

            const orderIdStr = String(orderId);
            const checkbox = document.getElementById(`batch-${orderId}`);
            const row = event.currentTarget;

            if (selectedOrders.has(orderIdStr)) {
                selectedOrders.delete(orderIdStr);
                if (checkbox) checkbox.checked = false;
                row.classList.remove('batch-mode-active');
            } else {
                selectedOrders.add(orderIdStr);
                if (checkbox) checkbox.checked = true;
                row.classList.add('batch-mode-active');
            }

            updateSelectedCount();
        }

        // for table view - make cells editable
        function makeEditable(cell, orderId, field, value, type = 'text') {
            if (cell.classList.contains('editing')) return;

            cell.classList.add('editing');
            const originalText = cell.innerHTML;

            let input;
            if (type === 'select') {
                input = document.createElement('select');
                if (field === 'bookFormat') {
                    input.innerHTML = Object.keys(bookFormats).map(format =>
                        `<option value="${format}" ${value === format ? 'selected' : ''}>${format}</option>`
                    ).join('');
                } else if (field === 'parcel') {
                    input.innerHTML = '<option value="">None</option>' +
                        parcels.map(parcel =>
                            `<option value="${parcel.id}" ${value === parcel.id ? 'selected' : ''}>${parcel.name}</option>`
                        ).join('');
                }
            } else if (type === 'textarea') {
                input = document.createElement('textarea');
                input.value = value || '';
            } else {
                input = document.createElement('input');
                input.type = type;
                input.value = value || '';
                if (type === 'number') {
                    input.step = field === 'usd' ? '0.01' : '1';
                }
            }

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            if (input.select) input.select();

            function saveEdit() {
                const newValue = input.value;
                cell.classList.remove('editing');

                // Update display based on field type
                if (field === 'parcel' && newValue) {
                    const parcel = parcels.find(p => p.id === newValue);
                    cell.textContent = parcel ? parcel.name : 'None';
                } else {
                    cell.textContent = newValue || '';
                }

                updateOrder(orderId, field, newValue);

                // Handle tags special case
                if (field === 'tags') {
                    renderTagsDropdown();
                }
            }

            function cancelEdit() {
                cell.classList.remove('editing');
                cell.innerHTML = originalText;
            }

            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && type !== 'textarea') {
                    e.preventDefault();
                    saveEdit();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }

                // Handle tags special case
                if (field === 'tags' && e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                }
            });
        }


        function updateOrder(orderId, field, value) {
            // Find order in the original data stored in localStorage
            let allOrders = [];
            try {
                allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            } catch (e) {
                console.error('Error loading orders:', e);
                return;
            }

            const order = allOrders.find(o => o.id == orderId);
            if (order) {
                if (field === 'quantity' || field === 'yen' || field === 'storageDays' || field === 'volumes') {
                    order[field] = parseInt(value) || 0;
                } else if (field === 'usd') {
                    order[field] = parseFloat(value) || 0;
                } else {
                    order[field] = value;
                }

                // Save back to localStorage
                localStorage.setItem('orders', JSON.stringify(allOrders));

                // Update the currently displayed orders array
                const displayedOrder = orders.find(o => o.id == orderId);
                if (displayedOrder) {
                    Object.assign(displayedOrder, order);
                }

                updateTotals();
                renderParcels(); // Update parcel calculations
                updateParcelTabStats();

                // Check if the new value matches or doesn't match the filter
                let matches = true;

                if (field === 'parcel' && selectedParcels.length > 0) {
                    matches = selectedParcels.includes(value);
                } else if (field === 'bookFormat' && selectedFormats.length > 0) {
                    matches = selectedFormats.includes(value);
                } else if (field === 'status' && selectedStatuses.length > 0) {
                    matches = selectedStatuses.some(s => value.toLowerCase().includes(s.toLowerCase()));
                } else if (field === 'tags' && selectedTags.length > 0) {
                    const orderTags = value.split(' ').filter(t => t.trim());
                    matches = selectedTags.every(t => orderTags.includes(t));
                }

                // Update the visual state
                updateItemHighlight(orderId, matches);
            }
        }

        function updateItemHighlight(orderId, matches) {
            // Find the element in the current view
            if (currentView === 'grid') {
                const gridItems = document.querySelectorAll('.grid-item');
                gridItems.forEach(item => {
                    if (item.innerHTML.includes(`updateOrder('${orderId}'`)) {
                        if (matches) {
                            item.classList.remove('filter-mismatch');
                        } else {
                            item.classList.add('filter-mismatch');
                        }
                    }
                });
            } else {
                const tableRows = document.querySelectorAll('.table-view tbody tr');
                tableRows.forEach(row => {
                    if (row.innerHTML.includes(`updateOrder('${orderId}'`)) {
                        if (matches) {
                            row.classList.remove('filter-mismatch');
                        } else {
                            row.classList.add('filter-mismatch');
                        }
                    }
                });
            }
        }



        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                // Load ALL orders from localStorage
                let allOrders = [];
                try {
                    allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                } catch (e) {
                    console.error('Error loading orders:', e);
                    return;
                }

                // Remove the order from the full dataset
                allOrders = allOrders.filter(o => o.id != orderId);

                // Save the updated full dataset back to localStorage
                localStorage.setItem('orders', JSON.stringify(allOrders));

                // Also remove from the currently displayed orders
                orders = orders.filter(o => o.id != orderId);

                renderView();
                updateTotals();
                renderParcels();
                updateParcelTabStats();
            }
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide column controls button
            const columnBtn = document.getElementById('columnToggleBtn');
            const columnControls = document.getElementById('columnControls');
            if (view === 'table') {
                columnBtn.style.display = 'block';
            } else {
                columnBtn.style.display = 'none';
                columnControls.classList.remove('show');
            }

            renderView();
        }

        function toggleColumnControls() {
            const columnControls = document.getElementById('columnControls');
            columnControls.classList.toggle('show');
        }

        function toggleColumn(columnName) {
            columnVisibility[columnName] = document.getElementById(`col-${columnName}`).checked;
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            renderView();
        }

        function showAllColumns() {
            Object.keys(columnVisibility).forEach(col => {
                columnVisibility[col] = true;
                document.getElementById(`col-${col}`).checked = true;
            });
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            renderView();
        }

        function hideAllColumns() {
            Object.keys(columnVisibility).forEach(col => {
                columnVisibility[col] = false;
                document.getElementById(`col-${col}`).checked = false;
            });
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            renderView();
        }

        function sortBy(field) {
            // Toggle sort direction if clicking same field, otherwise start with ascending
            if (sortState.field === field) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.field = field;
                sortState.direction = 'asc';
            }

            // Sort the orders
            orders.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                // Handle special cases
                if (field === 'parcel') {
                    // Convert parcel ID to parcel name for sorting
                    const parcelA = parcels.find(p => p.id === aVal);
                    const parcelB = parcels.find(p => p.id === bVal);
                    aVal = parcelA ? parcelA.name : '';
                    bVal = parcelB ? parcelB.name : '';
                }

                // Handle null/undefined values
                if (aVal == null) aVal = '';
                if (bVal == null) bVal = '';

                // Numeric comparison
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return sortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }

                // String comparison
                const aStr = String(aVal).toLowerCase();
                const bStr = String(bVal).toLowerCase();

                if (sortState.direction === 'asc') {
                    return aStr.localeCompare(bStr);
                } else {
                    return bStr.localeCompare(aStr);
                }
            });

            renderView();
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const searchTerms = search.split(',').map(term => term.trim()).filter(Boolean);
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            const filteredOrders = JSON.parse(localStorage.getItem('orders') || '[]').filter(order => {
                const matchesSearch = searchTerms.length === 0 ||
                    searchTerms.some(term =>
                        order.orderId.toLowerCase().includes(term) ||
                        order.title.toLowerCase().includes(term)
                    );

                // Updated tags filter logic
                const matchesTags = selectedTags.length === 0 ||
                    selectedTags.some(selectedTag => {
                        if (selectedTag === 'Untagged') {
                            // Check if order has no tags or empty tags
                            return !order.tags || order.tags.trim() === '';
                        } else {
                            const orderTags = String(order.tags || '').split(' ').filter(t => t.trim());
                            return orderTags.includes(selectedTag);
                        }
                    });

                const matchesPrice = order.yen >= minPrice && order.yen <= maxPrice;

                const matchesFormat = selectedFormats.length === 0 ||
                    selectedFormats.includes(order.bookFormat);

                const matchesStatus = selectedStatuses.length === 0 ||
                    selectedStatuses.some(selectedStatus =>
                        (order.status || '').toLowerCase().includes(selectedStatus.toLowerCase()));

                // Updated parcel filter logic
                const matchesParcel = selectedParcels.length === 0 ||
                    selectedParcels.some(selectedParcel => {
                        if (selectedParcel === '__NO_PARCEL__') {
                            // Check if order has no parcel assigned
                            return !order.parcel || order.parcel === '';
                        } else {
                            return order.parcel === selectedParcel;
                        }
                    });

                return matchesSearch && matchesTags && matchesPrice && matchesFormat && matchesStatus && matchesParcel;
            });

            orders = filteredOrders;
            applySortToOrders();
            renderView();
            updateTotals();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            // document.getElementById('tagsInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';

            // Clear multi-select status filter
            selectedStatuses = [];
            document.querySelectorAll('#statusesMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            renderStatusTags();

            // Clear multi-select format filter
            selectedFormats = [];
            document.querySelectorAll('#formatsMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            renderFormatTags();

            // Clear multi-select parcel filter
            selectedParcels = [];
            document.querySelectorAll('#parcelsMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            renderParcelTags();

            // Clear multi-select tags filter
            selectedTags = [];
            document.querySelectorAll('#tagsMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            renderTagsTags();

            // Reset orders to original data from localStorage
            try {
                orders = JSON.parse(localStorage.getItem('orders') || '[]');
                // Ensure all orders have proper tags field
                orders = orders.map(order => ({
                    ...order,
                    tags: order.tags || ''
                }));
            } catch (e) {
                console.error('Error loading orders:', e);
                orders = [];
            }

            renderView();
            updateTotals();
        }

        function toggleTotals() {
            showTotals = !showTotals;
            const totalsRow = document.getElementById('totalsRow');
            if (showTotals) {
                totalsRow.classList.remove('hidden');
            } else {
                totalsRow.classList.add('hidden');
            }
        }

        function updateTotals() {
            const activeOrders = orders.filter(order =>
                order.status !== 'Cancelled'
            );

            const totalItems = orders.length; // For cancelled orders, only keeping this for the orig total items count
            const totalYen = activeOrders.reduce((sum, order) => sum + order.yen, 0);
            const totalUSD = activeOrders.reduce((sum, order) => sum + order.usd, 0);

            // Calculate total item quantity - use activeOrders
            const totalItemQuantity = activeOrders.reduce((sum, order) => {
                return sum + ((order.volumes || 1) * order.quantity);
            }, 0);

            // Get a default format to use as fallback
            const defaultFormatName = Object.keys(bookFormats)[0] || 'Default';
            const defaultFormat = bookFormats[defaultFormatName] || { weight: 190 };

            let totalWeight = 0;
            let totalVolumes = 0;

            activeOrders.forEach(order => {
                const format = bookFormats[order.bookFormat] || defaultFormat;
                const itemWeight = format.weight * (order.volumes || 1);
                totalWeight += itemWeight * order.quantity;

                totalVolumes += (order.volumes || 1) * order.quantity;
            });

            // Calculate USD per item
            const avgUSDPerItem = totalItemQuantity > 0 ? (totalUSD / totalItemQuantity) : 0;


            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalYen').textContent = `¥${totalYen.toLocaleString()}`;
            const currConfig = getCurrentCurrencyConfig();
            document.getElementById('totalUSD').textContent = `${currConfig.symbol}${totalUSD.toFixed(2)}`;
            document.getElementById('avgUSDPerItem').textContent = `${currConfig.symbol}${avgUSDPerItem.toFixed(2)}`;

            const usdSymbols = document.querySelectorAll('[data-label*="Currency"]');
            usdSymbols.forEach(label => {
                label.textContent = label.textContent.replace('$', currConfig.symbol);
            });

            const usdLabels = document.querySelectorAll('[data-label*="USD"]');
            usdLabels.forEach(label => {
                label.textContent = label.textContent.replace('USD', currConfig.displayName);
            });

            const totalCurrencyLabel = document.querySelector('[data-label="Total USD"]');
            if (totalCurrencyLabel) {
                totalCurrencyLabel.textContent = `Total ${currConfig.displayName}`;
            }

            document.getElementById('totalWeight').textContent = `${totalWeight.toFixed(0)}g`;
            document.getElementById('totalVolumes').textContent = totalVolumes;

        }

        function closeParcelModal() {
            document.getElementById('parcelModal').classList.add('hidden');
        }

        function closeModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeParcelModal();
            }
        }

        // Update toggleImportSection to work like toggleParcelSection
        function toggleImportSection() {
            const importSection = document.getElementById('importSection');
            const importHamburger = document.getElementById('importHamburger');
            const pageContainer = document.getElementById('container');

            const isOpen = importSection.style.display !== 'none' && importSection.style.transform === 'translateX(0px)';

            if (isOpen) {
                // Close import section
                importSection.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    importSection.style.display = 'none';
                }, 300);
                pageContainer.classList.remove('import-section-active');
                importHamburger.classList.remove('active');
            } else {
                // Open import section
                importSection.style.display = 'block';
                setTimeout(() => {
                    importSection.style.transform = 'translateX(0px)';
                }, 10);
                pageContainer.classList.add('import-section-active');
                importHamburger.classList.add('active');
            }
        }

        // Helper function to clear HTML input
        function clearHTMLInput() {
            document.getElementById('htmlInput').value = '';
        }

        // Update closeAllPanels to handle import section
        function closeAllPanels() {
            // Close floating panels
            document.querySelectorAll('.floating-panel').forEach(panel => {
                panel.classList.remove('show');
            });

            // Close modals
            const modals = ['formatsModal', 'tagManagerModal', 'parcelModal', 'editParcelModal', 'activityModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    modal.classList.add('hidden');
                }
            });

            // Destroy activity modal
            const activityModal = document.getElementById('activityModal');
            if (activityModal) {
                activityModal.remove();
            }

            // Close import section if open
            const importSection = document.getElementById('importSection');
            const importHamburger = document.getElementById('importHamburger');
            const pageContainer = document.getElementById('container');
            if (importSection && importSection.style.transform === 'translateX(0px)') {
                importSection.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    importSection.style.display = 'none';
                }, 300);
                pageContainer.classList.remove('import-section-active');
                importHamburger.classList.remove('active');
            }

            // Remove active state from modal/panel buttons (not persistent ones)
            const persistentButtons = ['filtersHamburger', 'parcelCalcHamburger', 'batchModeHamburger', 'importHamburger'];
            document.querySelectorAll('.hamburger-btn').forEach(btn => {
                if (!persistentButtons.includes(btn.id)) {
                    btn.classList.remove('active');
                }
            });
        }

        // Helper function to clear HTML input
        function clearHTMLInput() {
            document.getElementById('htmlInput').value = '';
        }

        function toggleInstructionsSection() {
            const instructionsSection = document.getElementById('instructionsSection');
            instructionsSection.classList.toggle('hidden');
        }


        function toggleParcelSection() {
            const parcelSection = document.getElementById('parcelSection');
            const parcelHamburger = document.getElementById('parcelCalcHamburger');
            const pageContainer = document.getElementById('container');

            // Toggle the parcel section visibility
            parcelSection.classList.toggle('hidden');
            pageContainer.classList.toggle('parcel-section-active');

            // Toggle the button active state
            parcelHamburger.classList.toggle('active');
        }

        function toggleFormatsSection() {
            toggleFloatingPanel('formatsModal', document.getElementById('formatsHamburger'), true);
        }
        function toggleFiltersSection() {
            const filtersSection = document.getElementById('filtersSection');
            filtersSection.classList.toggle('hidden');
            const filtersHamburger = document.getElementById('filtersHamburger');
            filtersHamburger.classList.toggle('active');
            // const filtersPanel = document.getElementById('filtersPanel');
            // filtersPanel.classList.toggle('parcel-section-active');
        }
        function toggleHeaderSection() {
            const headerSection = document.getElementById('headerSection');
            headerSection.classList.toggle('hidden');
            const headerHamburger = document.getElementById('headerHamburger');
            headerHamburger.classList.toggle('active');
        }

        function saveFormats() {
            const rows = document.querySelectorAll('#formatsTable tbody tr');
            const newFormats = {};
            const oldFormats = { ...bookFormats }; // Keep track of old formats

            // First, collect all the new formats
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const width = parseFloat(inputs[1].value) || 0;
                const height = parseFloat(inputs[2].value) || 0;
                const thickness = parseFloat(inputs[3].value) || 0;
                const weight = parseFloat(inputs[4].value) || 0;

                if (name && width > 0 && height > 0 && thickness > 0 && weight > 0) {
                    newFormats[name] = { width, height, thickness, weight };
                }
            });

            // Find renamed formats by comparing dimensions
            const formatMapping = {};
            Object.entries(oldFormats).forEach(([oldName, oldFormat]) => {
                if (!newFormats[oldName]) {
                    // Format name changed or deleted, try to find it by matching dimensions
                    const matchingFormat = Object.entries(newFormats).find(([newName, newFormat]) =>
                        newFormat.width === oldFormat.width &&
                        newFormat.height === oldFormat.height &&
                        newFormat.thickness === oldFormat.thickness &&
                        newFormat.weight === oldFormat.weight
                    );

                    if (matchingFormat) {
                        // This is a rename
                        formatMapping[oldName] = matchingFormat[0];
                    } else {
                        // This format was deleted
                        formatMapping[oldName] = null;
                    }
                }
            });

            // Update all orders with the new format names
            let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            let defaultFormat = Object.keys(newFormats)[0] || 'Default';

            allOrders.forEach(order => {
                if (formatMapping.hasOwnProperty(order.bookFormat)) {
                    if (formatMapping[order.bookFormat]) {
                        // Renamed format
                        order.bookFormat = formatMapping[order.bookFormat];
                    } else {
                        // Deleted format - set to default
                        order.bookFormat = defaultFormat;
                    }
                }
                // If format still doesn't exist in newFormats, set to default
                if (!newFormats[order.bookFormat]) {
                    order.bookFormat = defaultFormat;
                }
            });

            // Save everything
            bookFormats = newFormats;
            localStorage.setItem('bookFormats', JSON.stringify(bookFormats));
            localStorage.setItem('orders', JSON.stringify(allOrders));

            // Update the currently displayed orders
            orders = allOrders.filter(order => {
                // Reapply any current filters
                const search = document.getElementById('searchInput').value.toLowerCase();
                const matchesSearch = !search ||
                    order.orderId.toLowerCase().includes(search) ||
                    order.title.toLowerCase().includes(search);
                // Add other filter conditions as needed
                return matchesSearch;
            });

            toggleFormatsSection();
            renderFormatDropdown(); // Update the format filter dropdown
            renderView(); // Refresh dropdowns
            updateTotals(); // Recalculate weights
            renderParcels(); // Update parcel calculations
            updateParcelTabStats();
            alert('Format changes saved successfully!');

            // Alert user about any changes
            if (Object.keys(formatMapping).length > 0) {
                const renames = Object.entries(formatMapping)
                    .filter(([old, new_]) => new_)
                    .map(([old, new_]) => `"${old}" → "${new_}"`);
                const deletions = Object.entries(formatMapping)
                    .filter(([old, new_]) => !new_)
                    .map(([old]) => old);

                let message = 'Format changes saved successfully!\n';
                if (renames.length > 0) {
                    message += `\nRenamed: ${renames.join(', ')}`;
                }
                if (deletions.length > 0) {
                    message += `\nDeleted: "${deletions.join('", "')}". Orders using these formats were set to "${defaultFormat}".`;
                }
                alert(message);
            } else {
                alert('Format changes saved successfully!');
            }
        }

        function showActivityLog() {
            const btn = document.getElementById('activityHamburger');
            toggleFloatingPanel('activityModal', btn, true);
        }

        function createActivityModal() {
            const modal = document.createElement('div');
            modal.id = 'activityModal';
            modal.className = 'modal hidden';
            modal.onclick = (e) => { if (e.target === modal) closeAllPanels(); };
            modal.innerHTML = `
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Import Activity Log</h3>
                <button class="btn btn-secondary" onclick="closeAllPanels()">×</button>
            </div>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-secondary" onclick="clearActivityLog(); closeAllPanels();" style="background: rgb(235, 137, 137); border-color: rgb(235, 137, 137); color: white;">Clear Log</button>
            </div>
            <div id="activityContent">
                <!-- Content will be populated by populateActivityLog() -->
            </div>
        </div>
    `;
            document.body.appendChild(modal);
        }

        // Extract your existing HTML generation into this function:
        function populateActivityLog() {
            const contentDiv = document.getElementById('activityContent');

            contentDiv.innerHTML = activityLog.length === 0 ?
                '<p style="color: #9ca3af; text-align: center; padding: 40px;">No import activity yet</p>' :
                activityLog.map(session => `
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #f9fafb;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 12px;">
                    ${new Date(session.timestamp).toLocaleString()}
                </div>
                
                ${session.newOrders.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #059669;">✅ ${session.newOrders.length} New Orders:</strong>
                        <div style="margin-left: 16px; font-size: 11px;">
                            ${session.newOrders.map(order =>
                    `• #${order.orderId}: ${order.title.substring(0, 40)}${order.title.length > 40 ? '...' : ''}`
                ).join('<br>')}
                        </div>
                    </div>
                ` : ''}
                
                ${session.updatedOrders.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #d97706;">🔄 ${session.updatedOrders.length} Updated Orders:</strong>
                        <div style="margin-left: 16px; font-size: 11px;">
                            ${session.updatedOrders.map(order => `
                                <div style="margin-bottom: 8px;">
                                    <strong>#${order.orderId}:</strong> ${order.title.substring(0, 30)}${order.title.length > 30 ? '...' : ''}
                                    <div style="margin-left: 12px; color: #6b7280;">
                                        ${Object.entries(order.changes).map(([field, change]) => {
                    const fieldName = field === 'storageDays' ? 'Storage Days' :
                        field === 'neokyoNotes' ? 'Notes' :
                            field === 'yen' ? 'Yen Price' :
                                field === 'usd' ? 'USD Price' :
                                    field.charAt(0).toUpperCase() + field.slice(1);
                    return `${fieldName}: "${change.from}" → "${change.to}"`;
                }).join('<br>')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${session.unchangedOrders.length > 0 ? `
                    <div>
                        <strong style="color: #6b7280;">📊 ${session.unchangedOrders.length} Unchanged Orders</strong>
                    </div>
                ` : ''}
            </div>
        `).join('');
        }

        // Function to clear activity log
        function clearActivityLog() {
            if (confirm('Clear all import activity history?')) {
                activityLog = [];
                localStorage.removeItem('activityLog');

                // Refresh the content if modal is open
                const contentDiv = document.getElementById('activityContent');
                if (contentDiv) {
                    populateActivityLog();
                }

                alert('Activity log cleared.');
            }
        }


        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL orders and parcels? This cannot be undone. Also, as a peabrain who cleared her own before exporting, I am going to export it for you!! just in case (you have no choice)')) {
                // Clear all data
                exportData();

                orders = [];
                parcels = [];
                activityLog = [];
                bookFormats = { ...defaultFormats }; // Reset to defaults instead of empty
                columnVisibility = { // Reset to defaults
                    image: true, orderId: true, title: true, quantity: true,
                    yen: true, usd: true, created: true, storageDays: true,
                    status: true, neokyoNotes: true, bookFormat: true,
                    volumes: true, parcel: true, tags: true, url: true, actions: true
                };

                // Clear localStorage
                localStorage.removeItem('orders');
                localStorage.removeItem('parcels');
                localStorage.removeItem('activityLog');
                localStorage.removeItem('bookFormats');
                localStorage.removeItem('columnVisibility');

                // Reset UI
                clearFilters();
                renderView();
                renderParcels();
                updateParcelTabStats();
                renderStatusDropdown();
                renderFormatDropdown();
                renderParcelDropdown();
                renderTagsDropdown();
                updateTotals();
                alert('All data has been cleared.');
            }
        }

        function closeFormatsModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeFormatsModal();
            }
        }

        function renderFormatsTable() {
            const formatsTable = document.getElementById('formatsTable');

            formatsTable.innerHTML = `
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Format Name</th>
                    <th>Width (cm)</th>
                    <th>Height (cm)</th>
                    <th>Thickness (cm)</th>
                    <th>Weight (grams)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${Object.entries(bookFormats).map(([name, format]) => `
                    <tr>
                        <td><input type="text" value="${name}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                        <td><input type="number" step="1" value="${format.width}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                        <td><input type="number" step="1" value="${format.height}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                        <td><input type="number" step="1" value="${format.thickness}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                        <td><input type="number" value="${format.weight}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                        <td><button class="btn btn-small btn-secondary" onclick="deleteFormatRow(this)" style="background: rgb(235, 137, 137); border-color: rgb(235, 137, 137); color: white;">Delete</button></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
        }

        function addNewFormat() {
            const tbody = document.querySelector('#formatsTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Format Name" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="1" placeholder="Width" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="1" placeholder="Height" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="1" placeholder="Thickness" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" placeholder="Weight" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><button class="btn btn-small btn-secondary" onclick="deleteFormatRow(this)" style="background: rgb(235, 137, 137); border-color: rgb(235, 137, 137); color: white;">Delete</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function deleteFormatRow(button) {
            if (confirm('Are you sure you want to delete this format?')) {
                button.closest('tr').remove();
            }
        }

        function toggleMultiSelect(type) {
            const multiSelect = document.getElementById(`${type}MultiSelect`);
            const isOpen = multiSelect.classList.contains('open');

            // Close all other multi-selects
            document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));

            // Toggle current one
            if (!isOpen) {
                multiSelect.classList.add('open');
            }
        }





        function getUniqueStatuses() {
            try {
                const allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                const statuses = new Set();

                allOrders.forEach(order => {
                    if (order.status && order.status.trim()) {
                        statuses.add(order.status.trim());
                    }
                });

                return Array.from(statuses).sort();
            } catch (e) {
                console.error('Error getting unique statuses:', e);
                return [];
            }
        }

        function getUniqueTags() {
            const allTags = new Set();
            const allOrders = JSON.parse(localStorage.getItem('orders') || '[]');

            allOrders.forEach(order => {
                if (order.tags) {
                    order.tags.split(' ').filter(tag => tag.trim()).forEach(tag => {
                        allTags.add(tag.trim());
                    });
                }
            });

            return Array.from(allTags).sort();
        }



        // Close multi-selects when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));
            }
        });

        function resetToDefaults() {
            if (confirm('This will delete ALL the formats you have created except for manga (sorry).')) {
                bookFormats = { ...defaultFormats };
                renderFormatsTable();
                renderFormatDropdown(); // Update filter dropdown with reset formats
            }
        }

        function saveParcel() {
            const name = document.getElementById('parcelName').value || `Parcel ${parcels.length + 1}`;
            const length = parseFloat(document.getElementById('parcelLength').value) || 60;
            const width = parseFloat(document.getElementById('parcelWidth').value) || 45;
            const height = parseFloat(document.getElementById('parcelHeight').value) || 62;
            const padding = parseFloat(document.getElementById('parcelPadding').value) || 20;
            const boxWeight = parseFloat(document.getElementById('parcelBoxWeight').value) || 2000;

            // Get shipping info
            const shippingMethod = document.getElementById('parcelShippingMethod').value || '';
            const shippingCost = parseFloat(document.getElementById('parcelShippingCost').value) || 0;
            const shipDate = document.getElementById('parcelShipDate').value || '';
            const arrivalDate = document.getElementById('parcelArrivalDate').value || '';
            const actualWeight = parseFloat(document.getElementById('parcelActualWeight').value) || 0;
            const declaredValue = parseFloat(document.getElementById('parcelDeclaredValue').value) || 0;
            const trackingNumber = document.getElementById('parcelTrackingNumber').value || '';
            const trackingURL = document.getElementById('parcelTrackingURL').value || '';


            const parcel = {
                id: Date.now().toString(),
                name,
                length,
                width,
                height,
                padding,
                boxWeight,
                status: currentParcelTab, // 'planning' or 'shipped'
                shippingMethod,
                shippingCost,
                actualWeight,
                declaredValue,
                shipDate,
                arrivalDate,
                trackingNumber,
                trackingURL
            };

            parcels.push(parcel);
            localStorage.setItem('parcels', JSON.stringify(parcels));

            closeParcelModal();
            renderParcels();
            updateParcelTabStats();
            renderParcelDropdown();
            renderView();
        }

        function deleteParcel(parcelId) {
            if (confirm('Are you sure you want to delete this parcel?')) {
                parcels = parcels.filter(p => p.id !== parcelId);
                localStorage.setItem('parcels', JSON.stringify(parcels));

                // Remove parcel assignment from ALL orders in localStorage, not just filtered ones
                let allOrders = [];
                try {
                    allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                } catch (e) {
                    console.error('Error loading orders:', e);
                    allOrders = [];
                }

                // Update all orders
                allOrders.forEach(order => {
                    if (order.parcel === parcelId) {
                        order.parcel = '';
                    }
                });

                // Save back to localStorage
                localStorage.setItem('orders', JSON.stringify(allOrders));

                // Update the currently displayed orders array as well
                orders.forEach(order => {
                    if (order.parcel === parcelId) {
                        order.parcel = '';
                    }
                });

                renderParcels();
                updateParcelTabStats();
                renderView();
            }
        }

        function editParcel(parcelId) {
            const parcel = parcels.find(p => p.id === parcelId);
            if (!parcel) return;

            currentEditingParcel = parcelId;

            // Populate basic fields
            document.getElementById('editParcelName').value = parcel.name;
            document.getElementById('editParcelLength').value = parcel.length;
            document.getElementById('editParcelWidth').value = parcel.width;
            document.getElementById('editParcelHeight').value = parcel.height;
            document.getElementById('editParcelPadding').value = parcel.padding;
            document.getElementById('editParcelBoxWeight').value = parcel.boxWeight;

            // Populate shipping fields
            document.getElementById('editParcelShippingMethod').value = parcel.shippingMethod || '';
            document.getElementById('editParcelShippingCost').value = parcel.shippingCost || '';
            document.getElementById('editParcelShipDate').value = parcel.shipDate || '';
            document.getElementById('editParcelArrivalDate').value = parcel.arrivalDate || '';
            document.getElementById('editParcelActualWeight').value = parcel.actualWeight || '';
            document.getElementById('editParcelDeclaredValue').value = parcel.declaredValue || '';
            document.getElementById('editParcelTrackingNumber').value = parcel.trackingNumber || '';
            document.getElementById('editParcelTrackingURL').value = parcel.trackingURL || '';

            // Show edit modal
            document.getElementById('editParcelModal').classList.remove('hidden');
        }

        function saveParcelEdit() {
            if (!currentEditingParcel) return;

            const parcelIndex = parcels.findIndex(p => p.id === currentEditingParcel);
            if (parcelIndex === -1) return;

            const oldName = parcels[parcelIndex].name;

            // Get basic info
            const newName = document.getElementById('editParcelName').value || `Parcel ${parcels.length}`;
            const length = parseFloat(document.getElementById('editParcelLength').value) || 12;
            const width = parseFloat(document.getElementById('editParcelWidth').value) || 8;
            const height = parseFloat(document.getElementById('editParcelHeight').value) || 6;
            const padding = parseFloat(document.getElementById('editParcelPadding').value) || 0.5;
            const boxWeight = parseFloat(document.getElementById('editParcelBoxWeight').value) || 100;

            // Get shipping info
            const shippingMethod = document.getElementById('editParcelShippingMethod').value || '';
            const shippingCost = parseFloat(document.getElementById('editParcelShippingCost').value) || 0;
            const shipDate = document.getElementById('editParcelShipDate').value || '';
            const arrivalDate = document.getElementById('editParcelArrivalDate').value || '';
            const actualWeight = parseFloat(document.getElementById('editParcelActualWeight').value) || 0;
            const declaredValue = parseFloat(document.getElementById('editParcelDeclaredValue').value) || 0;
            const trackingNumber = document.getElementById('editParcelTrackingNumber').value || '';
            const trackingURL = document.getElementById('editParcelTrackingURL').value || '';

            // Update parcel
            parcels[parcelIndex] = {
                ...parcels[parcelIndex],
                name: newName,
                length,
                width,
                height,
                padding,
                boxWeight,
                shippingMethod,
                shippingCost,
                actualWeight,
                declaredValue,
                shipDate,
                arrivalDate,
                trackingNumber,
                trackingURL
            };

            localStorage.setItem('parcels', JSON.stringify(parcels));

            closeEditParcelModal();
            renderParcels();
            updateParcelTabStats();
            renderView();

            alert(`Parcel "${newName}" updated successfully!`);
        }

        function renderParcels() {
            const parcelGrid = document.getElementById('parcelGrid');

            // Filter parcels by current tab
            const filteredParcels = parcels.filter(parcel => parcel.status === currentParcelTab);

            // Always get ALL orders from localStorage, not the filtered ones
            let allOrders = [];
            try {
                allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            } catch (e) {
                console.error('Error loading orders:', e);
                allOrders = [];
            }

            if (filteredParcels.length === 0) {
                parcelGrid.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #6b7280; font-style: italic;">
                ${currentParcelTab === 'planning' ?
                        'No parcels being planned yet. Click "Add Parcel" to get started!' :
                        'No shipped parcels yet. Mark parcels as shipped to see them here.'}
            </div>
        `;
                return;
            }

            parcelGrid.innerHTML = filteredParcels.map(parcel => {
                const assignedOrders = allOrders.filter(order => order.parcel === parcel.id);

                let totalWeight = parcel.boxWeight;
                let totalVolume = 0;
                let totalOrderVolumes = 0;
                let totalValueYen = 0;
                let totalValueUSD = 0;

                assignedOrders.forEach(order => {
                    const defaultFormatName = Object.keys(bookFormats)[0] || 'Default';
                    const defaultFormat = bookFormats[defaultFormatName] || {
                        width: 10.0, height: 10.0, thickness: 10.0, weight: 10.0
                    };

                    const format = bookFormats[order.bookFormat] || defaultFormat;
                    const volumes = order.volumes || 1;
                    const itemWeight = format.weight * volumes * order.quantity;
                    const itemVolume = format.width * format.height * (format.thickness * volumes) * order.quantity;

                    totalWeight += itemWeight;
                    totalVolume += itemVolume;
                    totalOrderVolumes += volumes * order.quantity;
                    totalValueYen += order.yen || 0;
                    totalValueUSD += order.usd || 0;
                });


                if (currentParcelTab === 'shipped' && parcel.actualWeight && parcel.actualWeight > 0) {
                    totalWeight = parcel.actualWeight; // Use actual weight for items
                }

                const availableLength = parcel.length - (parcel.padding * 2);
                const availableWidth = parcel.width - (parcel.padding * 2);
                const availableHeight = parcel.height - (parcel.padding * 2);
                const maxVolume = availableLength * availableWidth * availableHeight;

                const spaceUsed = (totalVolume / maxVolume * 100).toFixed(1);
                const spaceRemaining = Math.max(0, maxVolume - totalVolume).toFixed(2);

                // Calculate additional stats for shipped parcels
                let additionalStats = '';
                if (currentParcelTab === 'shipped') {
                    const perItemWithShip = totalOrderVolumes > 0 ? ((totalValueUSD + (parcel.shippingCost || 0)) / totalOrderVolumes) : 0;
                    const costPerKgWithShip = totalWeight > 0 ? ((totalValueUSD + (parcel.shippingCost || 0)) / (totalWeight / 1000)) : 0;

                    const currConfig = getCurrentCurrencyConfig(); // why do they do this i might as well just rename the function to currConfig instead of declaring it again but ig not

                    additionalStats = `
        <div class="stat">
            <div class="stat-value">${currConfig.symbol}${perItemWithShip.toFixed(2)}</div>
            <div class="stat-label">Per Item + Ship</div>
        </div>
        <div class="stat">
            <div class="stat-value">${currConfig.symbol}${costPerKgWithShip.toFixed(2)}</div>
            <div class="stat-label">Cost/kg + Ship</div>
        </div>
    `;
                } else if (currentParcelTab === 'planning') {
                    const estimatedShipping = (parcel.shippingCost && parcel.shippingCost > 0) ? parcel.shippingCost : 10;
                    const perItemWithEstShip = totalOrderVolumes > 0 ? ((totalValueUSD + estimatedShipping) / totalOrderVolumes) : 0;
                    const perItem = totalOrderVolumes > 0 ? (totalValueUSD / totalOrderVolumes) : 0;

                    const currConfig = getCurrentCurrencyConfig();

                    additionalStats = `
        <div class="stat">
            <div class="stat-value">${currConfig.symbol}${perItemWithEstShip.toFixed(2)}</div>
            <div class="stat-label">Per Item + Ship</div>
        </div>
        <div class="stat">
            <div class="stat-value">${currConfig.symbol}${perItem.toFixed(2)}</div>
            <div class="stat-label">Per Item</div>
        </div>
    `;
                }

                return `
            <div class="parcel-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3>${getClickableParcelName(parcel)}</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-small btn-secondary" onclick="editParcel('${parcel.id}')">Edit</button>
                        ${currentParcelTab === 'planning' ?
                        `<button class="btn btn-small" onclick="markAsShipped('${parcel.id}')" style="background: rgb(84 151 221);">Ship</button>` :
                        `<button class="btn btn-small btn-secondary" onclick="markAsPlanning('${parcel.id}')">Unship</button>`
                    }
                        <button class="btn btn-small btn-secondary" onclick="deleteParcel('${parcel.id}')" style="background: rgb(235, 137, 137); border-color: rgb(235, 137, 137); color: white;">Delete</button>
                    </div>
                </div>
                <div style="font-size: 12px; color: rgb(106, 92, 201); margin-bottom: 8px;">
                    Dimensions: ${parcel.length}cm × ${parcel.width}cm × ${parcel.height}cm<br>
                    ${currentParcelTab === 'shipped' && parcel.shippingMethod ? `<br>Shipped via: ${parcel.shippingMethod}` : ''} ($${(parcel.shippingCost || 0).toFixed(2)})
                    ${currentParcelTab === 'shipped' && parcel.trackingNumber ? `<br>Tracking: <a href="${parcel.trackingURL}" target="_blank" style="color: rgb(84, 151, 221); text-decoration: none; ">${parcel.trackingNumber}` : ''}</a>
                </div>
                <div class="parcel-stats">
                    <div class="stat">
                        <div class="stat-value">${assignedOrders.length}</div>
                        <div class="stat-label">Orders</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${totalOrderVolumes}</div>
                        <div class="stat-label">Items</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${totalWeight.toFixed(0)}g</div>
                        <div class="stat-label">${(currentParcelTab === 'shipped' && parcel.actualWeight && parcel.actualWeight > 0) ? 'Actual Weight' : 'Weight'}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${spaceUsed}%</div>
                        <div class="stat-label">Space Used</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">$${totalValueUSD.toFixed(2)}</div>
                        <div class="stat-label">Total Cost</div>
                    </div>
                </div>
                <div class="parcel-stats">
                    <style>.stat div {display:inline}</style>
                    ${additionalStats}
                </div>

                <div style="margin-top: 12px; max-height: 120px; overflow-y: auto;">
                    ${assignedOrders.map(order => `
                        <div style="font-size: 11px; padding: 4px; background: rgba(255,255,255,0.7); margin: 2px 0; border-radius: 4px;">
                            #${order.orderId} - ${order.title.substring(0, 30)}${order.title.length > 30 ? '...' : ''} (${(order.volumes || 1) * order.quantity} total)
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
            }).join('');
        }

        // Helper function to create clickable parcel names with tracking links
        // idk why it made a function specifically for this but okay sure ;-;7
        function getClickableParcelName(parcel) {
            if (parcel.trackingURL && parcel.trackingURL.trim()) {
                return `<a href="${parcel.trackingURL}" target="_blank" style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 6px;" title="Track this parcel">
            ${parcel.name}
            <span style="font-size: 12px; opacity: 0.7;">🔗</span>
        </a>`;
            }
            return parcel.name;
        }

        // Helper function to calculate shipping days
        function calculateShipDays(shipDate, arrivalDate) {
            if (!shipDate || !arrivalDate) return -1;

            const ship = new Date(shipDate);
            const arrival = new Date(arrivalDate);
            const diffTime = arrival - ship;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays > 0 ? diffDays : -1;
        }

        // Mark parcel as shipped
        function markAsShipped(parcelId) {
            const parcel = parcels.find(p => p.id === parcelId);
            if (!parcel) return;

            parcel.status = 'shipped';
            localStorage.setItem('parcels', JSON.stringify(parcels));

            // Switch to shipped tab to show the result
            switchParcelTab('shipped');

            // Show hybrid toast with option to add details
            showShippingDetailsToast(parcelId, parcel.name);
        }

        // Mark parcel back as planning (unship)
        function markAsPlanning(parcelId) {
            const parcel = parcels.find(p => p.id === parcelId);
            if (!parcel) return;

            // Clear shipping data
            parcel.status = 'planning';
            // parcel.shippingMethod = '';
            // parcel.shippingCost = 0;
            // parcel.actualWeight = 0;
            // parcel.actualDimensions = { length: 0, width: 0, height: 0 };
            // parcel.shipDate = '';
            // parcel.arrivalDate = '';
            // parcel.trackingNumber = '';

            localStorage.setItem('parcels', JSON.stringify(parcels));
            switchParcelTab('planning');
        }


        function showShippingDetailsToast(parcelId, parcelName) {
            // Remove any existing toast
            const existingToast = document.getElementById('shipping-toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create toast
            const toast = document.createElement('div');
            toast.id = 'shipping-toast';
            toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 18px;
        padding: 16px 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        z-index: 1010;
        min-width: 294px;
        background:rgb(84 151 221);color:white;
    `;

            toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
        font-weight: 800;">
            ${parcelName} marked as shipped!
        </div>
        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 12px;color:white">
            Add shipping details while it's fresh?
        </div>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="openEditParcelFromToast('${parcelId}')" style="
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                transition: all 0.2s;background:rgba(255,255,255,0.9);
            " onmouseover="this.style.background='white'" onmouseout="this.style.background='rgba(255,255,255,0.9)'">
                Add Details
            </button>
            <button onclick="dismissShippingToast()" class="btn" style="
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 11px;
                font-weight: 600;
                background: rgba(255,255,255,0.2);
                transition: all 0.2s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                Maybe Later
            </button>
        </div>
    `;

            document.body.appendChild(toast);

            // Auto-dismiss after 8 seconds
            setTimeout(() => {
                dismissShippingToast();
            }, 8000);
        }

        function openEditParcelFromToast(parcelId) {
            dismissShippingToast();
            editParcel(parcelId);
        }

        function dismissShippingToast() {
            const toast = document.getElementById('shipping-toast');
            if (toast) {
                toast.style.animation = 'slideOutToRight 0.3s ease';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }


        function toggleViewDirect() {
            const icon = document.getElementById('viewToggleIcon');
            const tooltip = document.getElementById('viewToggleTooltip');
            const columnBtn = document.getElementById('columnToggleHamburger');
            const gridSortControls = document.getElementById('gridSortControls');

            if (currentView === 'grid') {
                // Switch to table view
                currentView = 'table';
                icon.textContent = '📇';
                tooltip.textContent = 'Grid View';
                columnBtn.style.display = 'flex';
                if (gridSortControls) gridSortControls.style.display = 'none'; // Hide grid sort
            } else {
                // Switch to grid view
                currentView = 'grid';
                icon.textContent = '📋';
                tooltip.textContent = 'Table View';
                columnBtn.style.display = 'none';
                if (gridSortControls) gridSortControls.style.display = 'flex'; // Show grid sort
            }

            renderView();
        }

        function createColumnPanel() {
            // Check if panel already exists
            if (document.getElementById('columnPanel')) return;

            const panel = document.createElement('div');
            panel.id = 'columnPanel';
            panel.className = 'floating-panel';
            panel.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Show/Hide Columns</strong>
            <button class="btn btn-small btn-secondary" onclick="closeAllPanels()">×</button>
        </div>
        <div class="column-grid" style="margin-top: 12px;">
            <div class="column-item">
                <input type="checkbox" id="col-image" checked onchange="toggleColumn('image')">
                <label for="col-image">Image</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-orderId" checked onchange="toggleColumn('orderId')">
                <label for="col-orderId">Order #</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-title" checked onchange="toggleColumn('title')">
                <label for="col-title">Title</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-quantity" checked onchange="toggleColumn('quantity')">
                <label for="col-quantity">Quantity</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-yen" checked onchange="toggleColumn('yen')">
                <label for="col-yen">Yen</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-usd" checked onchange="toggleColumn('usd')">
                <label for="col-usd">USD</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-created" checked onchange="toggleColumn('created')">
                <label for="col-created">Created</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-storageDays" checked onchange="toggleColumn('storageDays')">
                <label for="col-storageDays">Storage Days</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')">
                <label for="col-status">Status</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-neokyoNotes" checked onchange="toggleColumn('neokyoNotes')">
                <label for="col-neokyoNotes">Neokyo Notes</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-bookFormat" checked onchange="toggleColumn('bookFormat')">
                <label for="col-bookFormat">Format</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-volumes" checked onchange="toggleColumn('volumes')">
                <label for="col-volumes">Items</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-parcel" checked onchange="toggleColumn('parcel')">
                <label for="col-parcel">Parcel</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-tags" checked onchange="toggleColumn('tags')">
                <label for="col-tags">Tags</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-url" checked onchange="toggleColumn('url')">
                <label for="col-url">URL</label>
            </div>
            <div class="column-item">
                <input type="checkbox" id="col-actions" checked onchange="toggleColumn('actions')">
                <label for="col-actions">Actions</label>
            </div>
        </div>
        <div style="margin-top: 12px;">
            <button class="btn btn-secondary btn-small" onclick="showAllColumns()">Show All</button>
            <button class="btn btn-secondary btn-small" onclick="hideAllColumns()">Hide All</button>
        </div>
    `;

            document.body.appendChild(panel);
        }


        function exportData() {
            // Get ALL orders from localStorage, not just filtered ones
            let allOrders = [];
            try {
                allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            } catch (e) {
                console.error('Error loading orders:', e);
                allOrders = [];
            }

            const data = {
                orders: allOrders,  // Export ALL orders, not just filtered ones
                parcels: parcels,
                bookFormats: bookFormats,
                customHeaderText: customHeaderText,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order_tracker_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {

            // Clear all data
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Import orders if present
                    if (data.orders && Array.isArray(data.orders)) {
                        // Save directly to localStorage, don't use the filtered array
                        localStorage.setItem('orders', JSON.stringify(data.orders));
                    }

                    // Import parcels if present
                    if (data.parcels && Array.isArray(data.parcels)) {
                        parcels = data.parcels;
                        localStorage.setItem('parcels', JSON.stringify(parcels));
                    }

                    // Import book formats if present
                    if (data.bookFormats && typeof data.bookFormats === 'object') {
                        bookFormats = data.bookFormats;
                        localStorage.setItem('bookFormats', JSON.stringify(bookFormats));
                        renderFormatDropdown();
                    }

                    // Import custom header if present
                    if (data.customHeaderText) {
                        customHeaderText = data.customHeaderText;
                        localStorage.setItem('customHeaderText', customHeaderText);
                        document.getElementById('header').textContent = customHeaderText;
                    }

                    // Clear filters to show all imported data
                    clearFilters(); // This will reload orders from localStorage and show everything
                    renderStatusDropdown(); // Initialize status dropdown
                    renderTagsDropdown(); // Initialize tags dropdown
                    renderParcelDropdown(); // Initialize parcel dropdown
                    renderView();
                    renderParcels();
                    updateParcelTabStats();
                    updateTotals();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('editable') && e.key === 'Enter') {
                e.target.blur();
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const filtersPanel = document.querySelector('#header');
            const filtersTitle = document.querySelector('#filtersTitle');

            const observer = new IntersectionObserver(
                ([entry]) => {
                    if (entry.intersectionRatio < 1) {
                        // Sticky kicked in
                        filtersTitle.textContent = customHeaderText;
                    } else {
                        // Back to normal flow
                        filtersTitle.textContent = 'Filters /';
                    }
                },
                {
                    threshold: [1.0],
                    rootMargin: '0px 0px 0px 0px',
                }
            );

            observer.observe(filtersPanel);
        });


        if (currentView === 'table') {
            document.getElementById('viewToggleIcon').textContent = '📇';
            document.getElementById('viewToggleTooltip').textContent = 'Grid View';
            document.getElementById('columnToggleHamburger').style.display = 'flex';
        }

        function validateOrderFormats() {
            let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            const defaultFormat = Object.keys(bookFormats)[0] || 'Default';
            let fixedCount = 0;

            allOrders.forEach(order => {
                if (!bookFormats[order.bookFormat]) {
                    order.bookFormat = defaultFormat;
                    fixedCount++;
                }
            });

            if (fixedCount > 0) {
                localStorage.setItem('orders', JSON.stringify(allOrders));
                // console.log(`Fixed ${fixedCount} orders with invalid formats`);
            }

            return fixedCount;
        }

        // Call this on page load or after importing data
        document.addEventListener('DOMContentLoaded', function () {
            validateOrderFormats();
        });


        function renderTagManagerContent() {
            const uniqueTags = getUniqueTags();
            const tagContent = document.getElementById('tagManagerContent');

            tagContent.innerHTML = `
        <div style="margin-bottom: 20px;">
            <p style="color: #6b7280; margin-bottom: 12px;">Found ${uniqueTags.length} unique tags across all orders:</p>
            ${uniqueTags.length > 0 ? `
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${uniqueTags.map(tag => `
                        <div class="tag" style="display: flex; align-items: center; gap: 6px; background: rgba(167, 139, 250, 0.1); padding: 6px 12px; border-radius: 16px;">
                            <span style="color: #6b5b95;">${tag}</span>
                            <span class="remove" onclick="deleteTagGlobally('${tag}')" style="cursor: pointer; color: #dc2626; font-weight: bold;">&times;</span>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="if(confirm('Delete ALL tags from ALL orders?')) { deleteAllTags(); }" style="background: rgb(235, 137, 137); border-color: rgb(235, 137, 137); color: white;">
                        Delete All Tags
                    </button>
                </div>
            ` : `
                <p style="color: #9ca3af; font-style: italic;">No tags found. Add tags to your orders to see them here.</p>
            `}
        </div>
        
        <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px;">
            <h4 style="margin-bottom: 12px;">Tag Statistics</h4>
            ${uniqueTags.length > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    ${uniqueTags.map(tag => {
                const count = orders.filter(order =>
                    order.tags && order.tags.split(' ').includes(tag)
                ).length;
                return `
                            <div style="background: #f9fafb; padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between;">
                                <span>${tag}</span>
                                <span style="color: #6b5b95; font-weight: 600;">${count} orders</span>
                            </div>
                        `;
            }).join('')}
                </div>
            ` : ''}
        </div>
    `;
        }

        function deleteTagGlobally(tagToDelete) {
            if (confirm(`Delete tag "${tagToDelete}" from all orders?`)) {
                let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                allOrders.forEach(order => {
                    if (order.tags) {
                        const tags = order.tags.split(' ').filter(tag => tag.trim() && tag !== tagToDelete);
                        order.tags = tags.join(' ');
                    }
                });
                localStorage.setItem('orders', JSON.stringify(allOrders));
                orders = allOrders;
                renderView();
                renderTagsDropdown();
                renderTagManagerContent(); // Refresh the modal content
                alert(`Tag "${tagToDelete}" removed from all orders.`);
            }
        }

        function deleteAllTags() {
            let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            allOrders.forEach(order => {
                order.tags = '';
            });
            localStorage.setItem('orders', JSON.stringify(allOrders));
            orders = allOrders;
            renderView();
            renderTagsDropdown();
            renderTagManagerContent();
            alert('All tags have been removed from all orders.');
        }

        function makeEditable(element) {
            if (element.isContentEditable) return; // Already editing

            element.contentEditable = true;
            element.classList.add('editing');
            element.focus();

            // Select all text
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function makeHeaderEditable() {
            const header = document.getElementById('header');
            makeEditable(header);

            // Add header-specific save logic
            const saveHeaderEdit = () => {
                customHeaderText = header.textContent.trim() || 'Neo_ Order Tracker';
                localStorage.setItem('customHeaderText', customHeaderText);
                header.textContent = customHeaderText; // Clean up any HTML that might have been pasted
            };

            // Handle Enter key
            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    header.blur(); // This will trigger the blur event
                }
                if (e.key === 'Escape') {
                    header.textContent = customHeaderText; // Reset to original
                    header.contentEditable = false;
                    header.classList.remove('editing');
                }
            };

            // Handle blur (when user clicks away or presses Enter)
            const handleBlur = () => {
                saveHeaderEdit();
                header.removeEventListener('keydown', handleKeydown);
                header.removeEventListener('blur', handleBlur);
            };

            header.addEventListener('keydown', handleKeydown);
            header.addEventListener('blur', handleBlur);
        }

        function renderTagsUI(orderId, tagsString) {
            const tags = tagsString ? tagsString.split(' ').filter(t => t.trim()) : [];

            return `
        <div class="tags-container" data-order-id="${orderId}">
            ${tags.map(tag => `
                <span class="tag-item" onclick="editTagNew(this, '${orderId}', '${tag}'); event.stopPropagation();">
                    ${tag}
                    <div class="tag-remove-invisible" onclick="removeTagNew(event, '${orderId}', '${tag}'); event.stopPropagation();">
                        &times;</div>
                    <span class="tag-remove" onclick="removeTagNew(event, '${orderId}', '${tag}');">&times;</span>
                </span>
            `).join('')}
            
            <!--- UNUSED - Dummy tag now main add tag bc btn couldnt create new input element in table somethingsomething dom but my jank idea worked (haha yes)
                <button class="add-tag-btn" onclick="activateDummyTag('${orderId}'); event.stopPropagation();" type="button">
                 <span>+</span> Add Tag
            </button> -->
            
            <!-- yeehaw -->
            <span class="dummy-tag" id="dummy-tag-${orderId}" onclick="editTagNew(this, '${orderId}', ''); event.stopPropagation();">
                + 
            </span>
        </div>
    `;
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap');

        * {
            font-family: "Manrope", sans-serif;
            font-weight: 500;
        }
    </style>
    <style>
        .btn,
        button {
            padding: 6px 12px;
            font-weight: 600 !important
        }

        .parcel-header h2,
        .header h1 {
            font-weight: 800 !important
        }

        .btn,
        .view-toggle.active {
            background: rgb(143 134 205);
        }

        .view-toggle {
            border: none;
        }

        .filter-group label {
            font-weight: 600
        }

        .btn-secondary {
            background: rgba(244, 242, 254, 1);
            border: 0px solid rgba(153, 145, 216, 1);
        }

        .table-view th {
            font-size: 11px !important
        }

        .grid-view {
            grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
            gap: 15px
        }

        input,
        select,
        .details span {
            font-size: 10px !important;
            border: 0;
            padding: 3px;
            color: #374151
        }

        .details span {
            font-weight: 800
        }

        .neokyo-note {
            color: #dc2626;
            background: #fef2f2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px !important;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 11px !important;
        }

        .multi-select-dropdown {
            margin-top: 5px
        }

        .multi-select-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 11px;
            font-size: 12px !important;
            position: relative
        }

        .multi-select-placeholder {
            font-size: 11px !important
        }

        #formatTags .multi-select-tag,
        #statusTags .multi-select-tag {
            font-size: 11px !important
        }

        .detail-val {
            font-weight: 400 !important
        }

        .multi-select-tag {
            padding: 0px 4px;
            font-size: 11px
        }

        .multi-select-trigger {
            padding: 8px 12px
        }


        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 0px;
            padding: 0px;
            flex-wrap: wrap;
        }

        #minPrice,
        #maxPrice {
            max-width: 100px !important
        }

        .parcel-header h3 {
            font-weight: 600
        }

        .parcel-card {
            border: 1px solid #e5e7eb;
        }

        .parcel-card div {
            color: #374151 !important
        }

        .btn-instructions {
            background: rgb(84 151 221);
        }

        .parcel-stats {
            grid-auto-flow: column;
            grid-template-columns: auto
        }

        .parcel-card div {
            font-size: 10px !important;
        }

        .filter-grip {
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            width: 330px;
            /* height: 100vh; */
            background: rgba(255, 255, 255, 0.98);
            border-left: 1px solid #e5e7eb;
            box-shadow: -2px 0 16px rgba(0, 0, 0, 0.07);
            z-index: 999;
            overflow-y: auto;
            padding: 24px 18px 24px 18px;
            transform: translateX(0);
            animation: fadeInRight 0.6s;
            margin-right: 0;
            left: initial;
            max-width: initial;
        }

        .filter-section-active {
            margin-right: 330px;
        }

        .parcel-section-active.filter-grip {
            position: fixed;
            top: initial;
            bottom: 0;
            right: 0;
            width: 330px;
            /* height: 100vh; */
            background: rgba(255, 255, 255, 0.98);
            border-left: 1px solid #e5e7eb;
            box-shadow: -2px 0 16px rgba(0, 0, 0, 0.07);
            z-index: 999;
            overflow-y: auto;
            padding: 24px 18px 24px 18px;
            transform: translateX(0);
            animation: fadeInRight 0.6s;
            margin-right: 0;
            left: initial;
            max-width: initial;
        }

        .tag {
            font-size: 11px !important
        }

        .filter-group {
            display: initial
        }

        .filter-group label {
            margin-right: 3px
        }

        .filter-group * {
            font-size: 11px !important;
        }

        .filter-group input,
        .filter-group .multi-select-trigger {
            padding: 6px 12px
        }

        #formatTags .multi-select-tag,
        #statusTags .multi-select-tag,
        .filter-group input,
        .filter-group select {
            font-size: 11px !important
        }

        #columnControls {
            position: fixed;
            top: initial;
            bottom: 0;
            right: 0;
            width: 330px;
            /* height: 100vh; */
            background: rgba(255, 255, 255, 0.98);
            border-left: 1px solid #e5e7eb;
            box-shadow: -2px 0 16px rgba(0, 0, 0, 0.07);
            z-index: 999;
            overflow-y: auto;
            padding: 24px 18px 24px 18px;
            transform: translateX(0);
            animation: fadeInRight 0.6s;
            margin-right: 0;
            left: initial;
            max-width: initial;
        }

        /* .parcel-section-active {background:0} */
        .active {
            background: rgb(143 134 205);
            color: white;
        }

        #filtersPanel {
            position: sticky;
            z-index: 998;
            margin: 0;
            top: 0px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7f8f9f7;
            padding-top: 10px;
            padding-bottom: 13px;
            font-size: 12px;
        }

        .filters {
            margin-top: -6px;
            background: rgb(255 255 255 / 92%);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .totals-row {
            margin: 0
        }

        .totals-row * {
            display: inline
        }

        .filters-section .remove {
            display: none
        }

        .filter-mismatch {
            opacity: 0.7;
            outline: 3px dashed #ef4444 !important;
            outline-offset: -3px;
        }

        .multi-select-option.excluded {
            background: #fee2e2;
            color: #dc2626;
        }

        .multi-select-option.excluded label {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .excluded-tag {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
    </style>
    <style>
        .grid-item.batch-mode-active {
            outline: 1px solid #3b82f6 !important;
            background: rgba(59, 130, 246, 0.05) !important;
            border: 1px solid #3b82f6;
            cursor: pointer;
        }

        .grid-item.batch-selectable img,
        .grid-item.batch-selectable a {
            pointer-events: none;
        }

        .batch-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            z-index: 10;
            cursor: pointer;
            pointer-events: none;
        }

        .table-view .batch-checkbox {
            position: initial;
            z-index: 10;
            cursor: pointer;
        }

        .grid-item {
            position: relative;
        }

        .grid-item.batch-selectable {
            cursor: pointer;
        }

        #gridView {
            padding-top: 5px;
            /* Clip shadows that go beyond the container */
            clip-path: inset(0 0 0 0);
        }

        .table-view .batch-checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .batch-mode .grid-item:hover {
            outline: 1px solid #3b82f6;
            border: 1px solid #3b82f6
        }

        .batch-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
            z-index: 1001;
            display: none;
        }

        .batch-controls.show {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 24px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .tag-item {
            color: rgba(153, 145, 216, 1);
            background: rgba(167, 139, 250, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px !important;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tag-item:hover {
            background: rgba(167, 139, 250, 0.25);
            transform: translateY(-1px);
        }

        .tag-item.editing {
            background: #3b82f6;
            color: white;
        }

        .tag-item .tag-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-remove-invisible {
            position: absolute;
            right: 0;
            width: 15px;
            opacity: 0;
        }

        .tag-remove-invisible:hover+.tag-remove,
        .tag-remove-invisible:hover+.remove {
            color: #ef4444;
        }

        .tag-item .tag-remove:hover {
            opacity: 1;
            color: #ef4444;
        }

        .dummy-tag:hover {
            background: #2563ebde;
            transform: translateY(-1px);
        }

        .tag-input {
            border: 2px solid #3b82f6fa;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            outline: none;
            min-width: 30px;
            background: white;
            max-width: 40px;
        }

        .dummy-tag {
            font-size: 11px !important;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 2px;
            transition: all 0.2s;
        }

        .dummy-tag:focus::after {
            content: 'Add Tag';
            color: white;
        }
    </style>

    <style>
        .import-section-active {
            margin-right: 400px;
            transition: all 0.1s ease-in-out
        }

        .hamburger-menu {
            justify-content: flex-start;
        }

        #importSection h2 {
            font-size: 18px;
            font-weight: 700;
            color: #374151;
            margin: 0;
        }

        #importSection h3 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin: 0 0 8px 0;
        }

        #importSection code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #dc2626;
            font-weight: 600;
        }

        #importSection ol li {
            margin-bottom: 4px;
        }

        #importSection .import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .import-section-active {
                margin-right: 350px;
            }

            #importSection {
                width: 350px;
            }
        }
    </style>

    <script>
        function editTagNew(tagElement, orderId, currentTag) {
            // console.log('=== DIRECT editTagNew called:', orderId, currentTag);

            // if (tagElement.querySelector('.direct-tag-input')) {
            //     console.log('Already editing');
            //     return;
            // }

            const originalContent = tagElement.innerHTML;
            const isDummyTag = tagElement.classList.contains('dummy-tag');

            // Create input
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'direct-tag-input';
            input.value = currentTag;
            input.placeholder = isDummyTag ? 'Separate by spaces...' : '';
            input.style.cssText = `
        border: 2px solid #3b82f6 !important;
        padding: 4px 8px !important;
        border-radius: 12px !important;
        font-size: 10px !important;
        outline: none !important;
        background: white !important;
        width: auto !important;
        min-width: 50px !important;
    `;

            tagElement.innerHTML = '';
            tagElement.appendChild(input);
            input.focus();

            if (isDummyTag) {
                const afterLabel = document.createElement('span');
                afterLabel.textContent = 'Add Tag';
                afterLabel.style.cssText = 'color: white; font-size:10px !important';
                tagElement.appendChild(afterLabel);
            }
            if (currentTag) input.select();

            let saved = false;

            function saveEdit() {
                if (saved) return;
                saved = true;

                const newTag = input.value.trim();

                if (newTag) {
                    // Direct localStorage manipulation
                    let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                    const order = allOrders.find(o => o.id == orderId);

                    if (order) {
                        const currentTags = order.tags ? order.tags.split(' ').filter(t => t.trim()) : [];

                        if (isDummyTag) {
                            // Adding new tag
                            if (!currentTags.includes(newTag)) {
                                currentTags.push(newTag);
                                order.tags = currentTags.join(' ');
                            }
                        } else {
                            // Editing existing tag
                            if (newTag !== currentTag) {
                                const updatedTags = currentTags.map(tag => tag === currentTag ? newTag : tag);
                                order.tags = updatedTags.join(' ');
                            }
                        }

                        localStorage.setItem('orders', JSON.stringify(allOrders));

                        setTimeout(() => refreshTagsUINew(orderId), 100);

                        // Force refresh
                        setTimeout(() => {
                            applyFilters();
                        }, 100);
                    }
                } else if (isDummyTag) {
                    // Empty input on dummy tag - just cancel
                    cancelEdit();
                    return;
                } else {
                    // Restore original for regular tags
                    tagElement.innerHTML = originalContent;
                }
            }

            function cancelEdit() {
                if (isDummyTag) {
                    // Hide dummy tag and show add button again
                    // const addButton = document.querySelector(`[data-order-id="${orderId}"] .add-tag-btn`);
                    tagElement.innerHTML = originalContent;
                } else {
                    // Restore original content
                    tagElement.innerHTML = originalContent;
                }
            }

            // Simple event handling
            input.onkeydown = function (e) {
                e.stopPropagation();

                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            };

            input.onblur = function () {
                setTimeout(saveEdit, 200);
            };
        };



        function removeTagNew(event, orderId, tagToRemove) {
            event.stopPropagation();
            event.preventDefault();

            let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = allOrders.find(o => o.id == orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }

            const currentTags = order.tags ? order.tags.split(' ').filter(t => t.trim()) : [];
            const newTags = currentTags.filter(tag => tag !== tagToRemove);

            updateOrder(orderId, 'tags', newTags.join(' '));

            setTimeout(() => refreshTagsUINew(orderId), 100);
        }

        function addTagToOrderNew(orderId, newTag) {

            let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = allOrders.find(o => o.id == orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }

            const currentTags = order.tags ? order.tags.split(' ').filter(t => t.trim()) : [];

            // Don't add duplicate tags
            if (!currentTags.includes(newTag)) {
                currentTags.push(newTag);
                updateOrder(orderId, 'tags', currentTags.join(' '));
                console.log('Tag added successfully');
            } else {
                console.log('Tag already exists');
            }

            setTimeout(() => refreshTagsUINew(orderId), 100);
        }


        function refreshTagsUINew(orderId) {

            let allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = allOrders.find(o => o.id == orderId);
            if (!order) {
                console.error('Order not found for refresh:', orderId);
                return;
            }

            const container = document.querySelector(`[data-order-id="${orderId}"]`);
            if (container) {
                container.outerHTML = renderTagsUI(orderId, order.tags);
                console.log('Tags UI refreshed');
            } else {
                console.error('Container not found for refresh:', orderId);
            }

            renderTagsDropdown();
        }


        function changeCurrency(newCurrency) {
            currentCurrency = newCurrency;
            localStorage.setItem('selectedCurrency', currentCurrency);

            const currConfig = getCurrentCurrencyConfig();

            // Update the specific total labels
            document.getElementById('totalCurrencyLabel').textContent = `Total ${currConfig.displayName}`;

            const usdPerItemLabel = document.querySelector('[data-label="USD per Item"]');
            if (usdPerItemLabel) {
                usdPerItemLabel.textContent = `${currConfig.displayName} per Item`;
            }

            // Update displays (this will refresh the values with new currency symbols)
            updateTotals();
            renderView();
            renderParcels();
            updateParcelTabStats();
        }
    </script>
    <style>
        /* Updated Parcel tabs styling - Option B style */
        .parcel-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            margin-bottom: 0px;
            /* No gap between tabs and stats bar */
            overflow: hidden;
            background: white;
        }

        .parcel-tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            border-bottom: 3px solid transparent;
            flex: 1;
            background: #f9fafb;
            border-right: 1px solid #e5e7eb;
        }

        .parcel-tab:last-child {
            border-right: none;
        }

        .parcel-tab.active {
            color: rgb(106, 92, 201);
            border-bottom-color: rgb(151 141 217);
            background: white;
            position: relative;
            z-index: 1;
        }

        .parcel-tab:not(.active) {
            color: #6b7280;
        }

        .parcel-tab:not(.active):hover {
            color: #374151;
            background: #f3f4f6;
        }

        .tab-main {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            justify-content: center;
        }

        .tab-count {
            background: rgb(151 141 217);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .parcel-tab:not(.active) .tab-count {
            background: #9ca3af;
        }

        .tab-stats {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 500;
            transition: opacity 0.3s ease;
            text-align: center;
            line-height: 1.3;
        }

        .parcel-tab.active .tab-stats {
            opacity: 1;
            color: #6366f1;
        }

        /* Updated Stats bar styling - cleaner Option B style */
        .parcel-stats-bar {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-top: none;
            /* Connects seamlessly to active tab */
            border-radius: 0 0 8px 8px;
            padding: 16px 24px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
            display: none;

        }

        .parcel-stats-bar.active {
            display: block;
        }


        .stats-bar-items {
            display: grid;
            gap: 10px;
            /* align-items: center; */
            grid-auto-flow: column;
            grid-template-columns: auto;
        }

        .stats-bar-item {
            display: flex;
            flex-direction: column;
            /* align-items: center; */
            text-align: center;
            min-width: 0;
            /* Allow shrinking */
        }

        .stats-bar-value {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 2px;
            font-size: 10px !important
        }

        .stats-bar-label {
            color: #64748b;
            font-weight: 500;
            font-size: 10px !important
        }

        /* Remove the old slideDown animation and add a subtle fade */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutToRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .parcel-stats-bar {
            animation: fadeIn 0.2s ease;
        }

        .modal-content h3 {
            font-weight: 700
        }

        .modal-content label {
            font-size: 11px !important
        }
    </style>
</body>

</html>