<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #374151;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #4b5563;
            font-size: 28px;
            margin-bottom: 16px;
        }

        .import-section {
            margin-bottom: 20px;
        }

        .import-section textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .import-section textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .filters {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-group label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .filter-group input, .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #a78bfa;
        }

        .view-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-toggle {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle.active {
            background: #6b7280;
            color: white;
        }

        .totals-row {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .total-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .total-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .total-value {
            font-size: 24px;
            font-weight: 700;
            color: #6b7280;
        }

        /* Grid View */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .grid-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .grid-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .grid-item h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #374151;
        }

        .grid-item .order-id {
            color: #a78bfa;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .grid-item .price {
            font-size: 18px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 8px;
        }

        .grid-item .details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .grid-item .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .tag {
            background: rgba(167, 139, 250, 0.1);
            color: #a78bfa;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .grid-item .actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        /* Table View */
        .table-view {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .table-view table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-view th {
            background: #f3f4f6;
            color: #374151;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            position: relative;
        }

        .table-view th:hover {
            background: #e5e7eb;
        }

        .table-view th::after {
            content: '↕';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.4;
            font-size: 10px;
        }

        .table-view th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        .table-view th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .table-view td {
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .table-view tr:hover {
            background: rgba(167, 139, 250, 0.05);
        }

        /* Make Title column wider */
        .table-view th:nth-child(3),
        .table-view td:nth-child(3) {
            width: 30%;
            min-width: 200px;
        }

        .table-view img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .editable {
            border: none;
            background: transparent;
            width: 100%;
            padding: 4px;
        }

        .editable:focus {
            background: rgba(167, 139, 250, 0.1);
            outline: none;
            border-radius: 4px;
        }

        /* Parcel Section */
        .parcel-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            border: 1px solid #e5e7eb;
        }

        .parcel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .parcel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .parcel-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .parcel-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #6b7280;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
        }

        .column-controls {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            margin-left: 16px;
            display: none;
        }

        .column-controls.show {
            display: block;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            max-width: 600px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .column-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        .multi-select {
            position: relative;
            display: inline-block;
            min-width: 200px;
        }

        .multi-select-trigger {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
        }

        .multi-select-trigger:focus,
        .multi-select.open .multi-select-trigger {
            border-color: #a78bfa;
            outline: none;
        }

        .multi-select-trigger::after {
            content: '▼';
            font-size: 10px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .multi-select.open .multi-select-trigger::after {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #a78bfa;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .multi-select.open .multi-select-dropdown {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background: #f3f4f6;
        }

        .multi-select-option input[type="checkbox"] {
            margin: 0;
        }

        .multi-select-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 20px;
        }

        .multi-select-tag {
            background: rgba(167, 139, 250, 0.1);
            color: #a78bfa;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .multi-select-tag .remove:hover {
            color: #ef4444;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #a78bfa;
        }

        .multi-select {
            position: relative;
            display: inline-block;
            min-width: 200px;
        }

        .multi-select-trigger {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
        }

        .multi-select-trigger:focus,
        .multi-select.open .multi-select-trigger {
            border-color: #a78bfa;
            outline: none;
        }

        .multi-select-trigger::after {
            content: '▼';
            font-size: 10px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .multi-select.open .multi-select-trigger::after {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #a78bfa;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .multi-select.open .multi-select-dropdown {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background: #f3f4f6;
        }

        .multi-select-option input[type="checkbox"] {
            margin: 0;
        }

        .multi-select-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 20px;
        }

        .multi-select-tag {
            background: rgba(167, 139, 250, 0.1);
            color: #a78bfa;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .multi-select-tag .remove:hover {
            color: #ef4444;
        }

        .multi-select-placeholder {
            color: #9ca3af;
            font-size: 14px;
        }

        .table-view th.hidden-column,
        .table-view td.hidden-column {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Order Tracker</h1>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn" onclick="toggleImportSection()">Import HTML</button>
                <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Data</button>
                <button class="btn btn-secondary" onclick="openFormatsModal()">Manage Formats</button>
                <button class="btn btn-secondary" onclick="clearAllData()" style="background: #ef4444; border-color: #ef4444;">Clear Data</button>
            </div>
            <div id="importSection" class="import-section hidden" style="margin-top: 20px;">
                <textarea id="htmlInput" placeholder="Paste your HTML code here..."></textarea>
                <br><br>
                <button class="btn" onclick="parseHTML()">Parse & Import Orders</button>
                <button class="btn btn-secondary" onclick="toggleImportSection()">Cancel</button>
            </div>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search Items</label>
                    <input type="text" id="searchInput" placeholder="Search by order ID or title..." oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Book Format</label>
                    <div class="multi-select" id="formatMultiSelect">
                        <div class="multi-select-trigger" onclick="toggleMultiSelect('format')" tabindex="0">
                            <div class="multi-select-tags" id="formatTags">
                                <div class="multi-select-placeholder">All Formats</div>
                            </div>
                        </div>
                        <div class="multi-select-dropdown" id="formatDropdown">
                            <!-- Format options will be dynamically generated -->
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Tags</label>
                    <input type="text" id="tagsInput" placeholder="Filter by tags..." oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Min Price (¥)</label>
                    <input type="number" id="minPrice" oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Max Price (¥)</label>
                    <input type="number" id="maxPrice" oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <div class="multi-select" id="statusMultiSelect">
                        <div class="multi-select-trigger" onclick="toggleMultiSelect('status')" tabindex="0">
                            <div class="multi-select-tags" id="statusTags">
                                <div class="multi-select-placeholder">All Statuses</div>
                            </div>
                        </div>
                        <div class="multi-select-dropdown">
                            <div class="multi-select-option">
                                <input type="checkbox" id="status-in-storage" value="In storage" onchange="updateStatusFilter()">
                                <label for="status-in-storage">In storage</label>
                            </div>
                            <div class="multi-select-option">
                                <input type="checkbox" id="status-arrived" value="Arrived" onchange="updateStatusFilter()">
                                <label for="status-arrived">Arrived</label>
                            </div>
                            <div class="multi-select-option">
                                <input type="checkbox" id="status-awaiting" value="Awaiting delivery" onchange="updateStatusFilter()">
                                <label for="status-awaiting">Awaiting delivery</label>
                            </div>
                            <div class="multi-select-option">
                                <input type="checkbox" id="status-cancelled" value="Cancelled" onchange="updateStatusFilter()">
                                <label for="status-cancelled">Cancelled</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-row">
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                <button class="btn btn-secondary" onclick="toggleTotals()">Toggle Totals</button>
            </div>
        </div>

        <div class="view-controls">
            <button class="view-toggle active" onclick="setView('grid')">Grid View</button>
            <button class="view-toggle" onclick="setView('table')">Table View</button>
            <button id="columnToggleBtn" class="view-toggle" onclick="toggleColumnControls()" style="display: none;">Columns</button>
            
            <div id="columnControls" class="column-controls">
                <div style="font-weight: 600; margin-bottom: 8px; color: #4b5563;">Show/Hide Columns</div>
                <div class="column-grid">
                    <div class="column-item">
                        <input type="checkbox" id="col-image" checked onchange="toggleColumn('image')">
                        <label for="col-image">Image</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-orderId" checked onchange="toggleColumn('orderId')">
                        <label for="col-orderId">Order #</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-title" checked onchange="toggleColumn('title')">
                        <label for="col-title">Title</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-quantity" checked onchange="toggleColumn('quantity')">
                        <label for="col-quantity">Quantity</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-yen" checked onchange="toggleColumn('yen')">
                        <label for="col-yen">Yen</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-usd" checked onchange="toggleColumn('usd')">
                        <label for="col-usd">USD</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-created" checked onchange="toggleColumn('created')">
                        <label for="col-created">Created</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-storageDays" checked onchange="toggleColumn('storageDays')">
                        <label for="col-storageDays">Storage Days</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')">
                        <label for="col-status">Status</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-neokyoNotes" checked onchange="toggleColumn('neokyoNotes')">
                        <label for="col-neokyoNotes">Neokyo Notes</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-bookFormat" checked onchange="toggleColumn('bookFormat')">
                        <label for="col-bookFormat">Format</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-volumes" checked onchange="toggleColumn('volumes')">
                        <label for="col-volumes">Volumes</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-parcel" checked onchange="toggleColumn('parcel')">
                        <label for="col-parcel">Parcel</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-tags" checked onchange="toggleColumn('tags')">
                        <label for="col-tags">Tags</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-url" checked onchange="toggleColumn('url')">
                        <label for="col-url">URL</label>
                    </div>
                    <div class="column-item">
                        <input type="checkbox" id="col-actions" checked onchange="toggleColumn('actions')">
                        <label for="col-actions">Actions</label>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <button class="btn btn-secondary btn-small" onclick="showAllColumns()">Show All</button>
                    <button class="btn btn-secondary btn-small" onclick="hideAllColumns()">Hide All</button>
                </div>
            </div>
        </div>

        <div id="totalsRow" class="totals-row">
            <div class="total-item">
                <div class="total-label">Total Items</div>
                <div class="total-value" id="totalItems">0</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Yen</div>
                <div class="total-value" id="totalYen">¥0</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total USD</div>
                <div class="total-value" id="totalUSD">$0</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Weight</div>
                <div class="total-value" id="totalWeight">0g</div>
            </div>
        </div>

        <div id="gridView" class="grid-view"></div>
        <div id="tableView" class="table-view hidden"></div>

        <div class="parcel-section">
            <div class="parcel-header">
                <h2>Parcel Calculator</h2>
                <button class="btn" onclick="openParcelModal()">Add Parcel</button>
            </div>
            <div id="parcelGrid" class="parcel-grid"></div>
        </div>
    </div>

    <!-- Formats Modal -->
    <div id="formatsModal" class="modal hidden" onclick="closeFormatsModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Manage Book Formats</h3>
                <button class="btn btn-secondary" onclick="closeFormatsModal()">×</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="addNewFormat()">Add New Format</button>
                <button class="btn btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
            </div>
            
            <div id="formatsTable" class="table-view" style="margin-bottom: 20px;">
                <!-- Formats table will be inserted here -->
            </div>
            
            <div style="text-align: right;">
                <button class="btn" onclick="saveFormats()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeFormatsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Parcel Modal -->
    <div id="editParcelModal" class="modal hidden" onclick="closeEditParcelModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Edit Parcel</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editParcelName" placeholder="Parcel 1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Length (inches)</label>
                    <input type="number" id="editParcelLength" step="0.1" value="12">
                </div>
                <div class="form-group">
                    <label>Width (inches)</label>
                    <input type="number" id="editParcelWidth" step="0.1" value="8">
                </div>
                <div class="form-group">
                    <label>Height (inches)</label>
                    <input type="number" id="editParcelHeight" step="0.1" value="6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Padding (inches)</label>
                    <input type="number" id="editParcelPadding" step="0.1" value="0.5">
                </div>
                <div class="form-group">
                    <label>Box Weight (g)</label>
                    <input type="number" id="editParcelBoxWeight" value="100">
                </div>
            </div>
            <div class="form-row">
                <button class="btn" onclick="saveParcelEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditParcelModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Parcel Modal -->
    <div id="parcelModal" class="modal hidden" onclick="closeModalOnOutsideClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Add New Parcel</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="parcelName" placeholder="Parcel 1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Length (inches)</label>
                    <input type="number" id="parcelLength" step="0.1" value="12">
                </div>
                <div class="form-group">
                    <label>Width (inches)</label>
                    <input type="number" id="parcelWidth" step="0.1" value="8">
                </div>
                <div class="form-group">
                    <label>Height (inches)</label>
                    <input type="number" id="parcelHeight" step="0.1" value="6">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Padding (inches)</label>
                    <input type="number" id="parcelPadding" step="0.1" value="0.5">
                </div>
                <div class="form-group">
                    <label>Box Weight (g)</label>
                    <input type="number" id="parcelBoxWeight" value="100">
                </div>
            </div>
            <div class="form-row">
                <button class="btn" onclick="addParcel()">Add Parcel</button>
                <button class="btn btn-secondary" onclick="closeParcelModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let orders = [];
        let parcels = [];
        
        // Safe data loading with error handling
        try {
            orders = JSON.parse(localStorage.getItem('orders') || '[]');
            // Ensure all orders have proper tags field
            orders = orders.map(order => ({
                ...order,
                tags: order.tags || ''
            }));
        } catch (e) {
            console.error('Error loading orders:', e);
            orders = [];
        }
        
        try {
            parcels = JSON.parse(localStorage.getItem('parcels') || '[]');
        } catch (e) {
            console.error('Error loading parcels:', e);
            parcels = [];
        }
        let currentView = 'grid';
        let showTotals = true;
        let sortState = { field: null, direction: 'asc' }; // Track sort state
        let currentEditingParcel = null; // Track which parcel is being edited
        
        // Multi-select filter states
        let selectedStatuses = [];
        let selectedFormats = [];
        let selectedParcels = [];
        
        // Column visibility state
        let columnVisibility = {
            image: true,
            orderId: true,
            title: true,
            quantity: true,
            yen: true,
            usd: true,
            created: true,
            storageDays: true,
            status: true,
            neokyoNotes: true,
            bookFormat: true,
            volumes: true,
            parcel: true,
            tags: true,
            url: true,
            actions: true
        };

        // Book format specifications - now editable
        let bookFormats = JSON.parse(localStorage.getItem('bookFormats') || JSON.stringify({
            'A5': { width: 5.8, height: 8.3, thickness: 0.6, weight: 270 },
            'B6': { width: 5.04, height: 7.17, thickness: 0.5, weight: 190 },
            'B5': { width: 6.9, height: 6.8, thickness: 0.25, weight: 100 },
            'A4': { width: 8.3, height: 11.7, thickness: 0.5, weight: 350 },
            'A6': { width: 4.1, height: 5.8, thickness: 0.4, weight: 150 }
        }));

        // Default formats for reset function
        const defaultFormats = {
            'A5': { width: 5.8, height: 8.3, thickness: 0.6, weight: 270 },
            'B6': { width: 5.04, height: 7.17, thickness: 0.5, weight: 190 },
            'B5': { width: 6.9, height: 6.8, thickness: 0.25, weight: 100 },
            'A4': { width: 8.3, height: 11.7, thickness: 0.5, weight: 350 },
            'A6': { width: 4.1, height: 5.8, thickness: 0.4, weight: 150 }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load column visibility preferences
            try {
                const savedVisibility = localStorage.getItem('columnVisibility');
                if (savedVisibility) {
                    columnVisibility = { ...columnVisibility, ...JSON.parse(savedVisibility) };
                    // Update checkboxes
                    Object.keys(columnVisibility).forEach(col => {
                        const checkbox = document.getElementById(`col-${col}`);
                        if (checkbox) {
                            checkbox.checked = columnVisibility[col];
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading column visibility:', e);
            }
            
            renderFormatDropdown(); // Initialize format dropdown
            renderView();
            renderParcels();
            updateTotals();
        });

        function parseHTML() {
            const htmlInput = document.getElementById('htmlInput').value;
            if (!htmlInput.trim()) {
                alert('Please paste HTML code first');
                return;
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlInput, 'text/html');
            const rows = doc.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const imgDiv = cells[0].querySelector('.img-holder');
                    const imgUrl = imgDiv ? imgDiv.style.backgroundImage.replace(/url\(['"]?(.+?)['"]?\)/, '$1') : '';
                    
                    const detailsCell = cells[1];
                    const orderIdMatch = detailsCell.innerHTML.match(/#(\d+)/);
                    const titleMatch = detailsCell.innerHTML.match(/<b>(.*?)<\/b>/g);
                    const quantityMatch = detailsCell.innerHTML.match(/Quantity\s*:\s*(\d+)/);
                    const createdMatch = detailsCell.innerHTML.match(/Created:\s*(\d{2}\/\d{2}\/\d{4})/);
                    
                    const statusCell = cells[2];
                    const storageDaysMatch = statusCell.innerHTML.match(/<b>(\d+)<\/b>\s*Storage day/);
                    
                    // Parse status and notes
                    const statusParagraphs = statusCell.querySelectorAll('p');
                    let status = '';
                    let neokyoNotes = '';
                    
                    if (statusParagraphs.length > 0) {
                        // First paragraph contains the status
                        const firstP = statusParagraphs[0];
                        const statusText = firstP.textContent.trim();
                        if (statusText.includes('In storage')) {
                            status = 'In storage';
                        } else if (statusText.includes('Arrived') || statusText.includes('soon in storage')) {
                            status = 'Arrived';
                        } else if (statusText.includes('Awaiting delivery')) {
                            status = 'Awaiting delivery';
                        } else if (statusText.includes('Cancelled')) {
                            status = 'Cancelled';
                        } else {
                            status = statusText.replace(/\s+/g, ' ').trim();
                        }
                        
                        // Second paragraph (if exists) contains notes
                        if (statusParagraphs.length > 1) {
                            const secondP = statusParagraphs[1];
                            neokyoNotes = secondP.textContent.replace(/\s+/g, ' ').trim();
                        }
                    }
                    
                    const billingCell = cells[3];
                    const yenMatch = billingCell.innerHTML.match(/(\d+)\s*yen/);
                    const usdMatch = billingCell.innerHTML.match(/US\$\s*([\d.]+)/);
                    
                    const actionsCell = cells[4];
                    const linkMatch = actionsCell.innerHTML.match(/href=['"]([^'"]+)['"]/);

                    if (orderIdMatch && titleMatch && quantityMatch) {
                        const orderId = orderIdMatch[1];
                        const title = titleMatch[titleMatch.length - 1].replace(/<\/?b>/g, '');
                        
                        // Check if order already exists
                        if (!orders.find(order => order.orderId === orderId)) {
                            const order = {
                                id: Date.now() + Math.random(),
                                image: imgUrl,
                                orderId: orderId,
                                title: title,
                                quantity: parseInt(quantityMatch[1]),
                                yen: yenMatch ? parseInt(yenMatch[1]) : 0,
                                usd: usdMatch ? parseFloat(usdMatch[1]) : 0,
                                created: createdMatch ? createdMatch[1] : '',
                                storageDays: storageDaysMatch ? parseInt(storageDaysMatch[1]) : 0,
                                status: status,
                                neokyoNotes: neokyoNotes,
                                url: linkMatch ? linkMatch[1] : '',
                                tags: '',
                                bookFormat: 'B6',
                                volumes: 0,
                                parcel: ''
                            };
                            orders.push(order);
                        }
                    }
                }
            });

            saveData();
            renderView();
            updateTotals();
            document.getElementById('htmlInput').value = '';
            toggleImportSection(); // Hide the import section
            alert(`Imported ${orders.length} orders successfully!`);
        }

        function renderView() {
            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderTableView();
            }
        }

        function renderGridView() {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');
            
            gridView.classList.remove('hidden');
            tableView.classList.add('hidden');
            
            gridView.innerHTML = orders.map(order => `
                <div class="grid-item">
                    <img src="${order.image}" alt="${order.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMyMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMyMCIgaGVpZ2h0PSIxODAiIGZpbGw9IiNmM2Y0ZjYiLz48cGF0aCBkPSJNMTQwIDkwSDEyMFY3MEgxNDBWOTBaTTE4MCA5MEgxNjBWNzBIMTgwVjkwWk0xNjAgMTEwSDE0MFY5MEgxNjBWMTEwWiIgZmlsbD0iIzljYTNhZiIvPjwvc3ZnPg=='">
                    <div class="order-id">#${order.orderId}</div>
                    <h3>${order.title}</h3>
                    <div class="price">¥${order.yen} ($${order.usd})</div>
                    <div class="details">
                        <span>Qty: ${order.quantity}</span>
                        <span>Days: ${order.storageDays}</span>
                        <span>Status: ${order.status || 'Unknown'}</span>
                    </div>
                    <div class="details">
                        <span>Volumes: <input type="number" value="${order.volumes}" onchange="updateOrder('${order.id}', 'volumes', this.value)" style="width: 50px;"></span>
                        <span>Format: 
                            <select onchange="updateOrder('${order.id}', 'bookFormat', this.value)" style="width: 60px;">
                                ${Object.keys(bookFormats).map(format => 
                                    `<option value="${format}" ${order.bookFormat === format ? 'selected' : ''}>${format}</option>`
                                ).join('')}
                            </select>
                        </span>
                        <span>Parcel: 
                            <select onchange="updateOrder('${order.id}', 'parcel', this.value)" style="width: 80px;">
                                <option value="">None</option>
                                ${parcels.map(parcel => 
                                    `<option value="${parcel.id}" ${order.parcel === parcel.id ? 'selected' : ''}>${parcel.name}</option>`
                                ).join('')}
                            </select>
                        </span>
                    </div>
                    ${order.neokyoNotes ? `<div style="font-size: 11px; color: #dc2626; background: #fef2f2; padding: 4px 8px; border-radius: 4px; margin: 4px 0;">${order.neokyoNotes}</div>` : ''}
                    <div class="tags">
                        ${String(order.tags || '').split(' ').filter(tag => tag).map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    <input type="text" value="${order.tags || ''}" placeholder="Add tags..." onchange="updateOrder('${order.id}', 'tags', this.value)" onkeydown="handleTagInput(event, '${order.id}')" style="width: 100%; margin: 8px 0; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">
                    <div class="actions">
                        <a href="${order.url}" class="btn btn-small" target="_blank">Open</a>
                        <button class="btn btn-small btn-secondary" onclick="deleteOrder('${order.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTableView() {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');
            
            gridView.classList.add('hidden');
            tableView.classList.remove('hidden');
            
            // Helper function to get sort class for a field
            const getSortClass = (field) => {
                if (sortState.field === field) {
                    return sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc';
                }
                return '';
            };
            
            tableView.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortBy('image')" class="${columnVisibility.image ? '' : 'hidden-column'} ${getSortClass('image')}">Image</th>
                            <th onclick="sortBy('orderId')" class="${columnVisibility.orderId ? '' : 'hidden-column'} ${getSortClass('orderId')}">Order #</th>
                            <th onclick="sortBy('title')" class="${columnVisibility.title ? '' : 'hidden-column'} ${getSortClass('title')}">Title</th>
                            <th onclick="sortBy('quantity')" class="${columnVisibility.quantity ? '' : 'hidden-column'} ${getSortClass('quantity')}">Qty</th>
                            <th onclick="sortBy('yen')" class="${columnVisibility.yen ? '' : 'hidden-column'} ${getSortClass('yen')}">Yen</th>
                            <th onclick="sortBy('usd')" class="${columnVisibility.usd ? '' : 'hidden-column'} ${getSortClass('usd')}">USD</th>
                            <th onclick="sortBy('created')" class="${columnVisibility.created ? '' : 'hidden-column'} ${getSortClass('created')}">Created</th>
                            <th onclick="sortBy('storageDays')" class="${columnVisibility.storageDays ? '' : 'hidden-column'} ${getSortClass('storageDays')}">Storage Days</th>
                            <th onclick="sortBy('status')" class="${columnVisibility.status ? '' : 'hidden-column'} ${getSortClass('status')}">Status</th>
                            <th onclick="sortBy('neokyoNotes')" class="${columnVisibility.neokyoNotes ? '' : 'hidden-column'} ${getSortClass('neokyoNotes')}">Neokyo Notes</th>
                            <th onclick="sortBy('bookFormat')" class="${columnVisibility.bookFormat ? '' : 'hidden-column'} ${getSortClass('bookFormat')}">Format</th>
                            <th onclick="sortBy('volumes')" class="${columnVisibility.volumes ? '' : 'hidden-column'} ${getSortClass('volumes')}">Volumes</th>
                            <th onclick="sortBy('parcel')" class="${columnVisibility.parcel ? '' : 'hidden-column'} ${getSortClass('parcel')}">Parcel</th>
                            <th onclick="sortBy('tags')" class="${columnVisibility.tags ? '' : 'hidden-column'} ${getSortClass('tags')}">Tags</th>
                            <th class="${columnVisibility.url ? '' : 'hidden-column'}">URL</th>
                            <th class="${columnVisibility.actions ? '' : 'hidden-column'}">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => `
                            <tr>
                                <td class="${columnVisibility.image ? '' : 'hidden-column'}"><img src="${order.image}" alt="${order.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNmM2Y0ZjYiLz48cGF0aCBkPSJNMjYgMzBIMjRWMjZIMjZWMzBaTTM0IDMwSDMyVjI2SDM0VjMwWk0zMiAzNkgzMFYzMEgzMlYzNloiIGZpbGw9IiM5Y2EzYWYiLz48L3N2Zz4='"></td>
                                <td class="${columnVisibility.orderId ? '' : 'hidden-column'}"><input class="editable" value="${order.orderId}" onchange="updateOrder('${order.id}', 'orderId', this.value)"></td>
                                <td class="${columnVisibility.title ? '' : 'hidden-column'}"><input class="editable" value="${order.title}" onchange="updateOrder('${order.id}', 'title', this.value)"></td>
                                <td class="${columnVisibility.quantity ? '' : 'hidden-column'}"><input class="editable" type="number" value="${order.quantity}" onchange="updateOrder('${order.id}', 'quantity', this.value)"></td>
                                <td class="${columnVisibility.yen ? '' : 'hidden-column'}"><input class="editable" type="number" value="${order.yen}" onchange="updateOrder('${order.id}', 'yen', this.value)"></td>
                                <td class="${columnVisibility.usd ? '' : 'hidden-column'}"><input class="editable" type="number" step="0.01" value="${order.usd}" onchange="updateOrder('${order.id}', 'usd', this.value)"></td>
                                <td class="${columnVisibility.created ? '' : 'hidden-column'}"><input class="editable" value="${order.created}" onchange="updateOrder('${order.id}', 'created', this.value)"></td>
                                <td class="${columnVisibility.storageDays ? '' : 'hidden-column'}"><input class="editable" type="number" value="${order.storageDays}" onchange="updateOrder('${order.id}', 'storageDays', this.value)"></td>
                                <td class="${columnVisibility.status ? '' : 'hidden-column'}"><input class="editable" value="${order.status || ''}" onchange="updateOrder('${order.id}', 'status', this.value)"></td>
                                <td class="${columnVisibility.neokyoNotes ? '' : 'hidden-column'}"><input class="editable" value="${order.neokyoNotes || ''}" onchange="updateOrder('${order.id}', 'neokyoNotes', this.value)"></td>
                                <td class="${columnVisibility.bookFormat ? '' : 'hidden-column'}">
                                    <select class="editable" onchange="updateOrder('${order.id}', 'bookFormat', this.value)">
                                        ${Object.keys(bookFormats).map(format => 
                                            `<option value="${format}" ${order.bookFormat === format ? 'selected' : ''}>${format}</option>`
                                        ).join('')}
                                    </select>
                                </td>
                                <td class="${columnVisibility.volumes ? '' : 'hidden-column'}"><input class="editable" type="number" value="${order.volumes}" onchange="updateOrder('${order.id}', 'volumes', this.value)"></td>
                                <td class="${columnVisibility.parcel ? '' : 'hidden-column'}">
                                    <select class="editable" onchange="updateOrder('${order.id}', 'parcel', this.value)">
                                        <option value="">None</option>
                                        ${parcels.map(parcel => 
                                            `<option value="${parcel.id}" ${order.parcel === parcel.id ? 'selected' : ''}>${parcel.name}</option>`
                                        ).join('')}
                                    </select>
                                </td>
                                <td class="${columnVisibility.tags ? '' : 'hidden-column'}"><input class="editable" value="${order.tags || ''}" onchange="updateOrder('${order.id}', 'tags', this.value)" onkeydown="handleTagInput(event, '${order.id}')"></td>
                                <td class="${columnVisibility.url ? '' : 'hidden-column'}"><a href="${order.url}" target="_blank" class="btn btn-small">Open</a></td>
                                <td class="${columnVisibility.actions ? '' : 'hidden-column'}"><button class="btn btn-small btn-secondary" onclick="deleteOrder('${order.id}')">Delete</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateOrder(orderId, field, value) {
            // Find order in the original data stored in localStorage
            let allOrders = [];
            try {
                allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            } catch (e) {
                console.error('Error loading orders:', e);
                return;
            }
            
            const order = allOrders.find(o => o.id == orderId);
            if (order) {
                if (field === 'quantity' || field === 'yen' || field === 'storageDays' || field === 'volumes') {
                    order[field] = parseInt(value) || 0;
                } else if (field === 'usd') {
                    order[field] = parseFloat(value) || 0;
                } else {
                    order[field] = value;
                }
                
                // Save back to localStorage
                localStorage.setItem('orders', JSON.stringify(allOrders));
                
                // Update the currently displayed orders array
                const displayedOrder = orders.find(o => o.id == orderId);
                if (displayedOrder) {
                    Object.assign(displayedOrder, order);
                }
                
                updateTotals();
                renderParcels(); // Update parcel calculations
            }
        }

        function handleTagInput(event, orderId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                updateOrder(orderId, 'tags', event.target.value);
                event.target.blur(); // Remove focus from the input
                renderView(); // Re-render to show updated tags
            }
        }

        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                orders = orders.filter(o => o.id != orderId);
                saveData();
                renderView();
                updateTotals();
                renderParcels();
            }
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide column controls button
            const columnBtn = document.getElementById('columnToggleBtn');
            const columnControls = document.getElementById('columnControls');
            if (view === 'table') {
                columnBtn.style.display = 'block';
            } else {
                columnBtn.style.display = 'none';
                columnControls.classList.remove('show');
            }
            
            renderView();
        }

        function toggleColumnControls() {
            const columnControls = document.getElementById('columnControls');
            columnControls.classList.toggle('show');
        }

        function toggleColumn(columnName) {
            columnVisibility[columnName] = document.getElementById(`col-${columnName}`).checked;
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            renderView();
        }

        function showAllColumns() {
            Object.keys(columnVisibility).forEach(col => {
                columnVisibility[col] = true;
                document.getElementById(`col-${col}`).checked = true;
            });
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            renderView();
        }

        function hideAllColumns() {
            Object.keys(columnVisibility).forEach(col => {
                columnVisibility[col] = false;
                document.getElementById(`col-${col}`).checked = false;
            });
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            renderView();
        }

        function sortBy(field) {
            // Toggle sort direction if clicking same field, otherwise start with ascending
            if (sortState.field === field) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.field = field;
                sortState.direction = 'asc';
            }
            
            // Sort the orders
            orders.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle special cases
                if (field === 'parcel') {
                    // Convert parcel ID to parcel name for sorting
                    const parcelA = parcels.find(p => p.id === aVal);
                    const parcelB = parcels.find(p => p.id === bVal);
                    aVal = parcelA ? parcelA.name : '';
                    bVal = parcelB ? parcelB.name : '';
                }
                
                // Handle null/undefined values
                if (aVal == null) aVal = '';
                if (bVal == null) bVal = '';
                
                // Numeric comparison
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return sortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                // String comparison
                const aStr = String(aVal).toLowerCase();
                const bStr = String(bVal).toLowerCase();
                
                if (sortState.direction === 'asc') {
                    return aStr.localeCompare(bStr);
                } else {
                    return bStr.localeCompare(aStr);
                }
            });
            
            renderView();
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const tags = document.getElementById('tagsInput').value.toLowerCase();
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            const filteredOrders = JSON.parse(localStorage.getItem('orders') || '[]').filter(order => {
                const matchesSearch = !search || 
                    order.orderId.toLowerCase().includes(search) || 
                    order.title.toLowerCase().includes(search);
                
                const matchesTags = !tags || 
                    String(order.tags || '').toLowerCase().includes(tags);
                
                const matchesPrice = order.yen >= minPrice && order.yen <= maxPrice;
                
                const matchesFormat = selectedFormats.length === 0 || 
                    selectedFormats.includes(order.bookFormat);
                
                const matchesStatus = selectedStatuses.length === 0 || 
                    selectedStatuses.some(selectedStatus => 
                        (order.status || '').toLowerCase().includes(selectedStatus.toLowerCase()));

                return matchesSearch && matchesTags && matchesPrice && matchesFormat && matchesStatus;
            });

            orders = filteredOrders;
            renderView();
            updateTotals();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('tagsInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            
            // Clear multi-select status filter
            selectedStatuses = [];
            document.querySelectorAll('#statusMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            renderStatusTags();
            
            // Clear multi-select format filter
            selectedFormats = [];
            document.querySelectorAll('#formatMultiSelect input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            renderFormatTags();
            
            // Reset orders to original data from localStorage
            try {
                orders = JSON.parse(localStorage.getItem('orders') || '[]');
                // Ensure all orders have proper tags field
                orders = orders.map(order => ({
                    ...order,
                    tags: order.tags || ''
                }));
            } catch (e) {
                console.error('Error loading orders:', e);
                orders = [];
            }
            
            renderView();
            updateTotals();
        }

        function toggleTotals() {
            showTotals = !showTotals;
            const totalsRow = document.getElementById('totalsRow');
            if (showTotals) {
                totalsRow.classList.remove('hidden');
            } else {
                totalsRow.classList.add('hidden');
            }
        }

        function updateTotals() {
            const totalItems = orders.length;
            const totalYen = orders.reduce((sum, order) => sum + order.yen, 0);
            const totalUSD = orders.reduce((sum, order) => sum + order.usd, 0);
            const totalWeight = orders.reduce((sum, order) => {
                const format = bookFormats[order.bookFormat] || bookFormats['B6'];
                const itemWeight = format.weight * (order.volumes || 1);
                return sum + (itemWeight * order.quantity);
            }, 0);

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalYen').textContent = `¥${totalYen.toLocaleString()}`;
            document.getElementById('totalUSD').textContent = `${totalUSD.toFixed(2)}`;
            document.getElementById('totalWeight').textContent = `${totalWeight.toFixed(0)}g`;
        }

        // Parcel functions
        function openParcelModal() {
            document.getElementById('parcelModal').classList.remove('hidden');
        }

        function closeParcelModal() {
            document.getElementById('parcelModal').classList.add('hidden');
        }

        function closeModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeParcelModal();
            }
        }

        function toggleImportSection() {
            const importSection = document.getElementById('importSection');
            importSection.classList.toggle('hidden');
        }

        function saveFormats() {
            const rows = document.querySelectorAll('#formatsTable tbody tr');
            const newFormats = {};
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const width = parseFloat(inputs[1].value) || 0;
                const height = parseFloat(inputs[2].value) || 0;
                const thickness = parseFloat(inputs[3].value) || 0;
                const weight = parseFloat(inputs[4].value) || 0;
                
                if (name && width > 0 && height > 0 && thickness > 0 && weight > 0) {
                    newFormats[name] = { width, height, thickness, weight };
                }
            });
            
            bookFormats = newFormats;
            localStorage.setItem('bookFormats', JSON.stringify(bookFormats));
            
            closeFormatsModal();
            renderFormatDropdown(); // Update the format filter dropdown
            renderView(); // Refresh dropdowns
            updateTotals(); // Recalculate weights
            renderParcels(); // Update parcel calculations
            alert('Format changes saved successfully!');
        }

        function openFormatsModal() {
            document.getElementById('formatsModal').classList.remove('hidden');
            renderFormatsTable();
        }

        function closeFormatsModal() {
            document.getElementById('formatsModal').classList.add('hidden');
        }

        function closeFormatsModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeFormatsModal();
            }
        }

        function renderFormatsTable() {
            const formatsTable = document.getElementById('formatsTable');
            
            formatsTable.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Format Name</th>
                            <th>Width (inches)</th>
                            <th>Height (inches)</th>
                            <th>Thickness (inches)</th>
                            <th>Weight (grams)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(bookFormats).map(([name, format]) => `
                            <tr>
                                <td><input type="text" value="${name}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" step="0.1" value="${format.width}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" step="0.1" value="${format.height}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" step="0.1" value="${format.thickness}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" value="${format.weight}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><button class="btn btn-small btn-secondary" onclick="deleteFormatRow(this)" style="background: #ef4444; border-color: #ef4444; color: white;">Delete</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function addNewFormat() {
            const tbody = document.querySelector('#formatsTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Format Name" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="0.1" placeholder="Width" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="0.1" placeholder="Height" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="0.1" placeholder="Thickness" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" placeholder="Weight" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><button class="btn btn-small btn-secondary" onclick="deleteFormatRow(this)" style="background: #ef4444; border-color: #ef4444; color: white;">Delete</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function deleteFormatRow(button) {
            if (confirm('Are you sure you want to delete this format?')) {
                button.closest('tr').remove();
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL orders and parcels? This cannot be undone.')) {
                orders = [];
                parcels = [];
                localStorage.removeItem('orders');
                localStorage.removeItem('parcels');
                renderView();
                renderParcels();
                updateTotals();
                alert('All data has been cleared.');
            }
        }

        function saveFormats() {
            const rows = document.querySelectorAll('#formatsTable tbody tr');
            const newFormats = {};
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                const name = inputs[0].value.trim();
                const width = parseFloat(inputs[1].value) || 0;
                const height = parseFloat(inputs[2].value) || 0;
                const thickness = parseFloat(inputs[3].value) || 0;
                const weight = parseFloat(inputs[4].value) || 0;
                
                if (name && width > 0 && height > 0 && thickness > 0 && weight > 0) {
                    newFormats[name] = { width, height, thickness, weight };
                }
            });
            
            bookFormats = newFormats;
            localStorage.setItem('bookFormats', JSON.stringify(bookFormats));
            
            closeFormatsModal();
            renderView(); // Refresh dropdowns
            updateTotals(); // Recalculate weights
            renderParcels(); // Update parcel calculations
            alert('Format changes saved successfully!');
        }

        function openFormatsModal() {
            document.getElementById('formatsModal').classList.remove('hidden');
            renderFormatsTable();
        }

        function closeFormatsModal() {
            document.getElementById('formatsModal').classList.add('hidden');
        }

        function closeFormatsModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeFormatsModal();
            }
        }

        function renderFormatsTable() {
            const formatsTable = document.getElementById('formatsTable');
            
            formatsTable.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Format Name</th>
                            <th>Width (inches)</th>
                            <th>Height (inches)</th>
                            <th>Thickness (inches)</th>
                            <th>Weight (grams)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(bookFormats).map(([name, format]) => `
                            <tr>
                                <td><input type="text" value="${name}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" step="0.1" value="${format.width}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" step="0.1" value="${format.height}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" step="0.1" value="${format.thickness}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><input type="number" value="${format.weight}" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                                <td><button class="btn btn-small btn-secondary" onclick="deleteFormatRow(this)" style="background: #ef4444; border-color: #ef4444; color: white;">Delete</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function addNewFormat() {
            const tbody = document.querySelector('#formatsTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Format Name" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="0.1" placeholder="Width" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="0.1" placeholder="Height" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" step="0.1" placeholder="Thickness" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><input type="number" placeholder="Weight" style="width: 100%; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;"></td>
                <td><button class="btn btn-small btn-secondary" onclick="deleteFormatRow(this)" style="background: #ef4444; border-color: #ef4444; color: white;">Delete</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function deleteFormatRow(button) {
            if (confirm('Are you sure you want to delete this format?')) {
                button.closest('tr').remove();
            }
        }

        function toggleMultiSelect(type) {
            const multiSelect = document.getElementById(`${type}MultiSelect`);
            const isOpen = multiSelect.classList.contains('open');
            
            // Close all other multi-selects
            document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));
            
            // Toggle current one
            if (!isOpen) {
                multiSelect.classList.add('open');
            }
        }

        function updateStatusFilter() {
            selectedStatuses = [];
            document.querySelectorAll('#statusMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
                selectedStatuses.push(checkbox.value);
            });
            
            renderStatusTags();
            applyFilters();
        }

        function renderStatusTags() {
            const tagsContainer = document.getElementById('statusTags');
            
            if (selectedStatuses.length === 0) {
                tagsContainer.innerHTML = '<div class="multi-select-placeholder">All Statuses</div>';
            } else {
                tagsContainer.innerHTML = selectedStatuses.map(status => `
                    <div class="multi-select-tag">
                        ${status}
                        <span class="remove" onclick="removeStatusTag('${status}')">&times;</span>
                    </div>
                `).join('');
            }
        }

        function updateFormatFilter() {
            selectedFormats = [];
            document.querySelectorAll('#formatMultiSelect input[type="checkbox"]:checked').forEach(checkbox => {
                selectedFormats.push(checkbox.value);
            });
            
            renderFormatTags();
            applyFilters();
        }

        function renderFormatTags() {
            const tagsContainer = document.getElementById('formatTags');
            
            if (selectedFormats.length === 0) {
                tagsContainer.innerHTML = '<div class="multi-select-placeholder">All Formats</div>';
            } else {
                tagsContainer.innerHTML = selectedFormats.map(format => `
                    <div class="multi-select-tag">
                        ${format}
                        <span class="remove" onclick="removeFormatTag('${format}')">&times;</span>
                    </div>
                `).join('');
            }
        }

        function removeFormatTag(format) {
            selectedFormats = selectedFormats.filter(f => f !== format);
            document.querySelector(`#formatMultiSelect input[value="${format}"]`).checked = false;
            renderFormatTags();
            applyFilters();
        }

        function renderFormatDropdown() {
            const dropdown = document.getElementById('formatDropdown');
            dropdown.innerHTML = Object.keys(bookFormats).map(format => `
                <div class="multi-select-option">
                    <input type="checkbox" id="format-${format.toLowerCase()}" value="${format}" onchange="updateFormatFilter()">
                    <label for="format-${format.toLowerCase()}">${format}</label>
                </div>
            `).join('');
        }

        // Close multi-selects when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select').forEach(ms => ms.classList.remove('open'));
            }
        });

        function resetToDefaults() {
            if (confirm('Reset all formats to default values? This will overwrite any custom formats.')) {
                bookFormats = { ...defaultFormats };
                renderFormatsTable();
            }
        }

        function addParcel() {
            const name = document.getElementById('parcelName').value || `Parcel ${parcels.length + 1}`;
            const length = parseFloat(document.getElementById('parcelLength').value) || 12;
            const width = parseFloat(document.getElementById('parcelWidth').value) || 8;
            const height = parseFloat(document.getElementById('parcelHeight').value) || 6;
            const padding = parseFloat(document.getElementById('parcelPadding').value) || 0.5;
            const boxWeight = parseFloat(document.getElementById('parcelBoxWeight').value) || 100;

            const parcel = {
                id: Date.now().toString(),
                name,
                length,
                width,
                height,
                padding,
                boxWeight
            };

            parcels.push(parcel);
            localStorage.setItem('parcels', JSON.stringify(parcels));
            
            // Clear form
            document.getElementById('parcelName').value = '';
            document.getElementById('parcelLength').value = '12';
            document.getElementById('parcelWidth').value = '8';
            document.getElementById('parcelHeight').value = '6';
            document.getElementById('parcelPadding').value = '0.5';
            document.getElementById('parcelBoxWeight').value = '100';
            
            closeParcelModal();
            renderParcels();
            renderView(); // Update dropdowns
        }

        function editParcel(parcelId) {
            const parcel = parcels.find(p => p.id === parcelId);
            if (!parcel) return;
            
            currentEditingParcel = parcelId;
            
            // Populate form with current values
            document.getElementById('editParcelName').value = parcel.name;
            document.getElementById('editParcelLength').value = parcel.length;
            document.getElementById('editParcelWidth').value = parcel.width;
            document.getElementById('editParcelHeight').value = parcel.height;
            document.getElementById('editParcelPadding').value = parcel.padding;
            document.getElementById('editParcelBoxWeight').value = parcel.boxWeight;
            
            // Open modal
            document.getElementById('editParcelModal').classList.remove('hidden');
        }

        function closeEditParcelModal() {
            document.getElementById('editParcelModal').classList.add('hidden');
            currentEditingParcel = null;
        }

        function closeEditParcelModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeEditParcelModal();
            }
        }

        function deleteParcel(parcelId) {
            if (confirm('Are you sure you want to delete this parcel?')) {
                parcels = parcels.filter(p => p.id !== parcelId);
                localStorage.setItem('parcels', JSON.stringify(parcels));
                
                // Remove parcel assignment from ALL orders in localStorage, not just filtered ones
                let allOrders = [];
                try {
                    allOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                } catch (e) {
                    console.error('Error loading orders:', e);
                    allOrders = [];
                }
                
                // Update all orders
                allOrders.forEach(order => {
                    if (order.parcel === parcelId) {
                        order.parcel = '';
                    }
                });
                
                // Save back to localStorage
                localStorage.setItem('orders', JSON.stringify(allOrders));
                
                // Update the currently displayed orders array as well
                orders.forEach(order => {
                    if (order.parcel === parcelId) {
                        order.parcel = '';
                    }
                });
                
                renderParcels();
                renderView();
            }
        }

        function editParcel(parcelId) {
            const parcel = parcels.find(p => p.id === parcelId);
            if (!parcel) return;
            
            currentEditingParcel = parcelId;
            
            // Populate form with current values
            document.getElementById('editParcelName').value = parcel.name;
            document.getElementById('editParcelLength').value = parcel.length;
            document.getElementById('editParcelWidth').value = parcel.width;
            document.getElementById('editParcelHeight').value = parcel.height;
            document.getElementById('editParcelPadding').value = parcel.padding;
            document.getElementById('editParcelBoxWeight').value = parcel.boxWeight;
            
            // Open modal
            document.getElementById('editParcelModal').classList.remove('hidden');
        }

        function closeEditParcelModal() {
            document.getElementById('editParcelModal').classList.add('hidden');
            currentEditingParcel = null;
        }

        function closeEditParcelModalOnOutsideClick(event) {
            if (event.target.classList.contains('modal')) {
                closeEditParcelModal();
            }
        }

        function saveParcelEdit() {
            if (!currentEditingParcel) return;
            
            const parcelIndex = parcels.findIndex(p => p.id === currentEditingParcel);
            if (parcelIndex === -1) return;
            
            const oldName = parcels[parcelIndex].name;
            const newName = document.getElementById('editParcelName').value || `Parcel ${parcels.length}`;
            const length = parseFloat(document.getElementById('editParcelLength').value) || 12;
            const width = parseFloat(document.getElementById('editParcelWidth').value) || 8;
            const height = parseFloat(document.getElementById('editParcelHeight').value) || 6;
            const padding = parseFloat(document.getElementById('editParcelPadding').value) || 0.5;
            const boxWeight = parseFloat(document.getElementById('editParcelBoxWeight').value) || 100;
            
            // Update parcel
            parcels[parcelIndex] = {
                ...parcels[parcelIndex],
                name: newName,
                length,
                width,
                height,
                padding,
                boxWeight
            };
            
            localStorage.setItem('parcels', JSON.stringify(parcels));
            
            // If name changed, we don't need to update orders since they store parcel ID, not name
            // The parcel dropdowns will automatically show the new name
            
            closeEditParcelModal();
            renderParcels();
            renderView(); // Update dropdowns with new parcel name
            
            if (oldName !== newName) {
                alert(`Parcel renamed from "${oldName}" to "${newName}" and updated successfully!`);
            } else {
                alert('Parcel updated successfully!');
            }
        }

        function renderParcels() {
            const parcelGrid = document.getElementById('parcelGrid');
            
            parcelGrid.innerHTML = parcels.map(parcel => {
                const assignedOrders = orders.filter(order => order.parcel === parcel.id);
                
                let totalWeight = parcel.boxWeight;
                let totalVolume = 0;
                
                assignedOrders.forEach(order => {
                    const format = bookFormats[order.bookFormat] || bookFormats['B6'];
                    const volumes = order.volumes || 1;
                    const itemWeight = format.weight * volumes * order.quantity;
                    const itemVolume = format.width * format.height * (format.thickness * volumes) * order.quantity;
                    
                    totalWeight += itemWeight;
                    totalVolume += itemVolume;
                });

                const availableLength = parcel.length - (parcel.padding * 2);
                const availableWidth = parcel.width - (parcel.padding * 2);
                const availableHeight = parcel.height - (parcel.padding * 2);
                const maxVolume = availableLength * availableWidth * availableHeight;
                
                const spaceUsed = (totalVolume / maxVolume * 100).toFixed(1);
                const spaceRemaining = Math.max(0, maxVolume - totalVolume).toFixed(2);

                return `
                    <div class="parcel-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3>${parcel.name}</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-small btn-secondary" onclick="editParcel('${parcel.id}')">Edit</button>
                                <button class="btn btn-small btn-secondary" onclick="deleteParcel('${parcel.id}')" style="background: #ef4444; border-color: #ef4444; color: white;">Delete</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                            Dimensions: ${parcel.length}" × ${parcel.width}" × ${parcel.height}"<br>
                            Available: ${availableLength.toFixed(1)}" × ${availableWidth.toFixed(1)}" × ${availableHeight.toFixed(1)}"
                        </div>
                        <div class="parcel-stats">
                            <div class="stat">
                                <div class="stat-value">${assignedOrders.length}</div>
                                <div class="stat-label">Items</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${totalWeight.toFixed(0)}g</div>
                                <div class="stat-label">Weight</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${spaceUsed}%</div>
                                <div class="stat-label">Space Used</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${spaceRemaining}</div>
                                <div class="stat-label">Space Left (in³)</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; max-height: 120px; overflow-y: auto;">
                            ${assignedOrders.map(order => `
                                <div style="font-size: 11px; padding: 4px; background: rgba(255,255,255,0.7); margin: 2px 0; border-radius: 4px;">
                                    #${order.orderId} - ${order.title.substring(0, 30)}${order.title.length > 30 ? '...' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function saveData() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        function exportData() {
            const data = {
                orders: orders,
                parcels: parcels,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order_tracker_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.orders && Array.isArray(data.orders)) {
                        orders = data.orders;
                        saveData();
                    }
                    if (data.parcels && Array.isArray(data.parcels)) {
                        parcels = data.parcels;
                        localStorage.setItem('parcels', JSON.stringify(parcels));
                    }
                    renderView();
                    renderParcels();
                    updateTotals();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.classList.contains('editable') && e.key === 'Enter') {
                e.target.blur();
            }
        });
    </script>
</body>
</html>